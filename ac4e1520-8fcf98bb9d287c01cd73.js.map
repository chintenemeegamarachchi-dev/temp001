{"version":3,"sources":["webpack:///../src/context/browserFocus.tsx","webpack:///../src/components/MenuHelpers/MenuButton.tsx","webpack:///../src/context/editorMode.tsx","webpack:///../src/components/EditorModeMenu/index.tsx","webpack:///../src/context/editorState.tsx","webpack:///../src/components/MenuHelpers/commandControl.tsx","webpack:///../src/components/MenuHelpers/markControl.tsx","webpack:///../src/context/MenuPortal.tsx","webpack:///../src/components/MenuHelpers/MenuDropdown.tsx","webpack:///../src/components/MenuHelpers/MenuOption.tsx","webpack:///../src/utils.ts","webpack:///../src/plugins/Block/commands/index.ts","webpack:///../src/plugins/Block/Menu/blockTool.tsx","webpack:///../src/plugins/Block/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Block/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/CodeBlock/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/CodeBlock/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/CodeBlock/nodeView.ts","webpack:///../src/plugins/CodeBlock/commands/index.ts","webpack:///../src/plugins/CodeBlock/plugin.ts","webpack:///../src/plugins/History/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/History/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/Inline/plugin.ts","webpack:///../src/plugins/Inline/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Inline/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/List/commands/index.ts","webpack:///../src/plugins/List/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/List/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/Blockquote/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Blockquote/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/Table/utils.ts","webpack:///../src/plugins/Table/plugin.ts","webpack:///../src/plugins/Table/commands/index.ts","webpack:///../src/plugins/Table/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Table/Menu/MarkdownMenu.tsx","webpack:///../../../node_modules/babel-plugin-transform-async-to-promises/helpers.js","webpack:///../src/plugins/Image/nodeView.ts","webpack:///../src/plugins/Image/plugin.ts","webpack:///../src/plugins/Image/commands/index.ts","webpack:///../src/plugins/Image/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Image/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/Image/Popups/Edit.tsx","webpack:///../src/plugins/Image/Popups/Loader.tsx","webpack:///../src/plugins/Link/util.ts","webpack:///../src/plugins/Link/plugin.ts","webpack:///../src/plugins/Link/commands/index.ts","webpack:///../src/plugins/Link/Menu/ProsemirrorMenu.tsx","webpack:///../src/plugins/Link/Menu/MarkdownMenu.tsx","webpack:///../src/plugins/Link/Popups/InnerForm.tsx","webpack:///../src/plugins/Link/Popups/Form.tsx","webpack:///../src/components/MenuHelpers/styledComponents.tsx","webpack:///../src/components/BaseMenubar/index.tsx","webpack:///../src/components/MarkdownEditor/Menubar/index.tsx","webpack:///../src/components/MarkdownEditor/index.tsx","webpack:///../src/schema/nodes/utils.ts","webpack:///../src/schema/nodes/heading.ts","webpack:///../src/schema/nodes/image.ts","webpack:///../src/schema/nodes/list-item.ts","webpack:///../src/schema/nodes/paragraph.ts","webpack:///../src/schema/nodes/tables.ts","webpack:///../src/schema/index.ts","webpack:///../src/schema/marks/code.ts","webpack:///../src/schema/marks/em.ts","webpack:///../src/schema/marks/link.ts","webpack:///../src/schema/marks/strike.ts","webpack:///../src/schema/marks/strong.ts","webpack:///../src/schema/nodes/doc.ts","webpack:///../src/schema/nodes/blockquote.ts","webpack:///../src/schema/nodes/list-bullet.ts","webpack:///../src/schema/nodes/code-block.ts","webpack:///../src/schema/nodes/hard-break.ts","webpack:///../src/schema/nodes/hr.ts","webpack:///../src/schema/nodes/list-ordered.ts","webpack:///../src/schema/nodes/text.ts","webpack:///../src/translator/TranslatorClass.ts","webpack:///../src/translator/MarkdownTranslator/to_markdown.ts","webpack:///../src/translator/MarkdownTranslator/commonmark/tokens.ts","webpack:///../src/translator/MarkdownTranslator/commonmark/CommonMarkSerializer.ts","webpack:///../src/translator/MarkdownTranslator/markdown-it-plugins/markdown-it-imsize/helpers/parse_image_size.ts","webpack:///../src/translator/MarkdownTranslator/markdown-it-plugins/helpers/parseLinkDestination.ts","webpack:///../src/translator/MarkdownTranslator/markdown-it-plugins/markdown-it-imsize/index.ts","webpack:///../src/translator/MarkdownTranslator/markdown-it-plugins/markdown-it-links/index.ts","webpack:///../src/translator/MarkdownTranslator/from_markdown.ts","webpack:///../src/translator/MarkdownTranslator/commonmark/CommonMarkParser.ts","webpack:///../src/translator/MarkdownTranslator/index.ts","webpack:///../src/translator/DOMTranslator/to_dom.ts","webpack:///../src/translator/DOMTranslator/index.ts","webpack:///../src/plugins/Common/plugin.ts","webpack:///../src/plugins/Blockquote/commands/index.ts","webpack:///../src/plugins/Common/commands/index.ts","webpack:///../src/plugins/Common/keymap.ts","webpack:///../src/plugins/Common/buildKeymap.ts","webpack:///../src/components/ProsemirrorEditor/utils/plugin.ts","webpack:///../src/plugins/Common/input-rules/inputRules.ts","webpack:///../src/plugins/Inline/commands/index.ts","webpack:///../src/plugins/Common/input-rules/index.ts","webpack:///../src/components/ProsemirrorEditor/utils/buildEditorState.ts","webpack:///../src/components/ProsemirrorEditor/utils/buildEditor.ts","webpack:///../src/components/ProsemirrorEditor/utils/buildTranslator.ts","webpack:///../src/plugins/Table/Popup/ColumnPopup.tsx","webpack:///../src/plugins/Table/Popup/AddColumn.tsx","webpack:///../src/plugins/Table/Popup/AddRow.tsx","webpack:///../src/plugins/Table/Popup/AddPopup.tsx","webpack:///../src/plugins/Table/Popup/OptionsPopup.tsx","webpack:///../src/plugins/Table/Popup/index.tsx","webpack:///../src/components/ProsemirrorEditor/Menubar/index.tsx","webpack:///../src/components/ProsemirrorEditor/styles/CodeMirror.tsx","webpack:///../src/components/ProsemirrorEditor/styles/ProseMirror.tsx","webpack:///../src/components/ProsemirrorEditor/index.tsx","webpack:///../src/components/ProsemirrorEditor/utils/updateEditorState.ts","webpack:///../src/components/Wysiwyg/index.tsx","webpack:///../src/tinacms-plugins/wysiwygStyles.tsx","webpack:///../src/tinacms-plugins/HtmlFieldPlugin.tsx","webpack:///../src/tinacms-plugins/MarkdownFieldPlugin.tsx","webpack:///../src/tinacms-inline/inline-wysiwyg.tsx"],"names":["BrowserFocusContext","createContext","browserFocused","BrowserFocusProvider","children","useState","setBrowserFocused","useEffect","setWindowFocused","setWindowBlurred","window","value","useBrowserFocusContext","useContext","MenuItem","css","MenuButton","styled","p","props","EditorModeContext","mode","setMode","EditorModeProvider","document","event","EditorModeConsumer","useEditorModeContext","EditorModeMenu","title","onClick","React","EditorStateContext","editorView","translator","undefined","EditorStateProvider","useEditorStateContext","commandControl","focusOnCreate","canDo","command","tooltip","view","disabled","onMouseDown","evt","markControl","mark","Icon","defaultAttrs","selectionOnly","noMix","isDisabled","onMenuOptionClick","markType","markName","schema","markIsActive","state","selection","from","$from","to","empty","isOptionDisabled","isInCodeBlock","isIncompatibleMarksAreActive","node","nextMarkActive","dispatch","toggleMark","active","MenuPortalContext","MenuPortalProvider","wrapperRef","MenuPortal","createPortal","ref","MenuDropdown","triggerRef","styleProps","menuPortalRef","menuOffset","setMenuOffset","menuDropdownBoundingBox","menuPortalBoundingBox","offset","Offset","MenuOption","findElementOffsetTop","target","offsetTop","parent","findElementOffsetLeft","offsetLeft","isMarkPresent","getMarkPresent","anchor","head","start","end","markPresent","formatKeymap","keymapStr","mod","os","global","nAgt","navigator","clientStrings","s","r","keys","Object","i","clientObj","getOS","formattedKeymap","deleteEmptyHeading","$cursor","Math","tr","toggleHeader","nodeType","attrs","fallBackNodeType","fallbackAttrs","firstTextblock","firstPos","$firstPos","index","setAsParagraph","nextNodeType","nextAttrs","blockTool","options","Component","typeName","render","this","correctNodeType","correctAttrs","Content","TitleText","ProsemirrorMenu","setActive","menuButtonRef","useRef","toggle","open","click","escape","onDismiss","makeToggleHeader","level","th","tn","BaseHeading","HeadingOne","HeadingTwo","HeadingThree","HeadingFour","HeadingFive","HeadingSix","H1","H2","H3","H4","H5","H6","MarkdownMenu","makeCodeBlock","nodes","code_block","paragraph","currentNode","setBlockType","content","startPos","endPos","pos","codeBlock","ssr","mac","CodeMirror","require","CodeBlockView","getPos","updating","onCursorActivity","forwardSelection","onChange","cm","setupCodeMirror","dom","setTimeout","on","setSelection","valueChanged","change","computeChange","codeBlockStart","replaceWith","asProseMirrorSelection","indexFromPos","getCursor","TextSelection","focus","posFromIndex","lineNumbers","extraKeys","theme","codeMirrorKeymap","Up","Left","Down","Right","Backspace","deleteEmptyCodeblock","code","shouldRemove","undo","redo","Selection","$head","$anchor","above","after","type","exitCodeUp","exitCode","exitCodeHard","maybeEscape","somethingSelected","dir","unit","getLine","targetPos","doc","resolve","update","replaceRange","selectNode","stopEvent","oldVal","oldEnd","newEnd","newVal","text","codeBlockPluginKey","codeBlockPlugin","key","nodeViews","UndoControl","undoDepth","RedoControl","redoDepth","inlinePluginKey","inlinePlugin","handleKeyDown","marks","exitCodeMarkOnArrowRight","BoldControl","ItalicControl","StrikeControl","toggleBulletList","lift","liftListItem","wrapInList","wrap","toggleOrderedList","BulletList","OrderedList","wrapInBlockquote","blockquote","findParentNodeOfType","nodeRange","wrapIn","buildColumnSelection","width","tableMap","colStart","c","table","buildRowSelection","height","rowStart","buildTableSelection","buildExtendedColumnHeaders","decorations","cellMap","div","colSelection","tableNode","Decoration","buildExtendedRowHeaders","rowSelection","buildExtendedTableHeaders","tablePluginKey","tablePlugin","init","deco","DecorationSet","apply","prev","newState","selectionNotChanged","oldState","tableNotChanged","TableMap","buildExtendedHeaders","selectedTable","handleClickOn","targetClasses","tablePluginState","cellSelection","classes","buildCellSelection","createCell","cellType","insertTableCmd","tableCell","table_cell","tableHeader","table_header","tableRow","table_row","cells","headerCells","rows","newTable","$to","insertTable","Symbol","Identity","str","ImageView","previewSrc","deselectNode","destroy","classList","add","img","src","align","alt","updateImgSrc","style","appendChild","body","result","e","recover","imagePluginKey","setSelectionAtPos","insertImageFiles","files","data","file","uploadImages","uploadPromise","urls","imageSrc","image","insertImageList","displayUrlInput","setDisplayUrlInput","imageUrl","setImageUrl","showImageModal","setShowImageModal","uploading","setUploading","uploadImageFile","stopDefault","handleCloseModal","onKeyDown","htmlFor","id","accept","onDragEnter","onDragOver","onDrop","dataTransfer","items","dataIsItems","small","primary","insertImage","ClearImageButton","UrlInputWrapper","UrlInputTrigger","UrlInput","UploadIconWrapper","CurrentImage","ImageInputLabel","ImageModalContent","ImageModalActions","UploadText","UploadSection","FileUploadInput","StyledLabel","ImageEdit","imagePluginState","selectedImage","link","linkMark","setTitle","setAlt","linkTitle","setLinkTitle","linkSrc","setLinkSrc","top","left","modalTop","setModalTop","modalLeft","setModalLeft","inputRef","imageRef","linked","toggleLinked","positionImage","scroll","wysiwygWrapper","wrapperDimensions","debouncedPositionImage","debounce","updateNodeAttrs","href","closeImageSettings","placeholder","role","checked","LinkPopup","LinkLabel","LinkInput","LinkActions","SaveLink","CancelLink","ToggleElement","ToggleLabel","ToggleSwitch","ToggleInput","Loader","markerImageLoader","loaders","ReactDOM","ImagePlaceholder","color","IMG_REGEX","HTTP_LINK_REGEX","linkPluginKey","linkPlugin","showLinkForm","show_link_toolbar","transformPasted","slice","linkify","linkified","fragment","child","matches","match","urlText","Fragment","shiftKey","markExtend","startIndex","endIndex","hasMark","size","openLinkPopup","selectedNode","InnerForm","setHref","save","onEnterSave","onEscapeCancel","componentDidMount","current","componentWillUnmount","componentDidUpdate","prevProps","setState","closeModal","cancel","removeLink","originalHref","onKeyPress","LinkPopupKeyframes","keyframes","DeleteLink","LinkForm","position","setPosition","linkPluginState","selState","clickTarget","createRef","ow_ct","ol_ct","ow_rt","renderTarget","ol_rt","ol","minWidth","calcLeftOffset","arrowOffset","calcArrowLeftOffset","removeLinkBeingEdited","updateLinkBeingEdited","unmountLinkForm","LinkFormWrapper","LinkArrow","MenuPlaceholder","MenuWrapper","MenuContainer","BaseMenubar","sticky","menus","plugins","popups","menuFixed","setMenuFixed","isBrowser","menuRef","menuBoundingBox","setMenuBoundingBox","menuFixedTopOffset","useLayoutEffect","handleScroll","startPosition","endPosition","handleResize","wasMenuFixed","preventProsemirrorFocusLoss","Menubar","rest","MarkdownEditor","imageProps","val","setVal","inputElm","preventScroll","editorElementFocused","upload","v","onFocus","EditingSection","domAttrs","docAttrs","getAttrsWith","getAttrs","attributes","attribute","heading","default","class","group","defining","parseDOM","tag","toDocument","other","toDOM","inline","draggable","allowGapCursor","getAlignFromDOM","alignRegex","className","tables","tableNodes","tableGroup","cellContent","cellAttributes","excludes","em","inclusive","strike","strong","bullet_list","tight","params","preserveWhitespace","hard_break","selectable","horizontal_rule","list_item","ordered_list","order","TranslatorClass","MarkdownSerializer","serialize","MarkdownSerializerState","delim","out","closed","inTightList","tightLists","flushClose","delimMin","trim","exec","wrapBlock","old","write","firstDelim","f","closeBlock","atBlank","ensureNewLine","lines","startOfLine","escapedString","esc","escFn","renderContent","renderInline","trailing","progress","indexOfCode","leading","info","test","Array","lead","inner","trail","noEsc","len","outer","j","keep","renderList","isTight","prevTight","quote","repeat","markString","getEnclosingWhitespace","get","ALIGN_STYLES","ALIGN_DASHES","center","right","TOKENS","block","tok","fence","hr","hardbreak","code_inline","NODES","maxW","String","space","nStr","inHead","row","nextRowIsInBody","dash","MARKS","close","mixable","expelEnclosingWhitespace","closeWith","CommonMarkSerializer","buildNodesFromSchema","parseNextNumber","ok","Number","parseLinkDestination","md","isSpace","unescapeAll","max","image_with_size","oldPos","labelStart","labelEnd","res","resultW","resultH","parseImageSize","label","tokens","token","imsize","normalizeReference","parseReference","_link","MarkMapping","MarkdownParseState","stack","Mark","tokenHandlers","length","push","elt","addText","last","merged","a","b","maybeMerge","openMark","closeMark","parseTokens","toks","handler","addNode","openNode","closeNode","spec","noOpenClose","withoutTrailingNewline","noOp","MarkdownParser","tokenizer","handlers","JSON","parse","markdownit","CommonMarkParser","parser","html","ignore","buildTokensForSchema","MarkdownTranslator","serializer","nodeFromString","stringFromNode","DOMSerializer","gatherToDOM","obj","DOMTranslator","PDOMParser","al","DOMParser","parseFromString","el","serializeFragment","commonPluginKey","commonPlugin","editorFocused","handleScrollToSelection","handleDOMEvents","blur","liftBlockquote","range","getRangeForType","liftTarget","insertHr","hardBreakCmd","br","chainCommands","headingCmd","KEYMAP_PLUGINS","__type","name","unlessMac","ifMark","ifNode","ifMac","onCondition","arrowHandler","ifNodes","splitListItem","sinkListItem","side","nextPos","tab","goToCell","shiftTab","TableCommands","buildKeymap","bind","cmd","findPlugins","plugin","skip","n","double","boundary","single","STRONG","EM","S","EM_UNDERSCORE","CODE","buildInputRules","rules","wrappingInputRule","orderedListRule","bulletListRule","textblockTypeInputRule","language","codeBlockRule","maxLevel","RegExp","headingRule","horizontalRuleRule","markInputRule","strongUnderRule","strikethroughRule","singleMarkInputRule","emStarRule","emUnderRule","codeRule","regexp","textStart","textEnd","deleteStart","deleteEnd","getNextChar","singleMarkCommand","inputRules","pmInputRules","buildEditorState","keymap","history","dropCursor","gapCursor","tableEditing","loadingImagesCount","childElement","handleDrop","moved","handlePaste","clipboardData","buildEditor","format","buildTranslator","input","dispatchTransaction","nextState","setEditorView","alignColumn","cellNode","entry","columnPos","parseInt","cell","markerDivCol","markerDivRows","markerDivRow","deleteColumn","deleteRow","IconWrapperCol","IconWrapperRow","marker","tableHeight","hovered","setHovered","onMouseEnter","onMouseLeave","addColumn","addColumnAt","Wrapper","Pointer","ColumnDivider","tableWidth","addRowAt","cellInNextRow","getCellsInRow","addRow","markerDivTable","tableElm","markerCols","markerRows","deleteTable","TablePopups","CodeMirrorCss","ProseMirrorCss","ProsemirrorEditor","editorRef","setTranslator","translatorObj","editorWrapper","updateEditorState","rel","WysiwygWrapper","modeTogglePlugin","Wysiwyg","pluginList","wysiwygStyles","component","wrapFieldsWithMeta","HtmlFieldPlugin","MarkdownFieldPlugin","InlineWysiwyg","focusRing","passedInImageProps","wysiwygProps","cms","useCMS","filesToUpload","directory","allMedia","media"],"mappings":"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","file":"ac4e1520-8fcf98bb9d287c01cd73.js","sourcesContent":["/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useEffect, useState, ReactElement } from 'react'\nimport { createContext, useContext } from 'react'\n\nconst BrowserFocusContext = createContext<{\n  browserFocused: boolean\n}>({\n  browserFocused: true,\n})\n\nexport const BrowserFocusProvider = ({\n  children,\n}: {\n  children: ReactElement\n}) => {\n  const [browserFocused, setBrowserFocused] = useState(true)\n\n  useEffect(() => {\n    const setWindowFocused = () => setBrowserFocused(true)\n    const setWindowBlurred = () => setBrowserFocused(false)\n    window.addEventListener('focus', setWindowFocused)\n    window.addEventListener('blur', setWindowBlurred)\n    return () => {\n      window.removeEventListener('focus', setWindowFocused)\n      window.removeEventListener('blur', setWindowBlurred)\n    }\n  }, [])\n\n  return (\n    <BrowserFocusContext.Provider value={{ browserFocused }}>\n      {children}\n    </BrowserFocusContext.Provider>\n  )\n}\n\nexport const BrowserFocusConsumer = BrowserFocusContext.Consumer\n\nexport const useBrowserFocusContext = () => ({\n  ...useContext(BrowserFocusContext),\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport styled, { css } from 'styled-components'\n\nconst MenuItem = css`\n  flex: 1 1 32px;\n`\n\nexport const MenuButton = styled.button<{\n  title?: string\n  active?: boolean\n  disabled?: boolean\n  ref?: any\n}>`\n  ${MenuItem}\n  background-color: ${p =>\n    p.active ? 'rgba(53, 50, 50, 0.05)' : 'transparent'};\n  color: ${p =>\n    p.active ? 'var(--tina-color-primary)' : 'var(--tina-color-grey-8)'};\n  fill: ${p =>\n    p.active ? 'var(--tina-color-primary)' : 'var(--tina-color-grey-8)'};\n  border: 1px solid var(--tina-color-grey-2);\n  margin: -1px;\n  outline: none;\n  padding: 6px 4px;\n  transition: all 85ms ease-out;\n  cursor: pointer;\n  display: flex;\n  justify-content: center;\n  align-items: center;\n  font-size: 12px;\n  font-weight: 600;\n  &:hover {\n    background-color: rgba(53, 50, 50, 0.09);\n  }\n  &:active {\n    color: var(--tina-color-primary);\n    fill: var(--tina-color-primary);\n    background-color: rgba(53, 50, 50, 0.05);\n  }\n  svg {\n    width: 20px;\n    height: 20px;\n  }\n  ${props =>\n    props.active &&\n    css`\n      color: var(--tina-color-primary);\n      fill: var(--tina-color-primary);\n      background-color: rgba(53, 50, 50, 0.05);\n    `};\n  ${props =>\n    props.disabled &&\n    css`\n      pointer-events: none;\n      color: #d1d1d1;\n      fill: #d1d1d1;\n    `};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useEffect, useState } from 'react'\nimport { createContext, useContext } from 'react'\n\nconst EditorModeContext = createContext<{\n  mode: string\n  setMode: (mode: string) => void\n}>({\n  mode: 'wysiwyg',\n  setMode: () => {},\n})\n\nexport const EditorModeProvider = ({ children }: any) => {\n  const [mode, setMode] = useState('wysiwyg')\n\n  useEffect(() => {\n    document.addEventListener('keydown', event => {\n      if (\n        event.altKey &&\n        event.shiftKey &&\n        event.metaKey &&\n        event.keyCode === 77\n      )\n        setMode(mode === 'wysiwyg' ? 'markdown' : 'wysiwyg')\n    })\n  })\n\n  return (\n    <EditorModeContext.Provider value={{ mode, setMode }}>\n      {children}\n    </EditorModeContext.Provider>\n  )\n}\n\nexport const EditorModeConsumer = EditorModeContext.Consumer\n\nexport const useEditorModeContext = () => useContext(EditorModeContext)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\n\nimport { MarkdownIcon } from '@tinacms/icons'\nimport { MenuButton } from '../MenuHelpers/MenuButton'\nimport { useEditorModeContext } from '../../context/editorMode'\n\nexport const EditorModeMenu = () => {\n  const { mode, setMode } = useEditorModeContext()\n\n  const toggleMode = () => {\n    if (mode === 'markdown') setMode('wysiwyg')\n    else setMode('markdown')\n  }\n\n  return (\n    <MenuButton\n      data-testid=\"markdown-toggle\"\n      data-tooltip=\"Markdown mode\"\n      title=\"Toggle Markdown mode\"\n      onClick={toggleMode}\n    >\n      <MarkdownIcon />\n    </MenuButton>\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { createContext, useContext, ReactElement } from 'react'\nimport { EditorView } from 'prosemirror-view'\n\ninterface EditorStateIntf {\n  editorView: { view: EditorView } | undefined\n  translator: any\n}\n\nconst EditorStateContext = createContext<EditorStateIntf>({\n  editorView: undefined,\n  translator: undefined,\n})\n\nexport const EditorStateProvider = ({\n  children,\n  editorView,\n  translator,\n}: EditorStateIntf & { children?: ReactElement }) => {\n  return (\n    <EditorStateContext.Provider value={{ editorView, translator }}>\n      {children}\n    </EditorStateContext.Provider>\n  )\n}\n\nexport const EditorStateConsumer = EditorStateContext.Consumer\n\nexport const useEditorStateContext = () => ({\n  ...useContext(EditorStateContext),\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\n\nimport { useEditorStateContext } from '../../context/editorState'\nimport { MenuButton } from './MenuButton'\n\nexport const commandControl = (\n  command: any,\n  Icon: any, // Fix type\n  _title: string,\n  tooltip: string,\n  focusOnCreate: boolean = true\n) => () => {\n  const { editorView } = useEditorStateContext()\n  const onClick = () => {\n    if (canDo()) {\n      const view = editorView!.view\n      command(view.state, view.dispatch)\n\n      if (focusOnCreate) {\n        view.focus()\n      }\n    }\n  }\n  const canDo = () => command(editorView!.view.state)\n\n  return (\n    <MenuButton\n      data-tooltip={tooltip}\n      title={tooltip}\n      onClick={onClick}\n      disabled={!canDo()}\n      onMouseDown={evt => {\n        evt.preventDefault()\n        evt.stopPropagation()\n      }}\n    >\n      <Icon />\n    </MenuButton>\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { EditorView } from 'prosemirror-view'\nimport { toggleMark } from 'prosemirror-commands'\n\nimport { useEditorStateContext } from '../../context/editorState'\nimport { MenuButton } from './MenuButton'\n\nexport interface Options {\n  mark: string\n  Icon: any // Fix type\n  title?: string\n  defaultAttrs?: any\n  selectionOnly?: boolean\n  tooltip?: string\n  noMix?: string[]\n  isDisabled?: (view: EditorView) => boolean\n  onClick?: (view: EditorView) => void\n  onMenuOptionClick?: (view: EditorView) => void\n}\n\nexport function markControl({\n  mark,\n  Icon,\n  tooltip,\n  defaultAttrs,\n  selectionOnly = false,\n  noMix = [],\n  isDisabled,\n  onClick,\n  onMenuOptionClick,\n}: Options) {\n  return () => {\n    const { editorView } = useEditorStateContext()\n    const view = editorView!.view\n\n    const markType = (markName: string) => {\n      const schema = view.state.schema\n      return schema.marks[markName]\n    }\n\n    const isActive = () => markIsActive(mark)\n\n    const markIsActive = (markName: string): boolean => {\n      const { state } = view\n      const mark = markType(markName)\n      const { from, $from, to, empty } = state.selection\n      if (empty) return !!mark.isInSet(state.storedMarks || $from.marks())\n      else return state.doc.rangeHasMark(from, to, mark)\n    }\n\n    const isOptionDisabled = () => {\n      if (isDisabled) return isDisabled(view)\n      if (mark === 'image')\n        if (selectionOnly) {\n          const { $cursor } = view.state.selection as any\n          return !!$cursor || isInCodeBlock() || isIncompatibleMarksAreActive()\n        }\n\n      return isInCodeBlock() || isIncompatibleMarksAreActive()\n    }\n\n    const isInCodeBlock = () => {\n      const node = view.state.selection.$from.node(\n        view.state.selection.$from.depth\n      )\n      return node.type === view.state.schema.nodes.code_block\n    }\n\n    const isIncompatibleMarksAreActive = () => {\n      return noMix\n        .map(markIsActive)\n        .reduce(\n          (someMarkActive, nextMarkActive) => nextMarkActive || someMarkActive,\n          false\n        )\n    }\n\n    const onOptionClick = () => {\n      if (onClick) {\n        onClick(view)\n      }\n      if (onMenuOptionClick) {\n        return onMenuOptionClick(view)\n      }\n      if (isOptionDisabled()) return\n      const { state, dispatch } = view\n\n      if ((state.selection as any).$cursor && selectionOnly) {\n        return\n      }\n\n      toggleMark(markType(mark), defaultAttrs)(state, dispatch)\n    }\n\n    if (!markType(mark)) {\n      return null\n    }\n    return (\n      <MenuButton\n        data-tooltip={tooltip}\n        data-side=\"top\"\n        title={tooltip}\n        onClick={onOptionClick}\n        active={!isOptionDisabled() && isActive()}\n        disabled={isOptionDisabled()}\n      >\n        <Icon />\n      </MenuButton>\n    )\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useContext } from 'react'\nimport { createPortal } from 'react-dom'\n\nexport type MenuPortal = React.FC<{}>\n\nconst MenuPortalContext = React.createContext<MenuPortal>(() => {\n  return null\n})\n\nexport function useMenuPortal() {\n  return useContext(MenuPortalContext)\n}\n\nexport const MenuPortalProvider: React.FC = ({ children }) => {\n  const wrapperRef = React.useRef<HTMLDivElement | null>(null)\n\n  const MenuPortal = React.useCallback(\n    (props: any) => {\n      if (!wrapperRef.current) return null\n      return createPortal(props.children, wrapperRef.current)\n    },\n    [wrapperRef.current]\n  )\n\n  return (\n    <MenuPortalContext.Provider value={MenuPortal}>\n      <div ref={wrapperRef}>{children}</div>\n    </MenuPortalContext.Provider>\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\n\nimport styled, { css } from 'styled-components'\nimport { useMenuPortal } from '../../context/MenuPortal'\n\nexport const MenuDropdown = styled(\n  ({ children, open, triggerRef, innerRef, ...styleProps }) => {\n    const MenuPortal = useMenuPortal()\n    const menuPortalRef = React.useRef<HTMLDivElement | null>(null)\n    const [menuOffset, setMenuOffset] = React.useState(0)\n\n    React.useEffect(() => {\n      if (triggerRef.current && menuPortalRef.current) {\n        const menuDropdownBoundingBox = triggerRef.current.getBoundingClientRect()\n        const menuPortalBoundingBox = menuPortalRef.current.getBoundingClientRect()\n        setMenuOffset(menuDropdownBoundingBox.x - menuPortalBoundingBox.x)\n      }\n    }, [triggerRef.current, menuPortalRef.current])\n\n    return (\n      <MenuPortal>\n        <div ref={menuPortalRef}>\n          <Offset offset={menuOffset}>\n            <div {...styleProps}>{children}</div>\n          </Offset>\n        </div>\n      </MenuPortal>\n    )\n  }\n)`\n  border-radius: var(--tina-radius-small);\n  border: 1px solid #efefef;\n  display: block;\n  position: absolute;\n  bottom: -4px;\n  left: 0;\n  transform: translate3d(0, 100%, 0) scale3d(0.5, 0.5, 1);\n  opacity: 0;\n  pointer-events: none;\n  transition: all 85ms ease-out;\n  transform-origin: 0 0;\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12), 0px 4px 8px rgba(48, 48, 48, 0.1);\n  background-color: white;\n  overflow: hidden;\n  z-index: 10;\n  white-space: nowrap;\n\n  ${props =>\n    props.open &&\n    css`\n      opacity: 1;\n      pointer-events: all;\n      transform: translate3d(0, 100%, 0) scale3d(1, 1, 1);\n    `};\n`\n\nconst Offset = styled.div<{ offset: number }>`\n  position: absolute;\n  left: ${props => props.offset}px;\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport styled, { css } from 'styled-components'\n\nexport const MenuOption = styled.div<{ disabled: boolean; active: boolean }>`\n  display: block;\n  padding: 8px 12px;\n  transition: all 85ms ease-out;\n  cursor: pointer;\n  &:first-child {\n    padding-top: var(--tina-padding-small);\n  }\n  &:last-child {\n    padding-bottom: var(--tina-padding-small);\n  }\n  &:hover {\n    background-color: var(--tina-color-grey-1);\n    color: var(--tina-color-primary);\n  }\n  &:active {\n    color: var(--tina-color-primary);\n    fill: var(--tina-color-primary);\n    background-color: rgba(53, 50, 50, 0.05);\n  }\n  ${props =>\n    props.active &&\n    css`\n      color: var(--tina-color-primary);\n      fill: var(--tina-color-primary);\n      background-color: rgba(53, 50, 50, 0.05);\n    `};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\nimport { EditorState } from 'prosemirror-state'\nimport { MarkType, Mark } from 'prosemirror-model'\n\nexport const findElementOffsetTop = (\n  element: HTMLElement,\n  parent?: HTMLElement\n) => {\n  let target = element\n  let offsetTop = target.offsetTop\n  while (target.offsetParent && (!parent || target.offsetParent !== parent)) {\n    target = target.offsetParent as HTMLElement\n    offsetTop += target.offsetTop\n  }\n  return offsetTop\n}\n\nexport const findElementOffsetLeft = (\n  element: HTMLElement,\n  parent?: HTMLElement\n) => {\n  let target = element\n  let offsetLeft = target.offsetLeft\n  while (target.offsetParent && (!parent || target.offsetParent !== parent)) {\n    target = target.offsetParent as HTMLElement\n    offsetLeft += target.offsetLeft\n  }\n  return offsetLeft\n}\n\n/**\n * Function will check if mark is present in selection.\n */\nexport const isMarkPresent = (state: EditorState, markType: MarkType) =>\n  !!getMarkPresent(state, markType)\n\n/**\n * Function will check if mark is present in selection.\n */\nexport const getMarkPresent = (state: EditorState, markType: MarkType) => {\n  const { selection } = state\n  const { anchor, head } = selection\n  let start\n  let end\n  if (anchor < head) {\n    start = anchor\n    end = head\n  } else {\n    start = head\n    end = anchor\n  }\n  start = selection.empty ? start : start + 1\n  const mark = markType.isInSet(state.doc.resolve(start).marks())\n\n  if (!mark) return false\n  let markPresent: Mark | undefined = mark\n\n  for (; start < end && markPresent; start += 1) {\n    if (!markType.isInSet(state.doc.resolve(start).marks()))\n      markPresent = undefined\n  }\n\n  return markPresent\n}\n\nconst getOS = () => {\n  // @ts-ignore\n  if (typeof global['navigator'] === 'undefined') return 'Windows'\n  const nAgt = navigator.userAgent\n  const clientStrings = [\n    { s: 'Windows', r: /Win16/ },\n    { s: 'Windows', r: /(Windows 95|Win95|Windows_95)/ },\n    { s: 'Windows', r: /(Win 9x 4.90|Windows ME)/ },\n    { s: 'Windows', r: /(Windows 98|Win98)/ },\n    { s: 'Windows', r: /Windows CE/ },\n    { s: 'Windows', r: /(Windows NT 5.0|Windows 2000)/ },\n    { s: 'Windows', r: /(Windows NT 5.1|Windows XP)/ },\n    { s: 'Windows', r: /Windows NT 5.2/ },\n    { s: 'Windows', r: /Windows NT 6.0/ },\n    { s: 'Windows', r: /(Windows 7|Windows NT 6.1)/ },\n    { s: 'Windows', r: /(Windows 8.1|Windows NT 6.3)/ },\n    { s: 'Windows', r: /(Windows 8|Windows NT 6.2)/ },\n    { s: 'Windows', r: /(Windows NT 4.0|WinNT4.0|WinNT|Windows NT)/ },\n    { s: 'Linux', r: /(Linux|X11)/ },\n    { s: 'iOS', r: /(iPhone|iPad|iPod)/ },\n    { s: 'Mac OS X', r: /Mac OS X/ },\n    { s: 'Mac OS', r: /(MacPPC|MacIntel|Mac_PowerPC|Macintosh)/ },\n    { s: 'QNX', r: /QNX/ },\n    { s: 'UNIX', r: /UNIX/ },\n    { s: 'BeOS', r: /BeOS/ },\n  ]\n\n  const keys: { [key: number]: any } = Object.keys(clientStrings)\n  for (let i = 0; i < clientStrings.length; i += 1) {\n    const clientObj = clientStrings[keys[i]]\n    if (clientObj.r.test(nAgt)) {\n      return clientObj.s\n    }\n  }\n\n  return ''\n}\n\nexport const formatKeymap = (keymapStr: string) => {\n  const os = getOS()\n  const mod = os === 'Windows' ? '^' : ''\n\n  let formattedKeymap = keymapStr\n  formattedKeymap = formattedKeymap.replace('Mod', mod)\n  formattedKeymap = formattedKeymap.replace('Shift', '')\n  formattedKeymap = formattedKeymap.replace('Alt', '')\n  return formattedKeymap\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState, TextSelection } from 'prosemirror-state'\nimport { NodeType, Node } from 'prosemirror-model'\nimport { EditorView } from 'prosemirror-view'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\nexport function deleteEmptyHeading(\n  state: EditorState,\n  dispatch: Dispatch | null\n) {\n  const { $cursor } = state.selection as any\n  if (!$cursor) return false\n  const node = state.doc.nodeAt(Math.max($cursor.pos - 1, 0))\n  if (!node) return false\n  if (node.type != state.schema.nodes.heading) return false\n  if (node.textContent.length) return false\n  if (dispatch) {\n    const { tr } = state\n    dispatch(\n      tr\n        // Replace the entire heading with an empty paragraph\n        .replaceRangeWith(\n          $cursor.pos - 1,\n          $cursor.pos + node.nodeSize - 1,\n          state.schema.nodes.paragraph.create()\n        )\n        // Set the selection to be at the start of the paragraph\n        .setSelection(new TextSelection(tr.doc.resolve(state.selection.head)))\n        .scrollIntoView()\n    )\n  }\n  return true\n}\n\nexport function toggleHeader(\n  nodeType: NodeType,\n  attrs: any,\n  fallBackNodeType: NodeType,\n  fallbackAttrs: any\n) {\n  return function(state: EditorState, dispatch: Dispatch | null) {\n    const { from, to } = state.selection\n    let firstTextblock: Node | null = null\n    let firstPos = -1\n    // Find the first textblock\n    state.doc.nodesBetween(from, to, (node, pos) => {\n      if (firstTextblock) return false\n      if (node.isTextblock) {\n        firstTextblock = node\n        firstPos = pos\n      }\n      return true\n    })\n\n    if (!firstTextblock || firstPos < 0) return false\n\n    const $firstPos = state.doc.resolve(firstPos)\n    const index = $firstPos.index()\n\n    const setAsParagraph =\n      state.selection.$head.parent.attrs.level == attrs.level\n    const nextNodeType = setAsParagraph ? fallBackNodeType : nodeType\n    const nextAttrs = setAsParagraph ? fallbackAttrs : attrs\n\n    if (!$firstPos.parent.canReplaceWith(index, index + 1, nextNodeType))\n      return false\n\n    if (dispatch) {\n      dispatch(\n        (state.tr.setBlockType(\n          from,\n          to,\n          nextNodeType,\n          nextAttrs\n        ) as any).scrollIntoView()\n      )\n    }\n\n    return true\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { EditorView } from 'prosemirror-view'\n\nimport { MenuOption } from '../../../components/MenuHelpers'\nimport styled from 'styled-components'\n\ninterface BlockTool {\n  Component: any\n  children: any\n  command: Function\n  typeName?: string\n  attrs?: any\n  title?: string\n}\n\nexport function blockTool(options: BlockTool) {\n  const { Component, children, command, typeName, attrs, title } = options\n  return class extends React.Component<\n    { view: EditorView; onClick(): void },\n    any\n  > {\n    canDo = () => command(this.props.view.state)\n    onClick = () => {\n      command(this.props.view.state, this.props.view.dispatch)\n      this.props.view.focus()\n      this.props.onClick()\n    }\n    get active(): boolean {\n      if (!typeName) return false\n\n      const { state } = this.props.view\n      const $from = state.selection.$from\n      const node = $from.node($from.depth)\n      const correctNodeType = node.type.name === typeName\n      // Only works for Heading\n      const correctAttrs = attrs ? node.attrs.level === attrs.level : true\n      return correctNodeType && correctAttrs\n    }\n    render() {\n      return (\n        <MenuOption\n          onClick={this.onClick}\n          disabled={!this.canDo()}\n          active={this.active}\n        >\n          <Content>\n            <Component>{children}</Component>\n            <TitleText>{title}</TitleText>\n          </Content>\n        </MenuOption>\n      )\n    }\n  }\n}\n\nconst Content = styled.div`\n  display: flex;\n  justify-content: space-between;\n  align-items: center;\n`\n\nconst TitleText = styled.span`\n  color: #d1d1d1;\n  font-size: 12px;\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { FunctionComponent, useRef, useState } from 'react'\nimport styled, { css } from 'styled-components'\nimport { EditorView } from 'prosemirror-view'\nimport { EditorState } from 'prosemirror-state'\nimport { Dismissible } from 'react-dismissible'\n\nimport { HeadingIcon } from '@tinacms/icons'\n\nimport { useEditorStateContext } from '../../../context/editorState'\nimport { MenuButton, MenuDropdown } from '../../../components/MenuHelpers'\nimport { formatKeymap } from '../../../utils'\nimport { toggleHeader as th } from '../commands'\nimport { blockTool } from './blockTool'\n\nexport const ProsemirrorMenu: FunctionComponent = () => {\n  const [active, setActive] = useState(false)\n  const menuButtonRef = useRef()\n  const { editorView } = useEditorStateContext()\n  const view = editorView!.view\n\n  const toggle = () => setActive(!active)\n\n  return (\n    <>\n      <MenuButton\n        ref={menuButtonRef}\n        data-tooltip=\"Heading\"\n        title=\"Heading\"\n        onClick={toggle}\n        active={active}\n      >\n        <HeadingIcon />\n      </MenuButton>\n      <MenuDropdown triggerRef={menuButtonRef} open={active}>\n        <Dismissible click escape disabled={!active} onDismiss={toggle}>\n          <H1 view={view} onClick={toggle} />\n          <H2 view={view} onClick={toggle} />\n          <H3 view={view} onClick={toggle} />\n          <H4 view={view} onClick={toggle} />\n          <H5 view={view} onClick={toggle} />\n          <H6 view={view} onClick={toggle} />\n        </Dismissible>\n      </MenuDropdown>\n    </>\n  )\n}\n\nfunction makeToggleHeader(level: number) {\n  return function toggleHeader(\n    state: EditorState,\n    dispatch: typeof EditorView.prototype.dispatch\n  ) {\n    const tn = th(\n      state.schema.nodes.heading,\n      { level },\n      state.schema.nodes.paragraph,\n      null\n    )\n\n    return tn(state, dispatch)\n  }\n}\n\nconst BaseHeading = css`\n  white-space: nowrap;\n  line-height: 1;\n  display: block;\n  margin: 0;\n`\n\nconst HeadingOne = styled.h1`\n  ${BaseHeading}\n`\nconst HeadingTwo = styled.h2`\n  ${BaseHeading}\n`\nconst HeadingThree = styled.h3`\n  ${BaseHeading}\n`\nconst HeadingFour = styled.h4`\n  ${BaseHeading}\n`\nconst HeadingFive = styled.h5`\n  ${BaseHeading}\n`\nconst HeadingSix = styled.h6`\n  ${BaseHeading}\n`\n\nconst H1 = blockTool({\n  Component: HeadingOne,\n  children: 'Heading 1',\n  command: makeToggleHeader(1),\n  typeName: 'heading',\n  attrs: { level: 1 },\n  title: formatKeymap('Mod-Alt-1'),\n})\nconst H2 = blockTool({\n  Component: HeadingTwo,\n  children: 'Heading 2',\n  command: makeToggleHeader(2),\n  typeName: 'heading',\n  attrs: { level: 2 },\n  title: formatKeymap('Mod-Alt-2'),\n})\nconst H3 = blockTool({\n  Component: HeadingThree,\n  children: 'Heading 3',\n  command: makeToggleHeader(3),\n  typeName: 'heading',\n  attrs: { level: 3 },\n  title: formatKeymap('Mod-Alt-3'),\n})\nconst H4 = blockTool({\n  Component: HeadingFour,\n  children: 'Heading 4',\n  command: makeToggleHeader(4),\n  typeName: 'heading',\n  attrs: { level: 4 },\n  title: formatKeymap('Mod-Alt-4'),\n})\nconst H5 = blockTool({\n  Component: HeadingFive,\n  children: 'Heading 5',\n  command: makeToggleHeader(5),\n  typeName: 'heading',\n  attrs: { level: 5 },\n  title: formatKeymap('Mod-Alt-5'),\n})\nconst H6 = blockTool({\n  Component: HeadingSix,\n  children: 'Heading 6',\n  command: makeToggleHeader(6),\n  typeName: 'heading',\n  attrs: { level: 6 },\n  title: formatKeymap('Mod-Alt-6'),\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { FunctionComponent } from 'react'\n\nimport { HeadingIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu: FunctionComponent = () => (\n  <MenuButton data-tooltip=\"Heading\" disabled>\n    <HeadingIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { setBlockType } from 'prosemirror-commands'\nimport { EditorState, TextSelection } from 'prosemirror-state'\n\nimport { CodeIcon } from '@tinacms/icons'\n\nimport { commandControl } from '../../../components/MenuHelpers'\nimport { formatKeymap } from '../../../utils'\n\nfunction makeCodeBlock(state: EditorState, dispatch: any) {\n  const { code_block, paragraph } = state.schema.nodes\n  const { selection, tr } = state\n  const currentNode = selection.$to.node(selection.$to.depth)\n  if (currentNode.type === code_block)\n    return setBlockType(paragraph)(state, dispatch)\n  if (!dispatch || selection.empty)\n    return setBlockType(code_block)(state, dispatch)\n\n  let content = ``\n  let startPos: number | undefined = undefined\n  let endPos: number | undefined = undefined\n  state.doc.nodesBetween(selection.from, selection.to - 1, (node, pos) => {\n    if (node.isTextblock) {\n      if (startPos === undefined) startPos = pos\n      if (content.length)\n        content += `\n`\n      content += node.textContent\n      endPos = pos + node.textContent.length + 1\n    }\n  })\n  const codeBlock = code_block.createChecked()\n  return dispatch(\n    tr\n      .replaceRangeWith(startPos!, endPos! + 1, codeBlock)\n      .insertText(content, startPos! + 1)\n      .setSelection(\n        new TextSelection(tr.doc.resolve(startPos! + content.length + 1))\n      )\n  )\n}\n\nexport const ProsemirrorMenu = commandControl(\n  makeCodeBlock,\n  CodeIcon,\n  'Codeblock',\n  formatKeymap('Codeblock Mod-Alt-0'),\n  true\n) //codeblock focusing messes with scroll\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { CodeIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <MenuButton data-tooltip=\"Codeblock\" data-side=\"top\" disabled>\n    <CodeIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { exitCode, setBlockType } from 'prosemirror-commands'\nimport { redo, undo } from 'prosemirror-history'\nimport { Node } from 'prosemirror-model'\nimport { Selection, TextSelection } from 'prosemirror-state'\nimport { EditorView, NodeView } from 'prosemirror-view'\nimport { deleteEmptyCodeblock, exitCodeUp, exitCodeHard } from './commands'\n\n// TODO\ntype CodeMirrorEditor = any\n\nconst ssr = typeof navigator == 'undefined'\nconst mac =\n  typeof navigator != 'undefined' ? /Mac/.test(navigator.platform) : false\n\nlet CodeMirror: any = null\n\nif (!ssr) {\n  CodeMirror = require('codemirror')\n}\n\nexport class CodeBlockView implements NodeView {\n  cm: CodeMirrorEditor\n  dom?: HTMLElement\n  updating: boolean = false\n\n  constructor(\n    protected node: Node,\n    protected view: EditorView,\n    protected getPos: () => number\n  ) {\n    if (ssr) return\n    this.cm = this.setupCodeMirror(node)\n    this.dom = this.cm.getWrapperElement()\n    setTimeout(() => this.cm.refresh(), 20)\n    this.cm.on('cursorActivity', this.onCursorActivity)\n    this.cm.on('changes', this.onChange)\n    this.cm.on('focus', this.forwardSelection)\n\n    const offset = this.getPos() + 1\n    const { anchor, head } = view.state.selection\n    this.setSelection(anchor - offset, head - offset)\n  }\n\n  onCursorActivity = () => {\n    if (!this.updating) {\n      this.forwardSelection()\n    }\n  }\n\n  /**\n   * When CodeMirror's Selection is changed, a transaction is dispatched to\n   * update the ProseMirror editor's Selection.\n   */\n  forwardSelection = () => {\n    if (!this.cm.hasFocus()) return\n    const state = this.view.state\n    const selection = this.asProseMirrorSelection(state.doc)\n    if (!selection.eq(state.selection as any)) {\n      this.view.dispatch(state.tr.setSelection(selection as any))\n    }\n  }\n\n  onChange = () => {\n    if (!this.updating) {\n      this.valueChanged()\n    }\n  }\n\n  /**\n   * If the code block is changed, a ProseMirror transaction is dispatched\n   * to keep the two editors in sync.\n   */\n  valueChanged() {\n    const change = computeChange(this.node.textContent, this.cm.getValue())\n    if (change) {\n      const codeBlockStart = this.getPos() + 1\n      const schema = this.view.state.schema\n      const tr = this.view.state.tr.replaceWith(\n        codeBlockStart + change.from,\n        codeBlockStart + change.to,\n        change.text ? schema.text(change.text) : null\n      )\n      this.view.dispatch(tr as any) // Damn typings :(\n    }\n  }\n\n  /**\n   * Creates a ProseMirror TextSelection based off the CodeMirror selection.\n   */\n  asProseMirrorSelection(doc: Node): Selection {\n    const offset = this.getPos() + 1\n    const anchor = this.cm.indexFromPos(this.cm.getCursor('anchor')) + offset\n    const head = this.cm.indexFromPos(this.cm.getCursor('head')) + offset\n    return TextSelection.create(doc, anchor, head)\n  }\n\n  /**\n   * Set's the CodeMirror selection given the anchor and head.\n   */\n  setSelection(anchor: number, head: number) {\n    this.cm.focus()\n    this.updating = true\n    this.cm.setSelection(\n      this.cm.posFromIndex(anchor),\n      this.cm.posFromIndex(head)\n    )\n    this.updating = false\n  }\n\n  /**\n   * Creates a new instance of CodeMirror from a ProseMirror Node\n   */\n  setupCodeMirror(node: Node): CodeMirrorEditor {\n    return CodeMirror(null, {\n      value: node.textContent,\n      lineNumbers: true,\n      extraKeys: this.codeMirrorKeymap(),\n      mode: node.attrs.params,\n      theme: 'forestry',\n    }) as CodeMirrorEditor\n  }\n\n  /**\n   * Generates a Keymap for the CodeMirror instance.\n   */\n  codeMirrorKeymap() {\n    const view = this.view\n    const mod = mac ? 'Cmd' : 'Ctrl'\n    return CodeMirror.normalizeKeyMap({\n      Up: () => this.maybeEscape('line', -1),\n      Left: () => this.maybeEscape('char', -1),\n      Down: () => this.maybeEscape('line', 1),\n      Right: () => this.maybeEscape('char', 1),\n      Backspace: () => {\n        if (\n          !deleteEmptyCodeblock(this.cm)(this.view.state, this.view.dispatch)\n        ) {\n          return CodeMirror.Pass\n        }\n        this.view.focus()\n      },\n      [`${mod}-Z`]: () => undo(view.state as any, view.dispatch as any),\n      [`Shift-${mod}-Z`]: () => redo(view.state as any, view.dispatch as any),\n      [`${mod}-Shift-Enter`]: () => {\n        const pos = this.cm.getCursor()\n\n        if (this.cm.somethingSelected() || pos.line != this.cm.firstLine()) {\n          return CodeMirror.Pass\n        }\n\n        if (view.state.selection.$anchor.parentOffset) {\n          const pos = view.state.selection.$anchor.pos\n          view.dispatch(\n            view.state.tr.setSelection(\n              Selection.near(this.view.state.doc.resolve(pos - 1), -1) as any\n            )\n          )\n        }\n\n        if (exitCodeUp(view.state, view.dispatch)) {\n          view.focus()\n        }\n        return true\n      },\n      ['Shift-Enter']: () => {\n        const pos = this.cm.getCursor()\n\n        if (this.cm.somethingSelected() || pos.line != this.cm.lastLine()) {\n          return CodeMirror.Pass\n        }\n\n        if (view.state.selection.$anchor.parentOffset) {\n          const pos = view.state.selection.$anchor.pos\n          view.dispatch(\n            view.state.tr.setSelection(\n              Selection.near(this.view.state.doc.resolve(pos - 1), -1) as any\n            )\n          )\n        }\n\n        if (exitCode(view.state, view.dispatch)) {\n          return view.focus()\n        } else if (exitCodeHard(view.state, view.dispatch)) {\n          return view.focus()\n        }\n      },\n      [`${mod}-Alt-0`]: () => {\n        const { state, dispatch } = view\n        const { paragraph } = state.schema.nodes\n        setBlockType(paragraph)(state, dispatch)\n      },\n    })\n  }\n\n  maybeEscape(unit: string, dir: number) {\n    const pos = this.cm.getCursor()\n    if (\n      this.cm.somethingSelected() ||\n      pos.line != (dir < 0 ? this.cm.firstLine() : this.cm.lastLine()) ||\n      (unit == 'char' &&\n        pos.ch != (dir < 0 ? 0 : this.cm.getLine(pos.line).length))\n    ) {\n      return CodeMirror.Pass\n    }\n\n    const targetPos = this.getPos() + (dir < 0 ? 0 : this.node.nodeSize)\n    const selection = Selection.near(\n      this.view.state.doc.resolve(targetPos),\n      dir\n    )\n    const atEndOfDocument = !(\n      selection.$from.pos + 1 <\n      (this.view.state.doc.content as any).size\n    )\n\n    if (atEndOfDocument) {\n      return CodeMirror.Pass\n    }\n\n    this.view.dispatch(this.view.state.tr.setSelection(selection as any))\n    this.view.focus()\n  }\n\n  /**\n   * When the Prosemirror Node is updated, compute the change between the\n   * ProseMirror and CodeMirror. Then update CodeMirror to match ProseMirror.\n   */\n  update(node: Node) {\n    if (node.type != this.node.type) return false\n    this.node = node\n    const change = computeChange(this.cm.getValue(), node.textContent)\n    if (change) {\n      this.updating = true\n      this.cm.replaceRange(\n        change.text,\n        this.cm.posFromIndex(change.from),\n        this.cm.posFromIndex(change.to)\n      )\n      this.updating = false\n    }\n    return true\n  }\n\n  /**\n   * Called by ProseMirror when the CodeView is clicked.\n   */\n  selectNode() {\n    this.cm.focus()\n  }\n\n  /**\n   * Prevents Events in here from bubbling.\n   */\n  stopEvent() {\n    return true\n  }\n}\n\ninterface Change {\n  from: number\n  to: number\n  text: string\n}\n\nfunction computeChange(oldVal: string, newVal: string): Change | null {\n  if (oldVal == newVal) return null\n\n  let start = 0\n  let oldEnd = oldVal.length\n  let newEnd = newVal.length\n\n  while (start < oldEnd && oldVal.charCodeAt(start) == newVal.charCodeAt(start))\n    ++start\n  while (\n    oldEnd > start &&\n    newEnd > start &&\n    oldVal.charCodeAt(oldEnd - 1) == newVal.charCodeAt(newEnd - 1)\n  ) {\n    oldEnd--\n    newEnd--\n  }\n  return { from: start, to: oldEnd, text: newVal.slice(start, newEnd) }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState, Selection, TextSelection } from 'prosemirror-state'\n\nexport function exitCodeHard(state: EditorState, dispatch: any) {\n  const { $head } = state.selection\n  const above = $head.node(-1) as any\n  const after = $head.indexAfter(-1)\n  const type = above.defaultContentType(after)\n  if (dispatch) {\n    const pos = $head.before()\n    const tr: any = state.tr.replaceWith(pos, pos, type.createAndFill())\n    tr.setSelection(Selection.near(tr.doc.resolve(pos), 1))\n    dispatch(tr.scrollIntoView())\n  }\n  return true\n}\n\nexport function exitCodeUp(state: EditorState, dispatch: any) {\n  const { $head, $anchor } = state.selection\n  if (!$head.parent.type.spec.code || !$head.sameParent($anchor)) return false\n  const above: any = $head.node(-1)\n  const after = $head.indexAfter(-1)\n  const type = above.defaultContentType(after)\n  if (!above.canReplaceWith(after, after, type)) return false\n  if (dispatch) {\n    const pos = $head.before()\n    const tr: any = state.tr.replaceWith(pos, pos, type.createAndFill())\n    tr.setSelection(Selection.near(tr.doc.resolve(pos), -1))\n    dispatch(tr.scrollIntoView())\n  }\n  return true\n}\n\nexport function deleteEmptyCodeblock(cm: any) {\n  return (state: any, dispatch: any) => {\n    // Todo: It would be nice to have a way to get this without CodeMirror being passed in.\n    const pos = cm.getCursor()\n    const code = cm.getValue()\n    const codeWithoutInvisibles = code.replace(/[ \\r\\n]/g, '')\n    const shouldRemove = !codeWithoutInvisibles\n    if (!(pos.line == 0 && pos.ch == 0 && shouldRemove)) {\n      return false\n    }\n\n    const { $from } = state.selection\n\n    if (dispatch) {\n      // I hate my life\n      const { schema, tr } = state\n      dispatch(\n        (tr\n          // Replace the entire codeblock with an empty paragraph\n          .replaceRangeWith(\n            $from.pos - 1,\n            $from.pos + code.length + 1,\n            schema.nodes.paragraph.create()\n          ) as any)\n          // Set the seleciton to be at the start of the paragram\n          .setSelection(new TextSelection(tr.doc.resolve($from.pos)))\n      )\n    }\n\n    return true\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Plugin, PluginKey } from 'prosemirror-state'\nimport { CodeBlockView } from './nodeView'\n\nconst codeBlockPluginKey = new PluginKey('image')\n\nexport const codeBlockPlugin = new Plugin({\n  key: codeBlockPluginKey,\n\n  props: {\n    nodeViews: {\n      code_block(node, view, getPos) {\n        return new CodeBlockView(node, view, getPos as any)\n      },\n    },\n  },\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { undo, redo, undoDepth, redoDepth } from 'prosemirror-history'\n\nimport { RedoIcon, UndoIcon } from '@tinacms/icons'\n\nimport { useEditorStateContext } from '../../../context/editorState'\nimport { MenuButton } from '../../../components/MenuHelpers'\nimport { formatKeymap } from '../../../utils'\n\nexport const ProsemirrorMenu = () => (\n  <>\n    <UndoControl />\n    <RedoControl />\n  </>\n)\n\nconst UndoControl = () => {\n  const { editorView } = useEditorStateContext()\n  const undoChange = () => {\n    const { state, dispatch } = editorView!.view\n    undo(state, dispatch)\n  }\n\n  const tooltip = formatKeymap('Undo Mod-Z')\n\n  return (\n    <MenuButton\n      data-tooltip={tooltip}\n      title={tooltip}\n      data-side=\"top\"\n      onClick={undoChange}\n      disabled={undoDepth(editorView!.view.state) < 1}\n    >\n      <UndoIcon />\n    </MenuButton>\n  )\n}\n\nconst RedoControl = () => {\n  const { editorView } = useEditorStateContext()\n\n  const redoChange = () => {\n    const { state, dispatch } = editorView!.view\n    redo(state, dispatch)\n  }\n\n  const tooltip = formatKeymap('Redo Mod-Shift-Z')\n\n  return (\n    <MenuButton\n      data-tooltip={tooltip}\n      title={tooltip}\n      data-side=\"top\"\n      onClick={redoChange}\n      disabled={redoDepth(editorView!.view.state) < 1}\n    >\n      <RedoIcon />\n    </MenuButton>\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { RedoIcon, UndoIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <>\n    <UndoControl />\n    <RedoControl />\n  </>\n)\n\nconst UndoControl = () => (\n  <MenuButton data-tooltip=\"Undo\" data-side=\"top\" disabled>\n    <UndoIcon />\n  </MenuButton>\n)\n\nconst RedoControl = () => (\n  <MenuButton data-tooltip=\"Redo\" data-side=\"top\" disabled>\n    <RedoIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Plugin, PluginKey } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\n\nconst exitCodeMarkOnArrowRight = (view: EditorView, event: KeyboardEvent) => {\n  // If user is at end of current line and there is a code mark an arrow-right will\n  // take user out of the code mark.\n  if (event.key !== 'ArrowRight') return false\n  const { selection, schema } = view.state\n  const { code } = schema.marks\n  if (!code.isInSet(selection.$to.marks())) return false\n  const selectionIsAtEnd =\n    selection.$to.node().nodeSize - 2 === selection.$to.parentOffset\n  if (!selectionIsAtEnd) return false\n  const { state, dispatch } = view\n  dispatch(\n    state.tr\n      .insertText(' ', selection.$to.pos)\n      .removeMark(selection.$to.pos, selection.$to.pos + 1, code)\n  )\n  return true\n}\n\nconst inlinePluginKey = new PluginKey('inline')\n\nexport const inlinePlugin = new Plugin({\n  key: inlinePluginKey,\n\n  props: {\n    handleKeyDown(view: EditorView, event: KeyboardEvent) {\n      return exitCodeMarkOnArrowRight(view, event)\n    },\n  },\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { BoldIcon, ItalicIcon, StrikethroughIcon } from '@tinacms/icons'\n\nimport { markControl } from '../../../components/MenuHelpers'\nimport { formatKeymap } from '../../../utils'\n\nexport const ProsemirrorMenu = () => (\n  <>\n    <BoldControl />\n    <ItalicControl />\n    <StrikeControl />\n  </>\n)\n\nconst BoldControl = markControl({\n  mark: 'strong',\n  Icon: BoldIcon,\n  tooltip: formatKeymap('Bold Mod-B'),\n})\n\nconst ItalicControl = markControl({\n  mark: 'em',\n  Icon: ItalicIcon,\n  tooltip: formatKeymap('Italic Mod-I'),\n})\n\nconst StrikeControl = markControl({\n  mark: 'strike',\n  Icon: StrikethroughIcon,\n  tooltip: 'Strike',\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { BoldIcon, ItalicIcon, StrikethroughIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <>\n    <MenuButton data-tooltip=\"Bold\" data-side=\"top\" disabled>\n      <BoldIcon />\n    </MenuButton>\n    <MenuButton data-tooltip=\"Italic\" data-side=\"top\" disabled>\n      <ItalicIcon />\n    </MenuButton>\n    <MenuButton data-tooltip=\"Strike\" data-side=\"top\" disabled>\n      <StrikethroughIcon />\n    </MenuButton>\n  </>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { liftListItem, wrapInList } from 'prosemirror-schema-list'\n\nexport function toggleBulletList(state: EditorState, dispatch: any) {\n  const lift = liftListItem(state.schema.nodes.list_item)\n  const wrap = wrapInList(state.schema.nodes.bullet_list)\n  const canDo = wrap(state, dispatch) || lift(state, dispatch)\n  return canDo\n}\n\nexport function toggleOrderedList(state: EditorState, dispatch: any) {\n  const lift = liftListItem(state.schema.nodes.list_item)\n  const wrap = wrapInList(state.schema.nodes.ordered_list)\n  return wrap(state, dispatch) || lift(state, dispatch)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { UnorderedListIcon, OrderedListIcon } from '@tinacms/icons'\n\nimport { commandControl } from '../../../components/MenuHelpers'\nimport { formatKeymap } from '../../../utils'\nimport { toggleBulletList, toggleOrderedList } from '../commands'\n\nexport const ProsemirrorMenu = (props: any) => (\n  <>\n    <BulletList {...props} />\n    <OrderedList {...props} />\n  </>\n)\n\nconst BulletList = commandControl(\n  toggleBulletList,\n  UnorderedListIcon,\n  'Unordered List',\n  formatKeymap('Unordered List Mod-Alt-8')\n)\n\nconst OrderedList = commandControl(\n  toggleOrderedList,\n  OrderedListIcon,\n  'Ordered List',\n  formatKeymap('Ordered List Mod-Alt-7')\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { UnorderedListIcon, OrderedListIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = (props: any) => (\n  <>\n    <BulletList {...props} />\n    <OrderedList {...props} />\n  </>\n)\n\nconst BulletList = () => (\n  <MenuButton data-tooltip=\"Unordered List\" disabled>\n    <UnorderedListIcon />\n  </MenuButton>\n)\n\nconst OrderedList = () => (\n  <MenuButton data-tooltip=\"Ordered List\" disabled>\n    <OrderedListIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { wrapIn } from 'prosemirror-commands'\nimport { EditorState } from 'prosemirror-state'\nimport { findParentNodeOfType } from 'prosemirror-utils'\nimport { QuoteIcon } from '@tinacms/icons'\n\nimport { commandControl } from '../../../components/MenuHelpers'\n\nfunction wrapInBlockquote(state: EditorState, dispatch: any) {\n  const { blockquote } = state.schema.nodes\n  const { start, node } =\n    findParentNodeOfType(blockquote)(state.selection) || {}\n  if (start && node) {\n    const { tr } = state\n    const nodeRange = tr.doc\n      .resolve(start + 1)\n      .blockRange(tr.doc.resolve(start + node.nodeSize - 2))\n    if (nodeRange) {\n      if (dispatch) return dispatch(tr.lift(nodeRange, 0))\n      else return true\n    }\n  }\n  return wrapIn(state.schema.nodes.blockquote)(state, dispatch)\n}\n\nexport const ProsemirrorMenu = commandControl(\n  wrapInBlockquote,\n  QuoteIcon,\n  'Blockquote',\n  'Blockquote'\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { QuoteIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <MenuButton data-tooltip=\"Quote\" data-side=\"top\" disabled>\n    <QuoteIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { TableMap, CellSelection } from 'prosemirror-tables'\nimport { ContentNodeWithPos } from 'prosemirror-utils'\nimport { Node } from 'prosemirror-model'\nimport { EditorState, Selection } from 'prosemirror-state'\nimport { Decoration } from 'prosemirror-view'\n\nexport const buildCellSelection = (\n  pos: number,\n  classes: String,\n  tableMap: TableMap,\n  table: ContentNodeWithPos,\n  state: EditorState\n): CellSelection | void => {\n  if (classes.includes('tina_table_header_ext_top_left'))\n    return buildTableSelection(pos, tableMap, table, state.doc)\n  if (classes.includes('tina_table_header_ext_left'))\n    return buildColumnSelection(pos, tableMap, table, state.doc)\n  if (classes.includes('tina_table_header_ext_top'))\n    return buildRowSelection(pos, tableMap, table, state.doc)\n}\n\nconst buildColumnSelection = (\n  pos: number,\n  tableMap: TableMap,\n  table: ContentNodeWithPos,\n  doc: Node\n): CellSelection => {\n  const { width } = tableMap\n  const colStart = tableMap.map.findIndex(\n    (c: number) => c === pos - table.start\n  )\n  return new CellSelection(\n    doc.resolve(tableMap.map[colStart + width - 1] + table.start),\n    doc.resolve(pos)\n  )\n}\n\nconst buildRowSelection = (\n  pos: number,\n  tableMap: TableMap,\n  table: ContentNodeWithPos,\n  doc: Node\n): CellSelection => {\n  const { width, height } = tableMap\n  const rowStart = tableMap.map.findIndex(\n    (c: number) => c === pos - table.start\n  )\n  return new CellSelection(\n    doc.resolve(tableMap.map[rowStart + width * (height - 1)] + table.start),\n    doc.resolve(pos)\n  )\n}\n\nconst buildTableSelection = (\n  pos: number,\n  tableMap: TableMap,\n  table: ContentNodeWithPos,\n  doc: Node\n): CellSelection =>\n  new CellSelection(\n    doc.resolve(tableMap.map[tableMap.map.length - 1] + table.start),\n    doc.resolve(pos)\n  )\n\nexport const buildExtendedHeaders = (\n  tableNode: ContentNodeWithPos,\n  selection: Selection\n): Decoration[] => {\n  const tableMap = TableMap.get(tableNode.node)\n  const colSelection =\n    (selection as any).isColSelection && (selection as any).isColSelection()\n  const rowSelection =\n    (selection as any).isRowSelection && (selection as any).isRowSelection()\n\n  let decorations = buildExtendedTableHeaders(\n    tableNode,\n    colSelection,\n    rowSelection\n  )\n  decorations = [\n    ...decorations,\n    ...buildExtendedColumnHeaders(tableNode, tableMap, selection, colSelection),\n  ]\n  decorations = [\n    ...decorations,\n    ...buildExtendedRowHeaders(tableNode, tableMap, selection, rowSelection),\n  ]\n  return decorations\n}\n\nconst buildExtendedColumnHeaders = (\n  tableNode: ContentNodeWithPos,\n  tableMap: TableMap,\n  selection: Selection,\n  colSelection: boolean\n): Decoration[] => {\n  const decorations: Decoration[] = []\n  const cellMap = tableMap.map\n  for (let i = 0; i < tableMap.width; i++) {\n    const div = document.createElement('div')\n    div.classList.add('tina_table_header_ext_top')\n    if (\n      colSelection &&\n      selection.ranges.some(\n        r => r.$from.pos === tableNode.start + cellMap[i] + 1\n      )\n    ) {\n      div.classList.add('tina_table_header_ext_top_selected')\n    }\n    decorations.push(Decoration.widget(tableNode.start + cellMap[i] + 1, div))\n  }\n  return decorations\n}\n\nconst buildExtendedRowHeaders = (\n  tableNode: ContentNodeWithPos,\n  tableMap: TableMap,\n  selection: Selection,\n  rowSelection: boolean\n): Decoration[] => {\n  const decorations: Decoration[] = []\n  const cellMap = tableMap.map\n\n  for (let i = 0; i < tableMap.height; i++) {\n    const div = document.createElement('div')\n    div.classList.add('tina_table_header_ext_left')\n    if (\n      rowSelection &&\n      selection.ranges.some(\n        r => r.$from.pos === tableNode.start + cellMap[i * tableMap.width] + 1\n      )\n    ) {\n      div.classList.add('tina_table_header_ext_left_selected')\n    }\n    decorations.push(\n      Decoration.widget(tableNode.start + cellMap[i * tableMap.width] + 1, div)\n    )\n  }\n  return decorations\n}\n\nconst buildExtendedTableHeaders = (\n  tableNode: ContentNodeWithPos,\n  colSelection: boolean,\n  rowSelection: boolean\n): Decoration[] => {\n  const decorations: Decoration[] = []\n  const div = document.createElement('div')\n  div.classList.add('tina_table_header_ext_top_left')\n  if (colSelection && rowSelection) {\n    div.classList.add('tina_table_header_ext_top_left_selected')\n  }\n  decorations.push(Decoration.widget(tableNode.start + 2, div))\n  return decorations\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Plugin, PluginKey } from 'prosemirror-state'\nimport { DecorationSet, EditorView } from 'prosemirror-view'\nimport { findParentNodeOfType } from 'prosemirror-utils'\nimport { TableMap } from 'prosemirror-tables'\n\nimport { buildCellSelection, buildExtendedHeaders } from './utils'\n\nconst tablePluginKey = new PluginKey('table')\n\nexport const tablePlugin = new Plugin({\n  key: tablePluginKey,\n\n  state: {\n    init: () => {\n      return { deco: DecorationSet.empty }\n    },\n    apply(tr, prev, oldState, newState) {\n      if (tr.getMeta('image_clicked') === false) return prev\n      const { selection } = newState\n      if (selection) {\n        const { table } = newState.schema.nodes\n        const tableNode = findParentNodeOfType(table)(selection)\n\n        if (tableNode) {\n          const selectionNotChanged = selection === oldState.selection\n          const tableNotChanged =\n            (tableNode && tableNode.node.nodeSize) ===\n              (prev.selectedTable && prev.selectedTable.node.nodeSize) &&\n            (tableNode && tableNode.start) ===\n              (prev.selectedTable && prev.selectedTable.start)\n\n          if (selectionNotChanged && tableNotChanged) return prev\n\n          const decorations = buildExtendedHeaders(tableNode, selection)\n\n          if (decorations.length)\n            return {\n              deco: DecorationSet.create(newState.doc, decorations),\n              tableMap: TableMap.get(tableNode.node),\n              selectedTable: tableNode,\n            }\n        }\n      }\n      return { deco: DecorationSet.empty }\n    },\n  },\n  props: {\n    decorations(state) {\n      return (this as any).getState(state).deco\n    },\n    /**\n     * When extended table header is clicked, corresponding column or row should be selected.\n     */\n    handleClickOn(\n      view: EditorView,\n      _1: any,\n      _2: any,\n      nodePos: number,\n      event: any,\n      direct: boolean\n    ) {\n      if (!direct) return false\n      const targetClasses = event.target.classList\n      const { state, dispatch } = view\n      const tablePluginState = tablePluginKey.getState(state)\n      const { tableMap: tableMap, selectedTable } = tablePluginState\n      const cellSelection = buildCellSelection(\n        nodePos,\n        targetClasses.value,\n        tableMap,\n        selectedTable,\n        state\n      )\n      if (cellSelection) dispatch(state.tr.setSelection(cellSelection as any))\n      return false\n    },\n  },\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState, TextSelection } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\nimport { NodeType, Fragment, Node } from 'prosemirror-model'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\nconst createCell = (\n  cellType: NodeType,\n  cellContent?: Fragment | Node | Array<Node>\n) => {\n  if (cellContent) return cellType.createChecked(null, cellContent)\n  return cellType.createAndFill()\n}\n\nexport const insertTable = (\n  state: EditorState,\n  dispatch: Dispatch\n): boolean => {\n  if (!dispatch) return true\n  const {\n    table_cell: tableCell,\n    table_header: tableHeader,\n    table_row: tableRow,\n    table,\n  } = state.schema.nodes\n\n  const rowsCount = 3\n  const colsCount = 3\n  const cells = []\n  const headerCells = []\n  for (let i = 0; i < colsCount; i += 1) {\n    headerCells.push(createCell(tableHeader))\n    cells.push(createCell(tableCell))\n  }\n  const rows = []\n  for (let i = 0; i < rowsCount; i += 1) {\n    rows.push(tableRow.createChecked(null, i === 0 ? headerCells : cells))\n  }\n\n  const newTable = table.createChecked(null, rows)\n  const { selection, tr } = state\n  const { $from, $to } = selection\n  const start = $from.pos - 1\n  const end = $to.pos < state.doc.content.size ? $to.pos + 1 : $to.pos\n  dispatch(\n    tr\n      .replaceWith(start, end, newTable)\n      .setSelection(new TextSelection(tr.doc.resolve($from.pos + 1)))\n      .scrollIntoView()\n  )\n  return true\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { findParentNodeOfType } from 'prosemirror-utils'\nimport { TableIcon } from '@tinacms/icons'\n\nimport { commandControl } from '../../../components/MenuHelpers'\nimport { insertTable } from '../commands'\n\nfunction insertTableCmd(state: EditorState, dispatch: any) {\n  const { table, code_block } = state.schema.nodes\n  const { selection } = state\n  const currentNode = selection.$to.node(selection.$to.depth)\n  if (currentNode && currentNode.type === code_block) return false\n  const tableParent = findParentNodeOfType(table)(selection)\n  if (tableParent) return false\n  return insertTable(state, dispatch)\n}\n\nexport const ProsemirrorMenu = commandControl(\n  insertTableCmd,\n  TableIcon,\n  'Table',\n  'Table'\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { TableIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <MenuButton data-tooltip=\"Table\" disabled>\n    <TableIcon />\n  </MenuButton>\n)\n","// A type of promise-like that resolves synchronously and supports only one observer\nexport const _Pact = /*#__PURE__*/(function() {\n\tfunction _Pact() {}\n\t_Pact.prototype.then = function(onFulfilled, onRejected) {\n\t\tconst result = new _Pact();\n\t\tconst state = this.s;\n\t\tif (state) {\n\t\t\tconst callback = state & 1 ? onFulfilled : onRejected;\n\t\t\tif (callback) {\n\t\t\t\ttry {\n\t\t\t\t\t_settle(result, 1, callback(this.v));\n\t\t\t\t} catch (e) {\n\t\t\t\t\t_settle(result, 2, e);\n\t\t\t\t}\n\t\t\t\treturn result;\n\t\t\t} else {\n\t\t\t\treturn this;\n\t\t\t}\n\t\t}\n\t\tthis.o = function(_this) {\n\t\t\ttry {\n\t\t\t\tconst value = _this.v;\n\t\t\t\tif (_this.s & 1) {\n\t\t\t\t\t_settle(result, 1, onFulfilled ? onFulfilled(value) : value);\n\t\t\t\t} else if (onRejected) {\n\t\t\t\t\t_settle(result, 1, onRejected(value));\n\t\t\t\t} else {\n\t\t\t\t\t_settle(result, 2, value);\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t_settle(result, 2, e);\n\t\t\t}\n\t\t};\n\t\treturn result;\n\t}\n\treturn _Pact;\n})();\n\n// Settles a pact synchronously\nexport function _settle(pact, state, value) {\n\tif (!pact.s) {\n\t\tif (value instanceof _Pact) {\n\t\t\tif (value.s) {\n\t\t\t\tif (state & 1) {\n\t\t\t\t\tstate = value.s;\n\t\t\t\t}\n\t\t\t\tvalue = value.v;\n\t\t\t} else {\n\t\t\t\tvalue.o = _settle.bind(null, pact, state);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\tif (value && value.then) {\n\t\t\tvalue.then(_settle.bind(null, pact, state), _settle.bind(null, pact, 2));\n\t\t\treturn;\n\t\t}\n\t\tpact.s = state;\n\t\tpact.v = value;\n\t\tconst observer = pact.o;\n\t\tif (observer) {\n\t\t\tobserver(pact);\n\t\t}\n\t}\n}\n\nexport function _isSettledPact(thenable) {\n\treturn thenable instanceof _Pact && thenable.s & 1;\n}\n\n// Converts argument to a function that always returns a Promise\nexport function _async(f) {\n\treturn function() {\n\t\tfor (var args = [], i = 0; i < arguments.length; i++) {\n\t\t\targs[i] = arguments[i];\n\t\t}\n\t\ttry {\n\t\t\treturn Promise.resolve(f.apply(this, args));\n\t\t} catch(e) {\n\t\t\treturn Promise.reject(e);\n\t\t}\n\t}\n}\n\n// Awaits on a value that may or may not be a Promise (equivalent to the await keyword in ES2015, with continuations passed explicitly)\nexport function _await(value, then, direct) {\n\tif (direct) {\n\t\treturn then ? then(value) : value;\n\t}\n\tif (!value || !value.then) {\n\t\tvalue = Promise.resolve(value);\n\t}\n\treturn then ? value.then(then) : value;\n}\n\n// Awaits on a value that may or may not be a Promise, then ignores it\nexport function _awaitIgnored(value, direct) {\n\tif (!direct) {\n\t\treturn value && value.then ? value.then(_empty) : Promise.resolve();\n\t}\n}\n\n// Proceeds after a value has resolved, or proceeds immediately if the value is not thenable\nexport function _continue(value, then) {\n\treturn value && value.then ? value.then(then) : then(value);\n}\n\n// Proceeds after a value has resolved, or proceeds immediately if the value is not thenable\nexport function _continueIgnored(value) {\n\tif (value && value.then) {\n\t\treturn value.then(_empty);\n\t}\n}\n\n// Asynchronously iterate through an object that has a length property, passing the index as the first argument to the callback (even as the length property changes)\nexport function _forTo(array, body, check) {\n\tvar i = -1, pact, reject;\n\tfunction _cycle(result) {\n\t\ttry {\n\t\t\twhile (++i < array.length && (!check || !check())) {\n\t\t\t\tresult = body(i);\n\t\t\t\tif (result && result.then) {\n\t\t\t\t\tif (_isSettledPact(result)) {\n\t\t\t\t\t\tresult = result.v;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult.then(_cycle, reject || (reject = _settle.bind(null, pact = new _Pact(), 2)));\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t}\n\t\t\tif (pact) {\n\t\t\t\t_settle(pact, 1, result);\n\t\t\t} else {\n\t\t\t\tpact = result;\n\t\t\t}\n\t\t} catch (e) {\n\t\t\t_settle(pact || (pact = new _Pact()), 2, e);\n\t\t}\n\t}\n\t_cycle();\n\treturn pact;\n}\n\n// Asynchronously iterate through an object's properties (including properties inherited from the prototype)\n// Uses a snapshot of the object's properties\nexport function _forIn(target, body, check) {\n\tvar keys = [];\n\tfor (var key in target) {\n\t\tkeys.push(key);\n\t}\n\treturn _forTo(keys, function(i) { return body(keys[i]); }, check);\n}\n\n// Asynchronously iterate through an object's own properties (excluding properties inherited from the prototype)\n// Uses a snapshot of the object's properties\nexport function _forOwn(target, body, check) {\n\tvar keys = [];\n\tfor (var key in target) {\n\t\tif (Object.prototype.hasOwnProperty.call(target, key)) {\n\t\t\tkeys.push(key);\n\t\t}\n\t}\n\treturn _forTo(keys, function(i) { return body(keys[i]); }, check);\n}\n\nexport const _iteratorSymbol = /*#__PURE__*/ typeof Symbol !== \"undefined\" ? (Symbol.iterator || (Symbol.iterator = Symbol(\"Symbol.iterator\"))) : \"@@iterator\";\n\n// Asynchronously iterate through an object's values\n// Uses for...of if the runtime supports it, otherwise iterates until length on a copy\nexport function _forOf(target, body, check) {\n\tif (typeof target[_iteratorSymbol] === \"function\") {\n\t\tvar iterator = target[_iteratorSymbol](), step, pact, reject;\n\t\tfunction _cycle(result) {\n\t\t\ttry {\n\t\t\t\twhile (!(step = iterator.next()).done && (!check || !check())) {\n\t\t\t\t\tresult = body(step.value);\n\t\t\t\t\tif (result && result.then) {\n\t\t\t\t\t\tif (_isSettledPact(result)) {\n\t\t\t\t\t\t\tresult = result.v;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tresult.then(_cycle, reject || (reject = _settle.bind(null, pact = new _Pact(), 2)));\n\t\t\t\t\t\t\treturn;\n\t\t\t\t\t\t}\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tif (pact) {\n\t\t\t\t\t_settle(pact, 1, result);\n\t\t\t\t} else {\n\t\t\t\t\tpact = result;\n\t\t\t\t}\n\t\t\t} catch (e) {\n\t\t\t\t_settle(pact || (pact = new _Pact()), 2, e);\n\t\t\t}\n\t\t}\n\t\t_cycle();\n\t\tif (iterator.return) {\n\t\t\tvar _fixup = function(value) {\n\t\t\t\ttry {\n\t\t\t\t\tif (!step.done) {\n\t\t\t\t\t\titerator.return();\n\t\t\t\t\t}\n\t\t\t\t} catch(e) {\n\t\t\t\t}\n\t\t\t\treturn value;\n\t\t\t}\n\t\t\tif (pact && pact.then) {\n\t\t\t\treturn pact.then(_fixup, function(e) {\n\t\t\t\t\tthrow _fixup(e);\n\t\t\t\t});\n\t\t\t}\n\t\t\t_fixup();\n\t\t}\n\t\treturn pact;\n\t}\n\t// No support for Symbol.iterator\n\tif (!(\"length\" in target)) {\n\t\tthrow new TypeError(\"Object is not iterable\");\n\t}\n\t// Handle live collections properly\n\tvar values = [];\n\tfor (var i = 0; i < target.length; i++) {\n\t\tvalues.push(target[i]);\n\t}\n\treturn _forTo(values, function(i) { return body(values[i]); }, check);\n}\n\nexport const _asyncIteratorSymbol = /*#__PURE__*/ typeof Symbol !== \"undefined\" ? (Symbol.asyncIterator || (Symbol.asyncIterator = Symbol(\"Symbol.asyncIterator\"))) : \"@@asyncIterator\";\n\n// Asynchronously iterate on a value using it's async iterator if present, or its synchronous iterator if missing\nexport function _forAwaitOf(target, body, check) {\n\tif (typeof target[_asyncIteratorSymbol] === \"function\") {\n\t\tvar pact = new _Pact();\n\t\tvar iterator = target[_asyncIteratorSymbol]();\n\t\titerator.next().then(_resumeAfterNext).then(void 0, _reject);\n\t\treturn pact;\n\t\tfunction _resumeAfterBody(result) {\n\t\t\tif (check && check()) {\n\t\t\t\treturn _settle(pact, 1, iterator.return ? iterator.return().then(function() { return result; }) : result);\n\t\t\t}\n\t\t\titerator.next().then(_resumeAfterNext).then(void 0, _reject);\n\t\t}\n\t\tfunction _resumeAfterNext(step) {\n\t\t\tif (step.done) {\n\t\t\t\t_settle(pact, 1);\n\t\t\t} else {\n\t\t\t\tPromise.resolve(body(step.value)).then(_resumeAfterBody).then(void 0, _reject);\n\t\t\t}\n\t\t}\n\t\tfunction _reject(error) {\n\t\t\t_settle(pact, 2, iterator.return ? iterator.return().then(function() { return error; }) : error);\n\t\t}\n\t}\n\treturn Promise.resolve(_forOf(target, function(value) { return Promise.resolve(value).then(body); }, check));\n}\n\n// Asynchronously implement a generic for loop\nexport function _for(test, update, body) {\n\tvar stage;\n\tfor (;;) {\n\t\tvar shouldContinue = test();\n\t\tif (_isSettledPact(shouldContinue)) {\n\t\t\tshouldContinue = shouldContinue.v;\n\t\t}\n\t\tif (!shouldContinue) {\n\t\t\treturn result;\n\t\t}\n\t\tif (shouldContinue.then) {\n\t\t\tstage = 0;\n\t\t\tbreak;\n\t\t}\n\t\tvar result = body();\n\t\tif (result && result.then) {\n\t\t\tif (_isSettledPact(result)) {\n\t\t\t\tresult = result.s;\n\t\t\t} else {\n\t\t\t\tstage = 1;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tif (update) {\n\t\t\tvar updateValue = update();\n\t\t\tif (updateValue && updateValue.then && !_isSettledPact(updateValue)) {\n\t\t\t\tstage = 2;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t}\n\tvar pact = new _Pact();\n\tvar reject = _settle.bind(null, pact, 2);\n\t(stage === 0 ? shouldContinue.then(_resumeAfterTest) : stage === 1 ? result.then(_resumeAfterBody) : updateValue.then(_resumeAfterUpdate)).then(void 0, reject);\n\treturn pact;\n\tfunction _resumeAfterBody(value) {\n\t\tresult = value;\n\t\tdo {\n\t\t\tif (update) {\n\t\t\t\tupdateValue = update();\n\t\t\t\tif (updateValue && updateValue.then && !_isSettledPact(updateValue)) {\n\t\t\t\t\tupdateValue.then(_resumeAfterUpdate).then(void 0, reject);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\tshouldContinue = test();\n\t\t\tif (!shouldContinue || (_isSettledPact(shouldContinue) && !shouldContinue.v)) {\n\t\t\t\t_settle(pact, 1, result);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tif (shouldContinue.then) {\n\t\t\t\tshouldContinue.then(_resumeAfterTest).then(void 0, reject);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tresult = body();\n\t\t\tif (_isSettledPact(result)) {\n\t\t\t\tresult = result.v;\n\t\t\t}\n\t\t} while (!result || !result.then);\n\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t}\n\tfunction _resumeAfterTest(shouldContinue) {\n\t\tif (shouldContinue) {\n\t\t\tresult = body();\n\t\t\tif (result && result.then) {\n\t\t\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t\t\t} else {\n\t\t\t\t_resumeAfterBody(result);\n\t\t\t}\n\t\t} else {\n\t\t\t_settle(pact, 1, result);\n\t\t}\n\t}\n\tfunction _resumeAfterUpdate() {\n\t\tif (shouldContinue = test()) {\n\t\t\tif (shouldContinue.then) {\n\t\t\t\tshouldContinue.then(_resumeAfterTest).then(void 0, reject);\n\t\t\t} else {\n\t\t\t\t_resumeAfterTest(shouldContinue);\n\t\t\t}\n\t\t} else {\n\t\t\t_settle(pact, 1, result);\n\t\t}\n\t}\n}\n\n// Asynchronously implement a do ... while loop\nexport function _do(body, test) {\n\tvar awaitBody;\n\tdo {\n\t\tvar result = body();\n\t\tif (result && result.then) {\n\t\t\tif (_isSettledPact(result)) {\n\t\t\t\tresult = result.v;\n\t\t\t} else {\n\t\t\t\tawaitBody = true;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t}\n\t\tvar shouldContinue = test();\n\t\tif (_isSettledPact(shouldContinue)) {\n\t\t\tshouldContinue = shouldContinue.v;\n\t\t}\n\t\tif (!shouldContinue) {\n\t\t\treturn result;\n\t\t}\n\t} while (!shouldContinue.then);\n\tconst pact = new _Pact();\n\tconst reject = _settle.bind(null, pact, 2);\n\t(awaitBody ? result.then(_resumeAfterBody) : shouldContinue.then(_resumeAfterTest)).then(void 0, reject);\n\treturn pact;\n\tfunction _resumeAfterBody(value) {\n\t\tresult = value;\n\t\tfor (;;) {\n\t\t\tshouldContinue = test();\n\t\t\tif (_isSettledPact(shouldContinue)) {\n\t\t\t\tshouldContinue = shouldContinue.v;\n\t\t\t}\n\t\t\tif (!shouldContinue) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (shouldContinue.then) {\n\t\t\t\tshouldContinue.then(_resumeAfterTest).then(void 0, reject);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tresult = body();\n\t\t\tif (result && result.then) {\n\t\t\t\tif (_isSettledPact(result)) {\n\t\t\t\t\tresult = result.v;\n\t\t\t\t} else {\n\t\t\t\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t}\n\t\t_settle(pact, 1, result);\n\t}\n\tfunction _resumeAfterTest(shouldContinue) {\n\t\tif (shouldContinue) {\n\t\t\tdo {\n\t\t\t\tresult = body();\n\t\t\t\tif (result && result.then) {\n\t\t\t\t\tif (_isSettledPact(result)) {\n\t\t\t\t\t\tresult = result.v;\n\t\t\t\t\t} else {\n\t\t\t\t\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\t\t\t\t}\n\t\t\t\tshouldContinue = test();\n\t\t\t\tif (_isSettledPact(shouldContinue)) {\n\t\t\t\t\tshouldContinue = shouldContinue.v;\n\t\t\t\t}\n\t\t\t\tif (!shouldContinue) {\n\t\t\t\t\t_settle(pact, 1, result);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} while (!shouldContinue.then);\n\t\t\tshouldContinue.then(_resumeAfterTest).then(void 0, reject);\n\t\t} else {\n\t\t\t_settle(pact, 1, result);\n\t\t}\n\t}\n}\n\n// Asynchronously implement a switch statement\nexport function _switch(discriminant, cases) {\n\tvar dispatchIndex = -1;\n\tvar awaitBody;\n\touter: {\n\t\tfor (var i = 0; i < cases.length; i++) {\n\t\t\tvar test = cases[i][0];\n\t\t\tif (test) {\n\t\t\t\tvar testValue = test();\n\t\t\t\tif (testValue && testValue.then) {\n\t\t\t\t\tbreak outer;\n\t\t\t\t}\n\t\t\t\tif (testValue === discriminant) {\n\t\t\t\t\tdispatchIndex = i;\n\t\t\t\t\tbreak;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Found the default case, set it as the pending dispatch case\n\t\t\t\tdispatchIndex = i;\n\t\t\t}\n\t\t}\n\t\tif (dispatchIndex !== -1) {\n\t\t\tdo {\n\t\t\t\tvar body = cases[dispatchIndex][1];\n\t\t\t\twhile (!body) {\n\t\t\t\t\tdispatchIndex++;\n\t\t\t\t\tbody = cases[dispatchIndex][1];\n\t\t\t\t}\n\t\t\t\tvar result = body();\n\t\t\t\tif (result && result.then) {\n\t\t\t\t\tawaitBody = true;\n\t\t\t\t\tbreak outer;\n\t\t\t\t}\n\t\t\t\tvar fallthroughCheck = cases[dispatchIndex][2];\n\t\t\t\tdispatchIndex++;\n\t\t\t} while (fallthroughCheck && !fallthroughCheck());\n\t\t\treturn result;\n\t\t}\n\t}\n\tconst pact = new _Pact();\n\tconst reject = _settle.bind(null, pact, 2);\n\t(awaitBody ? result.then(_resumeAfterBody) : testValue.then(_resumeAfterTest)).then(void 0, reject);\n\treturn pact;\n\tfunction _resumeAfterTest(value) {\n\t\tfor (;;) {\n\t\t\tif (value === discriminant) {\n\t\t\t\tdispatchIndex = i;\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tif (++i === cases.length) {\n\t\t\t\tif (dispatchIndex !== -1) {\n\t\t\t\t\tbreak;\n\t\t\t\t} else {\n\t\t\t\t\t_settle(pact, 1, result);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t}\n\t\t\ttest = cases[i][0];\n\t\t\tif (test) {\n\t\t\t\tvalue = test();\n\t\t\t\tif (value && value.then) {\n\t\t\t\t\tvalue.then(_resumeAfterTest).then(void 0, reject);\n\t\t\t\t\treturn;\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\tdispatchIndex = i;\n\t\t\t}\n\t\t}\n\t\tdo {\n\t\t\tvar body = cases[dispatchIndex][1];\n\t\t\twhile (!body) {\n\t\t\t\tdispatchIndex++;\n\t\t\t\tbody = cases[dispatchIndex][1];\n\t\t\t}\n\t\t\tvar result = body();\n\t\t\tif (result && result.then) {\n\t\t\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t\t\t\treturn;\n\t\t\t}\n\t\t\tvar fallthroughCheck = cases[dispatchIndex][2];\n\t\t\tdispatchIndex++;\n\t\t} while (fallthroughCheck && !fallthroughCheck());\n\t\t_settle(pact, 1, result);\n\t}\n\tfunction _resumeAfterBody(result) {\n\t\tfor (;;) {\n\t\t\tvar fallthroughCheck = cases[dispatchIndex][2];\n\t\t\tif (!fallthroughCheck || fallthroughCheck()) {\n\t\t\t\tbreak;\n\t\t\t}\n\t\t\tdispatchIndex++;\n\t\t\tvar body = cases[dispatchIndex][1];\n\t\t\twhile (!body) {\n\t\t\t\tdispatchIndex++;\n\t\t\t\tbody = cases[dispatchIndex][1];\n\t\t\t}\n\t\t\tresult = body();\n\t\t\tif (result && result.then) {\n\t\t\t\tresult.then(_resumeAfterBody).then(void 0, reject);\n\t\t\t\treturn;\n\t\t\t}\n\t\t}\n\t\t_settle(pact, 1, result);\n\t}\n}\n\n// Asynchronously call a function and pass the result to explicitly passed continuations\nexport function _call(body, then, direct) {\n\tif (direct) {\n\t\treturn then ? then(body()) : body();\n\t}\n\ttry {\n\t\tvar result = Promise.resolve(body());\n\t\treturn then ? result.then(then) : result;\n\t} catch (e) {\n\t\treturn Promise.reject(e);\n\t}\n}\n\n// Asynchronously call a function and swallow the result\nexport function _callIgnored(body, direct) {\n\treturn _call(body, _empty, direct);\n}\n\n// Asynchronously call a function and pass the result to explicitly passed continuations\nexport function _invoke(body, then) {\n\tvar result = body();\n\tif (result && result.then) {\n\t\treturn result.then(then);\n\t}\n\treturn then(result);\n}\n\n// Asynchronously call a function and swallow the result\nexport function _invokeIgnored(body) {\n\tvar result = body();\n\tif (result && result.then) {\n\t\treturn result.then(_empty);\n\t}\n}\n\n// Asynchronously call a function and send errors to recovery continuation\nexport function _catch(body, recover) {\n\ttry {\n\t\tvar result = body();\n\t} catch(e) {\n\t\treturn recover(e);\n\t}\n\tif (result && result.then) {\n\t\treturn result.then(void 0, recover);\n\t}\n\treturn result;\n}\n\n// Asynchronously await a promise and pass the result to a finally continuation\nexport function _finallyRethrows(body, finalizer) {\n\ttry {\n\t\tvar result = body();\n\t} catch (e) {\n\t\treturn finalizer(true, e);\n\t}\n\tif (result && result.then) {\n\t\treturn result.then(finalizer.bind(null, false), finalizer.bind(null, true));\n\t}\n\treturn finalizer(false, result);\n}\n\n// Asynchronously await a promise and invoke a finally continuation that always overrides the result\nexport function _finally(body, finalizer) {\n\ttry {\n\t\tvar result = body();\n\t} catch (e) {\n\t\treturn finalizer();\n\t}\n\tif (result && result.then) {\n\t\treturn result.then(finalizer, finalizer);\n\t}\n\treturn finalizer();\n}\n\n// Rethrow or return a value from a finally continuation\nexport function _rethrow(thrown, value) {\n\tif (thrown)\n\t\tthrow value;\n\treturn value;\n}\n\n// Empty function to implement break and other control flow that ignores asynchronous results\nexport function _empty() {\n}\n\n// Sentinel value for early returns in generators \nexport const _earlyReturn = /*#__PURE__*/ {};\n\n// Asynchronously call a function and send errors to recovery continuation, skipping early returns\nexport function _catchInGenerator(body, recover) {\n\treturn _catch(body, function(e) {\n\t\tif (e === _earlyReturn) {\n\t\t\tthrow e;\n\t\t}\n\t\treturn recover(e);\n\t});\n}\n\n// Asynchronous generator class; accepts the entrypoint of the generator, to which it passes itself when the generator should start\nexport const _AsyncGenerator = /*#__PURE__*/(function() {\n\tfunction _AsyncGenerator(entry) {\n\t\tthis._entry = entry;\n\t\tthis._pact = null;\n\t\tthis._resolve = null;\n\t\tthis._return = null;\n\t\tthis._promise = null;\n\t}\n\n\tfunction _wrapReturnedValue(value) {\n\t\treturn { value: value, done: true };\n\t}\n\tfunction _wrapYieldedValue(value) {\n\t\treturn { value: value, done: false };\n\t}\n\n\t_AsyncGenerator.prototype._yield = function(value) {\n\t\t// Yield the value to the pending next call\n\t\tthis._resolve(value && value.then ? value.then(_wrapYieldedValue) : _wrapYieldedValue(value));\n\t\t// Return a pact for an upcoming next/return/throw call\n\t\treturn this._pact = new _Pact();\n\t};\n\t_AsyncGenerator.prototype.next = function(value) {\n\t\t// Advance the generator, starting it if it has yet to be started\n\t\tconst _this = this;\n\t\treturn _this._promise = new Promise(function (resolve) {\n\t\t\tconst _pact = _this._pact;\n\t\t\tif (_pact === null) {\n\t\t\t\tconst _entry = _this._entry;\n\t\t\t\tif (_entry === null) {\n\t\t\t\t\t// Generator is started, but not awaiting a yield expression\n\t\t\t\t\t// Abandon the next call!\n\t\t\t\t\treturn resolve(_this._promise);\n\t\t\t\t}\n\t\t\t\t// Start the generator\n\t\t\t\t_this._entry = null;\n\t\t\t\t_this._resolve = resolve;\n\t\t\t\tfunction returnValue(value) {\n\t\t\t\t\t_this._resolve(value && value.then ? value.then(_wrapReturnedValue) : _wrapReturnedValue(value));\n\t\t\t\t\t_this._pact = null;\n\t\t\t\t\t_this._resolve = null;\n\t\t\t\t}\n\t\t\t\tvar result = _entry(_this);\n\t\t\t\tif (result && result.then) {\n\t\t\t\t\tresult.then(returnValue, function(error) {\n\t\t\t\t\t\tif (error === _earlyReturn) {\n\t\t\t\t\t\t\treturnValue(_this._return);\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\tconst pact = new _Pact();\n\t\t\t\t\t\t\t_this._resolve(pact);\n\t\t\t\t\t\t\t_this._pact = null;\n\t\t\t\t\t\t\t_this._resolve = null;\n\t\t\t\t\t\t\t_resolve(pact, 2, error);\n\t\t\t\t\t\t}\n\t\t\t\t\t});\n\t\t\t\t} else {\n\t\t\t\t\treturnValue(result);\n\t\t\t\t}\n\t\t\t} else {\n\t\t\t\t// Generator is started and a yield expression is pending, settle it\n\t\t\t\t_this._pact = null;\n\t\t\t\t_this._resolve = resolve;\n\t\t\t\t_settle(_pact, 1, value);\n\t\t\t}\n\t\t});\n\t};\n\t_AsyncGenerator.prototype.return = function(value) {\n\t\t// Early return from the generator if started, otherwise abandons the generator\n\t\tconst _this = this;\n\t\treturn _this._promise = new Promise(function (resolve) {\n\t\t\tconst _pact = _this._pact;\n\t\t\tif (_pact === null) {\n\t\t\t\tif (_this._entry === null) {\n\t\t\t\t\t// Generator is started, but not awaiting a yield expression\n\t\t\t\t\t// Abandon the return call!\n\t\t\t\t\treturn resolve(_this._promise);\n\t\t\t\t}\n\t\t\t\t// Generator is not started, abandon it and return the specified value\n\t\t\t\t_this._entry = null;\n\t\t\t\treturn resolve(value && value.then ? value.then(_wrapReturnedValue) : _wrapReturnedValue(value));\n\t\t\t}\n\t\t\t// Settle the yield expression with a rejected \"early return\" value\n\t\t\t_this._return = value;\n\t\t\t_this._resolve = resolve;\n\t\t\t_this._pact = null;\n\t\t\t_settle(_pact, 2, _earlyReturn);\n\t\t});\n\t};\n\t_AsyncGenerator.prototype.throw = function(error) {\n\t\t// Inject an exception into the pending yield expression\n\t\tconst _this = this;\n\t\treturn _this._promise = new Promise(function (resolve, reject) {\n\t\t\tconst _pact = _this._pact;\n\t\t\tif (_pact === null) {\n\t\t\t\tif (_this._entry === null) {\n\t\t\t\t\t// Generator is started, but not awaiting a yield expression\n\t\t\t\t\t// Abandon the throw call!\n\t\t\t\t\treturn resolve(_this._promise);\n\t\t\t\t}\n\t\t\t\t// Generator is not started, abandon it and return a rejected Promise containing the error\n\t\t\t\t_this._entry = null;\n\t\t\t\treturn reject(error);\n\t\t\t}\n\t\t\t// Settle the yield expression with the value as a rejection\n\t\t\t_this._resolve = resolve;\n\t\t\t_this._pact = null;\n\t\t\t_settle(_pact, 2, error);\n\t\t});\n\t};\n\n\t_AsyncGenerator.prototype[_asyncIteratorSymbol] = function() {\n\t\treturn this;\n\t};\n\t\n\treturn _AsyncGenerator;\n})();\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\nimport { EditorView, NodeView } from 'prosemirror-view'\nimport { ImageProps } from '../../types'\n\nconst Identity = (str: string) => str\n\nexport class ImageView implements NodeView {\n  node: Node\n  view: EditorView\n  dom?: HTMLElement\n  img?: HTMLImageElement\n\n  constructor(\n    node: Node,\n    view: EditorView,\n    private previewSrc: ImageProps['previewSrc'] = Identity\n  ) {\n    this.node = node\n    this.view = view\n\n    this.dom = document.createElement('span')\n    this.dom.classList.add('tinacms-image-wrapper')\n    this.img = document.createElement('img')\n    const { src, align, alt, title, width, height } = node.attrs\n    this.updateImgSrc(src)\n    if (height) this.img.style.height = height\n    if (width) this.img.style.width = width\n    if (align) this.img.classList.add(`align-${align}`)\n    if (alt) this.img.alt = alt\n    if (title) this.img.title = title\n    this.dom.appendChild(this.img)\n  }\n  async updateImgSrc(src: string) {\n    if (!this.img) return\n    try {\n      this.img.src = await this.previewSrc!(src)\n    } catch {\n      this.img.src = src\n    }\n  }\n\n  update(node: Node) {\n    if (this.img) {\n      const { alt, title } = node.attrs\n      if (alt) this.img.alt = alt\n      if (title) this.img.title = title\n    }\n    return true\n  }\n\n  selectNode = () => {\n    if (this.img) {\n      this.img.style.outline = '4px solid #0084FF'\n      this.img.classList.add('tina-selected-image')\n    }\n  }\n\n  deselectNode = () => {\n    if (this.img) {\n      this.img.style.outline = ''\n      this.img.classList.remove('tina-selected-image')\n    }\n  }\n\n  destroy = () => {\n    this.deselectNode()\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport {\n  EditorState,\n  NodeSelection,\n  Plugin,\n  PluginKey,\n  Transaction,\n} from 'prosemirror-state'\nimport { EditorView, DecorationSet, Decoration } from 'prosemirror-view'\nimport { Slice } from 'prosemirror-model'\n\nimport { insertImageList } from './commands'\nimport { ImageView } from './nodeView'\nimport { ImageProps } from '../../types'\n\nexport const imagePluginKey = new PluginKey<{ selectedImage?: any }>('image')\n\nconst setSelectionAtPos = (\n  state: EditorState,\n  dispatch: (tr: Transaction) => void,\n  pos: number\n) => {\n  dispatch(state.tr.setSelection(new NodeSelection(state.tr.doc.resolve(pos))))\n}\n\nconst insertImageFiles = (\n  editorView: EditorView,\n  data: DataTransfer,\n  uploadImages: (files: File[]) => Promise<string[]>\n) => {\n  const files = []\n  for (let i = 0; i < data.files.length; i++) {\n    const file = data.files[i]\n    if (file.type.match('image.*')) files.push(file)\n  }\n  if (files.length) {\n    const { state, dispatch } = editorView\n    dispatch(state.tr.setMeta('loading_images', files.length))\n    const uploadPromise = uploadImages(files)\n    uploadPromise.then((urls = []) => {\n      dispatch(state.tr.setMeta('loading_images', 0))\n      insertImageList(state, dispatch, urls)\n      editorView.focus()\n    })\n    return true\n  }\n  return false\n}\n\nexport const imagePlugin = ({ previewSrc, upload: uploadImages }: ImageProps) =>\n  new Plugin<{ selectedImage?: any }>({\n    key: imagePluginKey,\n\n    state: {\n      init: () => {\n        return { selectedImage: undefined }\n      },\n      apply(tr, prev, _, newState) {\n        if (tr.getMeta('loading_images') > 0) {\n          const loadingImagesCount = tr.getMeta('loading_images')\n          const div = document.createElement('div')\n          for (let i = 0; i < loadingImagesCount; i++) {\n            const childElement = document.createElement('div')\n            childElement.classList.add('image_loading_indicator')\n            div.appendChild(childElement)\n          }\n          return {\n            ...prev,\n            deco: DecorationSet.create(newState.doc, [\n              Decoration.widget(newState.selection.$to.pos, div),\n            ]),\n          }\n        }\n        if (tr.getMeta('loading_images') === 0) {\n          return {\n            ...prev,\n            deco: undefined,\n          }\n        }\n        if (prev && prev.selectedImage) {\n          const { pos } = prev.selectedImage\n          if (!tr.doc.nodeAt(pos))\n            return {\n              ...prev,\n              selectedImage: undefined,\n            }\n        }\n        const selectedImage = tr.getMeta('image_clicked')\n        if (selectedImage) return { ...prev, selectedImage }\n        if (selectedImage === false)\n          return { ...prev, selectedImage: undefined }\n        return prev\n      },\n    },\n    props: {\n      nodeViews: {\n        image(node, view) {\n          return new ImageView(node, view, previewSrc)\n        },\n      },\n      decorations(state) {\n        return (this as any).getState(state).deco\n      },\n      handleKeyDown(view: EditorView, event: KeyboardEvent) {\n        const { state, dispatch } = view\n        const { selection, schema } = state\n        if (event.key === 'Escape') {\n          dispatch(state.tr.setMeta('image_clicked', false))\n        } else if (\n          event.key === 'Backspace' &&\n          selection.$to.nodeBefore &&\n          selection.$to.nodeBefore.type === schema.nodes.image\n        ) {\n          setSelectionAtPos(state, dispatch, selection.$to.pos - 1)\n          return true\n        } else if (\n          event.key === 'Delete' &&\n          selection.$to.nodeAfter &&\n          selection.$to.nodeAfter.type === schema.nodes.image\n        ) {\n          setSelectionAtPos(state, dispatch, selection.$to.pos)\n          return true\n        }\n        return false\n      },\n      handleClickOn(\n        view: EditorView,\n        _1: any,\n        node: any,\n        nodePos: number,\n        _2: any,\n        direct: boolean\n      ) {\n        if (!direct) return false\n        const { state, dispatch } = view\n        const { image } = view.state.schema.nodes\n        if (node.type === image) {\n          dispatch(state.tr.setMeta('image_clicked', { pos: nodePos, node }))\n        } else {\n          dispatch(state.tr.setMeta('image_clicked', false))\n        }\n        return false\n      },\n      handleDrop(\n        editorView: EditorView,\n        event: Event,\n        _: Slice,\n        moved: boolean\n      ) {\n        if (moved || !uploadImages) return false\n        event.preventDefault()\n        const dataTransfer = (event as DragEvent).dataTransfer\n        if (!dataTransfer) return false\n        return insertImageFiles(editorView, dataTransfer, uploadImages)\n      },\n      handlePaste(editorView: EditorView, event: Event) {\n        if (!uploadImages) return false\n        event.preventDefault()\n        const clipboardData = (event as ClipboardEvent).clipboardData\n        if (!clipboardData) return false\n        return insertImageFiles(editorView, clipboardData, uploadImages)\n      },\n    },\n  })\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\nexport function insertImage(\n  state: EditorState,\n  dispatch: Dispatch | null,\n  src: string\n) {\n  const nodeType = state.schema.nodes['image']\n  const image = nodeType.createAndFill({ src, alt: '', title: '' })\n  if (dispatch) {\n    dispatch(state.tr.replaceSelectionWith(image).scrollIntoView())\n  }\n  return true\n}\n\nexport function insertImageList(\n  state: EditorState,\n  dispatch: Dispatch | null,\n  imageSrc: string[]\n) {\n  if (dispatch) {\n    const nodeType = state.schema.nodes['image']\n    const { tr } = state\n    imageSrc.forEach(src => {\n      const image = nodeType.createAndFill({ src, alt: '', title: '' })\n      tr.replaceSelectionWith(image)\n    })\n    dispatch(tr.scrollIntoView())\n  }\n  return true\n}\n\nexport function alignImage(\n  state: EditorState,\n  dispatch: Dispatch | null,\n  at: number,\n  direction: 'left' | 'right' | 'center' | ''\n) {\n  const node = state.doc.nodeAt(at)\n  if (!node || node.type !== state.schema.nodes.image) return false\n  const attrs = {\n    ...node.attrs,\n    align: node.attrs.align === direction ? null : direction,\n  }\n\n  if (dispatch) {\n    dispatch(\n      (state.tr as any).setNodeMarkup(at, node.type, attrs, node.marks) as any\n    )\n  }\n  return true\n}\n\nexport function removeImage(\n  state: EditorState,\n  dispatch: Dispatch | null,\n  at: number\n) {\n  const from = at\n  const to = from + 1\n  const node = state.doc.nodeAt(from)\n  if (!node || node.type != state.schema.nodes.image) return false\n  if (dispatch) {\n    dispatch(state.tr.delete(from, to) as any)\n  }\n  return true\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { useRef, useState, ChangeEvent } from 'react'\nimport styled, { css } from 'styled-components'\nimport { Dismissible } from 'react-dismissible'\n\nimport { Button } from '@tinacms/styles'\nimport { Input } from '@tinacms/fields'\nimport { MediaIcon, UploadIcon, CloseIcon } from '@tinacms/icons'\n\nimport { MenuButton, MenuDropdown } from '../../../components/MenuHelpers'\nimport { useEditorStateContext } from '../../../context/editorState'\nimport { insertImage } from '../commands'\n\nexport interface MenuProps {\n  uploadImages?: (files: File[]) => Promise<string[]>\n}\n\nexport const ProsemirrorMenu = ({ uploadImages }: MenuProps) => {\n  const menuButtonRef = useRef()\n  const { editorView } = useEditorStateContext()\n  const [displayUrlInput, setDisplayUrlInput] = useState(false)\n  const [imageUrl, setImageUrl] = useState('')\n  const [showImageModal, setShowImageModal] = useState(false)\n  const [uploading, setUploading] = useState(false)\n\n  if (!uploadImages) return null\n\n  const uploadImageFile = (file: File) => {\n    setUploading(true)\n    const uploadPromise = uploadImages([file])\n    uploadPromise.then((urls = []) => {\n      setImageUrl(urls[0])\n      setUploading(false)\n    })\n  }\n\n  const insertImageInEditor = () => {\n    if (!editorView) return\n    const { state, dispatch } = editorView.view\n    insertImage(state, dispatch, imageUrl)\n    editorView.view.focus()\n    setShowImageModal(false)\n    setImageUrl('')\n  }\n\n  const uploadSelectedImage = (event: ChangeEvent) => {\n    const { files } = event.target as any\n    if (files[0]) {\n      uploadImageFile(files[0])\n    }\n  }\n\n  const stopDefault = (evt: React.DragEvent<HTMLSpanElement>) => {\n    evt.preventDefault()\n    evt.stopPropagation()\n  }\n\n  // Check if property name is files or items\n  // IE uses 'files' instead of 'items'\n  const onImageDrop = (evt: React.DragEvent<HTMLSpanElement>) => {\n    stopDefault(evt)\n    const { items, files } = evt.dataTransfer\n    const data = items || files\n    const dataIsItems = !!items\n    for (let i = 0; i < data.length; i += 1) {\n      if (\n        (!dataIsItems || data[i].kind === 'file') &&\n        data[i].type.match('^image/')\n      ) {\n        const file = (dataIsItems ? data[i].getAsFile() : data[i]) as File\n        if (file) {\n          uploadImageFile(file)\n        }\n      }\n    }\n  }\n\n  const handleKeyDown = (event: KeyboardEvent) => {\n    if (event.key === 'Escape') setShowImageModal(false)\n  }\n\n  const handleCloseModal = () => {\n    setImageUrl('')\n    setShowImageModal(!showImageModal)\n  }\n\n  return (\n    <>\n      <MenuButton title=\"Image\" ref={menuButtonRef} onClick={handleCloseModal}>\n        <MediaIcon />\n      </MenuButton>\n      <MenuDropdown\n        triggerRef={menuButtonRef}\n        open={showImageModal}\n        onKeyDown={handleKeyDown}\n      >\n        <Dismissible\n          click\n          escape\n          disabled={!showImageModal}\n          onDismiss={() => {\n            setShowImageModal(false)\n          }}\n        >\n          <ImageModalContent>\n            <StyledLabel\n              htmlFor=\"fileInput\"\n              onClick={evt => evt.stopPropagation()}\n            >\n              <FileUploadInput\n                id=\"fileInput\"\n                onChange={uploadSelectedImage}\n                type=\"file\"\n                accept=\"image/*\"\n              />\n              <UploadSection\n                onDragEnter={stopDefault}\n                onDragOver={stopDefault}\n                onDrop={onImageDrop}\n                uploading={uploading}\n                imageUrl={imageUrl}\n              >\n                {imageUrl && (\n                  <>\n                    <ClearImageButton\n                      onMouseDown={evt => {\n                        setImageUrl('')\n                        evt.stopPropagation()\n                      }}\n                    >\n                      <CloseIcon />\n                    </ClearImageButton>\n                    <CurrentImage src={imageUrl} alt=\"uploaded_image\" />\n                  </>\n                )}\n                {!imageUrl && (\n                  <>\n                    <UploadIconWrapper>\n                      <UploadIcon />\n                    </UploadIconWrapper>\n                    <UploadText>\n                      {!uploading && `Drag and drop or click to upload`}\n                      {uploading && 'Image uploading...'}\n                    </UploadText>\n                  </>\n                )}\n              </UploadSection>\n            </StyledLabel>\n            <UrlInputWrapper>\n              {displayUrlInput && (\n                <>\n                  <UrlInput onMouseDown={evt => evt.stopPropagation()}>\n                    <ImageInputLabel\n                      onClick={() => {\n                        setDisplayUrlInput(false)\n                      }}\n                    >\n                      Or Enter Image URL\n                    </ImageInputLabel>\n                    <Input\n                      small\n                      onChange={evt => setImageUrl(evt.target.value)}\n                      value={imageUrl}\n                    ></Input>\n                  </UrlInput>\n                </>\n              )}\n              {!displayUrlInput && (\n                <>\n                  <UrlInputTrigger\n                    onClick={() => {\n                      setDisplayUrlInput(true)\n                    }}\n                  >\n                    Or Enter Image URL\n                  </UrlInputTrigger>\n                </>\n              )}\n            </UrlInputWrapper>\n            <ImageModalActions>\n              <Button small onClick={handleCloseModal}>\n                Cancel\n              </Button>\n              <Button primary small onClick={insertImageInEditor}>\n                Insert\n              </Button>\n            </ImageModalActions>\n          </ImageModalContent>\n        </Dismissible>\n      </MenuDropdown>\n    </>\n  )\n}\n\nconst ClearImageButton = styled.button`\n  background: none;\n  border: none;\n  display: flex;\n  align-items: center;\n  justify-content: center;\n  outline: none;\n  width: 32px;\n  height: 32px;\n  padding: 0;\n  position: absolute;\n  top: 18px;\n  right: 18px;\n  border-radius: var(--tina-radius-big);\n  box-shadow: var(--tina-shadow-small);\n  background-color: var(--tina-color-grey-0);\n  border: 1px solid var(--tina-color-grey-2);\n  cursor: pointer;\n  transition: all 85ms ease-out;\n\n  &:hover {\n    background-color: var(--tina-color-grey-1);\n  }\n\n  svg {\n    fill: var(--tina-color-primary);\n    width: 22px;\n    height: 22px;\n  }\n`\n\nconst UrlInputWrapper = styled.div`\n  display: flex;\n  margin-bottom: var(--tina-padding-small);\n`\n\nconst UrlInputTrigger = styled.button`\n  background: none;\n  border: none;\n  outline: none;\n  color: var(--tina-color-primary);\n  cursor: pointer;\n  transition: all 80ms ease-out;\n  font-size: var(--tina-font-size-1);\n  font-weight: 600;\n  letter-spacing: 0.01em;\n  line-height: 1.35;\n  padding: 0;\n\n  &:hover {\n    text-decoration: underline;\n    text-decoration-color: var(--tina-color-primary-light);\n  }\n`\n\nconst UrlInput = styled.div``\n\nconst UploadIconWrapper = styled.div`\n  display: flex;\n  justify-content: center;\n  margin-top: -7px;\n  svg {\n    width: 50px;\n    height: auto;\n    fill: var(--tina-color-primary);\n  }\n`\n\nconst CurrentImage = styled.img`\n  display: block;\n  width: 100%;\n  margin: 0;\n`\n\nconst ImageInputLabel = styled.label`\n  display: block;\n  font-size: var(--tina-font-size-1);\n  font-weight: 600;\n  letter-spacing: 0.01em;\n  line-height: 1.35;\n  color: var(--tina-color-grey-8);\n  margin-bottom: 8px;\n  text-overflow: ellipsis;\n  width: 100%;\n  overflow: hidden;\n`\n\nconst ImageModalContent = styled.div`\n  background: var(--tina-color-grey-1);\n  padding: var(--tina-padding-small);\n  font-family: var(--tina-font-family);\n\n  * {\n    font-family: inherit;\n  }\n`\n\nconst ImageModalActions = styled.div`\n  display: flex;\n  margin: 0 -4px;\n  width: calc(100% + 8px);\n\n  ${Button} {\n    flex: 1 0 auto;\n    margin: 0 4px;\n  }\n`\n\nconst UploadText = styled.span`\n  font-size: var(--tina-font-size-2);\n  text-align: center;\n  line-height: 1.2;\n  color: var(--tina-color-grey-10);\n  max-width: 140px;\n  white-space: break-spaces;\n  display: block;\n  margin: 0 auto;\n`\n\nconst UploadSection = styled.div<{ uploading: boolean; imageUrl: string }>`\n  display: block;\n  width: 100%;\n  min-width: 200px;\n  padding: var(--tina-padding-big) 0;\n  margin-bottom: var(--tina-padding-small);\n  border-radius: var(--tina-radius-big);\n  border: 3px dashed var(--tina-color-grey-3);\n  cursor: pointer;\n\n  ${props =>\n    props.imageUrl !== '' &&\n    css`\n      padding: 0;\n      border: none;\n      border-radius: var(--tina-radius-small);\n      border: 1px solid var(--tina-color-grey-2);\n    `};\n`\n\nconst FileUploadInput = styled.input`\n  display: none;\n`\n\nconst StyledLabel = styled.label`\n  display: block;\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { MediaIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\ninterface Props {\n  uploadImages?: (files: File[]) => Promise<string[]>\n}\n\nexport const MarkdownMenu: React.FC<Props> = ({ uploadImages }) =>\n  uploadImages ? (\n    <MenuButton\n      data-testid=\"image-menu\"\n      data-tooltip=\"Image\"\n      data-side=\"top\"\n      disabled\n    >\n      <MediaIcon />\n    </MenuButton>\n  ) : null\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { useState, useRef, useEffect, FunctionComponent } from 'react'\nimport debounce from 'lodash.debounce'\nimport styled from 'styled-components'\nimport { NodeSelection } from 'prosemirror-state'\nimport { Mark } from 'prosemirror-model'\n\nimport { StyleReset } from '@tinacms/styles'\n\nimport { findElementOffsetTop, findElementOffsetLeft } from '../../../utils'\nimport { useEditorStateContext } from '../../../context/editorState'\nimport { imagePluginKey } from '../plugin'\n\nexport const ImageEdit: FunctionComponent = () => {\n  const { editorView } = useEditorStateContext()\n  const view = editorView!.view\n  const imagePluginState = imagePluginKey.getState(view.state)\n  if (!imagePluginState || !imagePluginState.selectedImage) return null\n  const { node, pos } = imagePluginState.selectedImage\n  const { link } = view.state.schema.marks\n  const linkMark = node.marks.find((mark: Mark) => mark.type === link)\n  const [title, setTitle] = useState(node.attrs.title)\n  const [alt, setAlt] = useState(node.attrs.alt)\n  const [linkTitle, setLinkTitle] = useState(linkMark && linkMark.attrs.title)\n  const [linkSrc, setLinkSrc] = useState(linkMark && linkMark.attrs.href)\n  const { top, left } = view.coordsAtPos(pos)\n  const [modalTop, setModalTop] = useState(top)\n  const [modalLeft, setModalLeft] = useState(left)\n  const wrapperRef = useRef() as React.MutableRefObject<HTMLElement>\n  const inputRef = useRef() as React.MutableRefObject<HTMLInputElement>\n  const imageRef = useRef() as React.MutableRefObject<HTMLImageElement>\n  const [linked, toggleLinked] = useState(!!linkMark)\n\n  function positionImage(scroll?: boolean) {\n    const image = document.getElementsByClassName('tina-selected-image')[0]\n    const wysiwygWrapper = document.getElementsByClassName('wysiwyg-wrapper')[0]\n    if (image && (imageRef.current !== image || scroll) && wrapperRef.current) {\n      imageRef.current = image as any\n      const wrapperDimensions = wrapperRef.current.getBoundingClientRect()\n      setModalLeft(\n        image.clientWidth / 2 +\n          findElementOffsetLeft(\n            image as HTMLElement,\n            wysiwygWrapper as HTMLElement\n          ) -\n          wrapperDimensions.width / 2\n      )\n      setModalTop(\n        findElementOffsetTop(\n          image as HTMLElement,\n          wysiwygWrapper as HTMLElement\n        )\n      )\n    }\n  }\n\n  useEffect(() => {\n    const debouncedPositionImage = debounce(() => positionImage(true), 10)\n    window.addEventListener('scroll', debouncedPositionImage)\n    return () => {\n      window.removeEventListener('scroll', debouncedPositionImage)\n    }\n  })\n\n  useEffect(() => {\n    setLinkTitle(linkMark ? linkMark.attrs.title : '')\n    setLinkSrc(linkMark ? linkMark.attrs.href : '')\n    toggleLinked(!!linkMark)\n  }, [linkMark])\n\n  useEffect(() => {\n    setTitle(node.attrs.title)\n    setAlt(node.attrs.alt)\n  }, [imagePluginState.selectedImage.node])\n\n  useEffect(() => {\n    setTimeout(() => {\n      if (inputRef.current) inputRef.current.focus()\n    })\n  }, [inputRef])\n\n  useEffect(positionImage)\n\n  const updateNodeAttrs = () => {\n    const { dispatch, state } = view\n    const { image } = state.schema.nodes\n    const { link } = state.schema.marks\n    const { tr } = state\n    if (linked && (linkSrc || linkTitle)) {\n      tr.addMark(pos, pos + 1, link.create({ href: linkSrc, title: linkTitle }))\n    } else {\n      tr.removeMark(pos, pos + 1, link)\n    }\n    tr.setNodeMarkup(pos, image, {\n      ...node.attrs,\n      alt,\n      title,\n    }).setSelection(new NodeSelection(tr.doc.resolve(pos)))\n    dispatch(tr)\n    closeImageSettings()\n    view.focus()\n  }\n\n  const closeImageSettings = () => {\n    const { dispatch, state } = view\n    dispatch(state.tr.setMeta('image_clicked', false))\n    setTitle('')\n    setAlt('')\n    setLinkTitle('')\n    setLinkSrc('')\n    view.focus()\n  }\n\n  const handleKeyPress = (evt: React.KeyboardEvent) => {\n    if (evt.key === 'Escape') closeImageSettings()\n    if (evt.key === 'Enter') updateNodeAttrs()\n  }\n\n  return (\n    <StyleReset>\n      <LinkPopup\n        top={modalTop}\n        left={modalLeft}\n        ref={wrapperRef}\n        onKeyDown={handleKeyPress}\n      >\n        <LinkLabel>Title</LinkLabel>\n        <LinkInput\n          placeholder=\"Enter Title\"\n          type={'text'}\n          ref={inputRef}\n          value={title}\n          onChange={evt => setTitle(evt.target.value)}\n        />\n        <LinkLabel>Alt</LinkLabel>\n        <LinkInput\n          placeholder=\"Enter Alt Text\"\n          type={'text'}\n          value={alt}\n          onChange={evt => setAlt(evt.target.value)}\n        />\n        <ToggleElement>\n          <ToggleInput\n            id=\"toggleImageLink\"\n            onChange={() => {\n              toggleLinked(!linked)\n              if (!linked) {\n                setLinkTitle('')\n                setLinkSrc('')\n              }\n            }}\n            type=\"checkbox\"\n          />\n          <ToggleLabel htmlFor=\"toggleImageLink\" role=\"switch\">\n            Insert Link\n            <ToggleSwitch checked={linked}>\n              <span></span>\n            </ToggleSwitch>\n          </ToggleLabel>\n        </ToggleElement>\n        {linked && (\n          <>\n            <LinkLabel>Link Title</LinkLabel>\n            <LinkInput\n              placeholder=\"Enter Link Title\"\n              type={'text'}\n              value={linkTitle}\n              onChange={evt => setLinkTitle(evt.target.value)}\n            />\n            <LinkLabel>Link URL</LinkLabel>\n            <LinkInput\n              placeholder=\"Enter Link URL\"\n              type={'text'}\n              value={linkSrc}\n              onChange={evt => setLinkSrc(evt.target.value)}\n            />\n          </>\n        )}\n        <LinkActions>\n          <CancelLink onClick={closeImageSettings}>Cancel</CancelLink>\n          <SaveLink onClick={updateNodeAttrs}>Save</SaveLink>\n        </LinkActions>\n      </LinkPopup>\n    </StyleReset>\n  )\n}\n\nconst LinkPopup = styled.span<{\n  left: number\n  top: number\n}>`\n  background-color: #f6f6f9;\n  position: absolute;\n  border-radius: var(--tina-radius-small);\n  border: 1px solid var(--tina-color-grey-2);\n  filter: drop-shadow(0px 4px 8px rgba(48, 48, 48, 0.1))\n    drop-shadow(0px 2px 3px rgba(0, 0, 0, 0.12));\n  transform-origin: 50% 0;\n  overflow: visible;\n  padding: 12px;\n  z-index: 10;\n  width: 16rem;\n  left: ${({ left }) => `${left}px`};\n  top: ${({ top }) => `${top}px`};\n`\n\nconst LinkLabel = styled.label`\n  display: block;\n  font-size: var(--tina-font-size-1);\n  font-weight: 600;\n  letter-spacing: 0.01em;\n  color: var(--tina-color-grey-8);\n  margin-bottom: 3px;\n`\n\nconst LinkInput = styled.input`\n  position: relative;\n  background-color: white;\n  border-radius: var(--tina-radius-small);\n  font-size: var(--tina-font-size-1);\n  line-height: 1.35;\n  transition: all 85ms ease-out;\n  padding: 8px 12px;\n  border: 1px solid var(--tina-color-grey-2);\n  width: 100%;\n  margin: 0 0 8px 0;\n  outline: none;\n  box-shadow: 0 0 0 2px transparent;\n\n  &:hover {\n    box-shadow: 0 0 0 2px var(--tina-color-grey-3);\n  }\n\n  &:focus {\n    box-shadow: 0 0 0 2px var(--tina-color-primary);\n  }\n\n  &::placeholder {\n    font-size: var(--tina-font-size-2);\n    color: #cfd3d7;\n  }\n`\n\nconst LinkActions = styled.div`\n  display: flex;\n  justify-content: flex-end;\n  padding-top: 4px;\n`\n\nconst SaveLink = styled.button`\n  text-align: center;\n  border: 0;\n  border-radius: var(--tina-radius-big);\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12);\n  background-color: var(--tina-color-primary);\n  color: white;\n  font-weight: var(--tina-font-weight-regular);\n  cursor: pointer;\n  transition: all 85ms ease-out;\n  font-size: var(--tina-font-size-0);\n  padding: 8px 20px;\n  margin-left: 8px;\n  &:hover {\n    background-color: var(--tina-color-primary-light);\n  }\n  &:active {\n    background-color: var(--tina-color-primary-dark);\n  }\n`\n\nconst CancelLink = styled.button`\n  text-align: center;\n  border: 1px solid var(--tina-color-grey-2);\n  border-radius: var(--tina-radius-big);\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12);\n  background-color: white;\n  color: var(--tina-color-primary);\n  font-weight: var(--tina-font-weight-regular);\n  cursor: pointer;\n  transition: all 85ms ease-out;\n  font-size: var(--tina-font-size-0);\n  padding: 8px 20px;\n  margin-left: 8px;\n  &:hover {\n    background-color: var(--tina-color-grey-1);\n    opacity: 1;\n  }\n  &:active {\n    background-color: var(--tina-color-primary-dark);\n  }\n`\n\nconst ToggleElement = styled.div`\n  display: block;\n  position: relative;\n  margin: 0 0 0.5rem 0;\n`\n\nconst ToggleLabel = styled.label<{ disabled?: boolean }>`\n  background: none;\n  color: inherit;\n  padding: 0;\n  opacity: ${props => (props.disabled ? '0.4' : '1')};\n  outline: none;\n  height: 28px;\n  pointer-events: ${props => (props.disabled ? 'none' : 'inherit')};\n  font-size: var(--tina-font-size-1);\n  font-weight: 600;\n  letter-spacing: 0.01em;\n  line-height: 1.35;\n  color: var(--tina-color-grey-8);\n`\n\nconst ToggleSwitch = styled.div<{ checked: boolean }>`\n  position: relative;\n  width: 48px;\n  height: 28px;\n  border-radius: var(--tina-radius-big);\n  background-color: white;\n  border: 1px solid var(--tina-color-grey-2);\n  pointer-events: none;\n  margin-left: -2px;\n  span {\n    position: absolute;\n    border-radius: var(--tina-radius-big);\n    left: 2px;\n    top: 50%;\n    width: calc(28px - 6px);\n    height: calc(28px - 6px);\n    background: ${p =>\n      p.checked ? 'var(--tina-color-primary)' : 'var(--tina-color-grey-3)'};\n    transform: translate3d(${p => (p.checked ? '20px' : '0')}, -50%, 0);\n    transition: all 150ms ease-out;\n  }\n`\n\nconst ToggleInput = styled.input`\n  position: absolute;\n  left: 0;\n  top: 0;\n  width: 48px;\n  height: 28px;\n  opacity: 0;\n  margin: 0;\n  cursor: ${props => (props.disabled ? 'not-allowed' : 'pointer')};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { FunctionComponent } from 'react'\nimport ReactDOM from 'react-dom'\nimport styled from 'styled-components'\nimport { LoadingDots } from '@tinacms/react-forms'\n\nexport const Loader: FunctionComponent = () => {\n  const markerImageLoader = document.getElementsByClassName(\n    'image_loading_indicator'\n  )\n  if (!markerImageLoader.length) return null\n  const loaders = []\n  for (let i = 0; i < markerImageLoader.length; i++) {\n    loaders.push(\n      ReactDOM.createPortal(<ImagePlaceholder />, markerImageLoader[0])\n    )\n  }\n  return <>{loaders}</>\n}\n\nconst ImagePlaceholder = styled(({ ...styleProps }) => {\n  return (\n    <div {...styleProps}>\n      <LoadingDots color={'var(--tina-color-primary)'} />\n    </div>\n  )\n})`\n  display: flex;\n  width: 100%;\n  align-items: center;\n  justify-content: center;\n  padding: 64px;\n  background-color: rgba(100, 100, 100, 0.07);\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Fragment, Node } from 'prosemirror-model'\n\n/**\n * Taken from https://stackoverflow.com/questions/3809401/what-is-a-good-regular-expression-to-match-a-url\n *\n * Todo: Might be a good idea to replace this with a library that does it really well.\n *\n * @type {RegExp}\n */\nexport const IMG_REGEX = /\\.(jpe?g|png)/\n\nexport const HTTP_LINK_REGEX = /\\bhttps?:\\/\\/(www\\.)?[-a-zA-Z0-9@:%._\\+~#=]{2,256}\\.[a-z]{2,6}\\b([-a-zA-Z0-9@:;%_\\+.,~#?&//=]*)/g\n\nexport const linkify = function(fragment: Fragment): Fragment {\n  const linkified: Node[] = []\n  fragment.forEach(function(child: Node) {\n    if (child.isText) {\n      const text = child.text as string\n      let pos = 0\n      let match\n\n      const link = child.type.schema.marks['link']\n      const img = child.type.schema.nodes['image']\n      const matches: any[] = []\n\n      while ((match = HTTP_LINK_REGEX.exec(text))) {\n        const start = match.index\n        const end = start + match[0].length\n        matches.push({ start, end })\n      }\n\n      matches.forEach(({ start, end }: any) => {\n        // simply copy across the text from before the match\n        if (start > 0) {\n          linkified.push(child.cut(pos, start))\n        }\n\n        let attrs: any\n        const urlText = text.slice(start, end)\n        if (IMG_REGEX.test(urlText)) {\n          attrs = { src: urlText, title: '', alt: '' }\n          linkified.push(img.create(attrs))\n        } else {\n          attrs = { href: urlText, title: urlText }\n          linkified.push(\n            child.cut(start, end).mark(link.create(attrs).addToSet(child.marks))\n          )\n        }\n        pos = end\n      })\n\n      // copy over whatever is left\n      if (pos < text.length) {\n        linkified.push(child.cut(pos))\n      }\n    } else {\n      linkified.push(child.copy(linkify(child.content)))\n    }\n  })\n\n  return Fragment.fromArray(linkified)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Slice } from 'prosemirror-model'\nimport { Plugin, Transaction, PluginKey } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\n\nimport { linkify } from './util'\n\ninterface LinkPluginState {\n  showLinkForm: boolean\n  show_link_toolbar: boolean\n}\n\nexport const linkPluginKey = new PluginKey<LinkPluginState>('image')\n\nexport function linkPlugin(): Plugin {\n  let shiftKey: boolean\n  return new Plugin({\n    key: linkPluginKey,\n    state: {\n      init: () => {\n        return { showLinkForm: false }\n      },\n      apply(tr: Transaction, prev: LinkPluginState, _: any) {\n        if (tr.getMeta('show_link_toolbar') === false) {\n          return {\n            show_link_toolbar: false,\n          }\n        }\n\n        if (tr.getMeta('show_link_toolbar')) {\n          return {\n            show_link_toolbar: true,\n          }\n        }\n\n        return prev\n      },\n    },\n    props: {\n      transformPasted(slice: Slice): Slice {\n        if (shiftKey) {\n          return slice\n        }\n        return new Slice(linkify(slice.content), slice.openStart, slice.openEnd)\n      },\n      handleKeyDown(_x: any, e: any) {\n        shiftKey = e.shiftKey\n        return false\n      },\n      handleClickOn(view: EditorView, _1: any) {\n        const { dispatch, state } = view\n        const { tr } = state\n        dispatch(tr.setMeta('show_link_toolbar', false))\n      },\n    },\n    // TODO: Fix pls\n  } as any)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { MarkType, ResolvedPos } from 'prosemirror-model'\nimport { EditorState } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\nimport { isMarkPresent } from '../../../utils'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\ndeclare let window: any\n\nfunction markExtend($cursor: ResolvedPos, markType: MarkType) {\n  window.$cursor = $cursor\n  let startIndex = $cursor.index()\n  let endIndex = $cursor.indexAfter()\n\n  // Clicked outside edge of tag.\n  if (startIndex === $cursor.parent.childCount) {\n    startIndex--\n    endIndex--\n  }\n\n  const mark = markType.isInSet($cursor.parent.child(startIndex).marks)\n  if (!mark) return\n  // TODO: This might be a problem.\n  const hasMark = (index: number) =>\n    mark!.isInSet($cursor.parent.child(index).marks)\n\n  while (startIndex > 0 && hasMark(startIndex - 1)) {\n    startIndex--\n  }\n  while (endIndex < $cursor.parent.childCount && hasMark(endIndex)) {\n    endIndex++\n  }\n\n  let startPos = $cursor.start()\n  let endPos = startPos\n\n  for (let i = 0; i < endIndex; i++) {\n    const size = $cursor.parent.child(i).nodeSize\n    if (i < startIndex) startPos += size\n    endPos += size\n  }\n\n  return { from: startPos, to: endPos, mark }\n}\n\nexport function unmountLinkForm(view: EditorView) {\n  const { dispatch, state } = view\n  dispatch(state.tr.setMeta('show_link_toolbar', false))\n}\n\n/**\n * Finds the Link currently being edited and sets it's attributes.\n *\n * @param {EditorState} state\n * @param {(tr: Transaction) => void} dispatch\n * @param {Object} attrs\n */\nexport function updateLinkBeingEdited(\n  state: EditorState,\n  dispatch: Dispatch | null,\n  attrs: object\n) {\n  if (dispatch) {\n    const { selection, schema, tr } = state\n    const mark = markExtend(selection.$anchor, schema.marks.link)\n    if (mark) {\n      tr.addMark(mark.from, mark.to, schema.marks.link.create(attrs))\n    }\n    tr.setMeta('show_link_toolbar', false)\n    dispatch(tr)\n  }\n  return true\n}\n\nexport function removeLinkBeingEdited(\n  state: EditorState,\n  dispatch: Dispatch | null\n) {\n  if (dispatch) {\n    const { selection, schema, tr } = state\n    const mark = markExtend(selection.$anchor, schema.marks.link)\n    if (mark) {\n      tr.removeMark(mark.from, mark.to, mark.mark)\n    }\n    tr.setMeta('show_link_toolbar', false)\n    dispatch(tr)\n  }\n  return true\n}\n\nexport const openLinkPopup = (state: EditorState, dispatch: Dispatch) => {\n  const { schema, selection } = state\n  const { marks } = schema\n  if (selection.empty && !isMarkPresent(state, marks.link)) return false\n\n  const tr = state.tr.setMeta('show_link_toolbar', true)\n  if (!isMarkPresent(state, marks.link)) {\n    const { $to, $from } = selection\n    tr.addMark(\n      $from.pos,\n      $to.pos,\n      marks.link.create({\n        href: '',\n        title: '',\n      })\n    )\n  }\n  return dispatch(tr)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorView } from 'prosemirror-view'\nimport { LinkIcon } from '@tinacms/icons'\n\nimport { markControl } from '../../../components/MenuHelpers'\nimport { isMarkPresent, formatKeymap } from '../../../utils'\nimport { imagePluginKey } from '../../Image'\nimport { openLinkPopup } from '../commands'\n\nexport const ProsemirrorMenu = markControl({\n  mark: 'link',\n  Icon: LinkIcon,\n  tooltip: formatKeymap('Link Mod-K'),\n  selectionOnly: true,\n  noMix: ['code'],\n  isDisabled: (view: EditorView) => {\n    const { schema, selection } = view.state\n    const { marks, nodes } = schema\n    if (selection.empty && !isMarkPresent(view.state, marks.link)) return true\n    const selectedNode = selection.$from.node()\n    const imagePluginState = imagePluginKey.getState(view.state)\n    return (\n      !!imagePluginState?.selectedImage ||\n      (selectedNode && selectedNode.type === nodes.code_block)\n    )\n  },\n  onMenuOptionClick: (view: EditorView) => {\n    const { state, dispatch } = view\n    return openLinkPopup(state, dispatch)\n  },\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { LinkIcon } from '@tinacms/icons'\n\nimport { MenuButton } from '../../../components/MenuHelpers'\n\nexport const MarkdownMenu = () => (\n  <MenuButton data-tooltip=\"Link\" data-side=\"top\" disabled>\n    <LinkIcon />\n  </MenuButton>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport styled, { keyframes } from 'styled-components'\n\ntype E = React.ChangeEvent<HTMLInputElement>\n\ninterface Props {\n  // title: string | null\n  href: string | null\n  onChange(attrs: any): void\n  removeLink(): void\n  cancel(): void\n  style?: {\n    [key: string]: string\n  }\n}\n\ninterface State {\n  href: string | null\n  // title: string | null\n}\n\nexport class InnerForm extends React.Component<Props, State> {\n  state = {\n    href: this.props.href || '',\n    // title: this.props.title || '',\n  }\n\n  inputRef = React.createRef<HTMLInputElement>()\n\n  componentDidMount() {\n    document.addEventListener('keydown', this.onEscapeCancel)\n    if (this.inputRef.current) this.inputRef.current.focus()\n  }\n\n  componentWillUnmount() {\n    document.removeEventListener('keydown', this.onEscapeCancel)\n  }\n\n  componentDidUpdate(prevProps: Props) {\n    const { href } = this.props\n    if (href !== prevProps.href) this.setState(() => ({ href }))\n  }\n\n  closeModal() {\n    const { href } = this.state\n    const { cancel, removeLink, href: originalHref } = this.props\n    if (!href && !originalHref) removeLink()\n    cancel()\n  }\n\n  setHref = ({ target: { value } }: E) => this.setState(() => ({ href: value }))\n  // setTitle = ({ target: { value } }: E) =>\n  //   this.setState(() => ({ title: value }))\n\n  save = () => this.props.onChange(this.state)\n\n  onEnterSave = (e: KeyboardEvent) => {\n    if (e.key === 'Enter') {\n      this.save()\n    }\n  }\n\n  onEscapeCancel = (e: KeyboardEvent) => {\n    if (e.keyCode === 27) {\n      this.closeModal()\n    }\n  }\n\n  render() {\n    const { removeLink, style = {} } = this.props\n    const { href } = this.state\n    return (\n      <LinkPopup\n        style={{\n          ...style,\n        }}\n      >\n        {/*<LinkLabel>Title</LinkLabel>\n         <LinkInput\n          placeholder=\"Enter Title\"\n          type={'text'}\n          value={title}\n          onChange={this.setTitle}\n          onKeyPress={this.onEnterSave as any}\n        /> */}\n        <LinkLabel>URL</LinkLabel>\n        <LinkInput\n          ref={this.inputRef}\n          placeholder=\"Enter URL\"\n          type={'text'}\n          value={href}\n          onChange={this.setHref}\n          onKeyPress={this.onEnterSave as any}\n        />\n        <LinkActions>\n          <DeleteLink onClick={removeLink}>Delete</DeleteLink>\n          <SaveLink onClick={this.save} disabled={!href}>\n            Save\n          </SaveLink>\n        </LinkActions>\n      </LinkPopup>\n    )\n  }\n}\n\nconst LinkPopupKeyframes = keyframes`\n  0% {\n    transform: scale3d(0.5,0.5,1)\n  }\n  100% {\n    transform: scale3d(1, 1, 1);\n  }\n`\n\nconst LinkPopup = styled.div`\n  background-color: #f6f6f9;\n  position: relative;\n  height: max-content;\n  border-radius: var(--tina-radius-small);\n  border: 1px solid var(--tina-color-grey-2);\n  filter: drop-shadow(0px 4px 8px rgba(48, 48, 48, 0.1))\n    drop-shadow(0px 2px 3px rgba(0, 0, 0, 0.12));\n  transform-origin: 50% 0;\n  animation: ${LinkPopupKeyframes} 85ms ease-out both 1;\n  overflow: visible;\n  padding: 12px;\n  z-index: 10;\n`\n\nconst LinkLabel = styled.label`\n  display: block;\n  font-size: var(--tina-font-size-1);\n  font-weight: 600;\n  letter-spacing: 0.01em;\n  color: var(--tina-color-grey-8);\n  margin-bottom: 3px;\n`\n\nconst LinkInput = styled.input`\n  position: relative;\n  background-color: white;\n  border-radius: var(--tina-radius-small);\n  font-size: var(--tina-font-size-1);\n  line-height: 1.35;\n  transition: all 85ms ease-out;\n  padding: 8px 12px;\n  border: 1px solid var(--tina-color-grey-2);\n  width: 100%;\n  margin: 0 0 8px 0;\n  outline: none;\n  box-shadow: 0 0 0 2px transparent;\n\n  &:hover {\n    box-shadow: 0 0 0 2px var(--tina-color-grey-3);\n  }\n\n  &:focus {\n    box-shadow: 0 0 0 2px #0084ff;\n  }\n\n  &::placeholder {\n    font-size: var(--tina-font-size-2);\n    color: #cfd3d7;\n  }\n`\n\nconst LinkActions = styled.div`\n  display: flex;\n  justify-content: flex-end;\n  padding-top: 4px;\n`\n\nconst SaveLink = styled.button`\n  text-align: center;\n  border: 0;\n  border-radius: var(--tina-radius-big);\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12);\n  background-color: #0084ff;\n  color: white;\n  font-weight: var(--tina-font-weight-regular);\n  cursor: pointer;\n  transition: all 85ms ease-out;\n  font-size: var(--tina-font-size-0);\n  padding: 8px 20px;\n  margin-left: 8px;\n  &:hover {\n    background-color: #2296fe;\n  }\n  &:active {\n    background-color: #0574e4;\n  }\n  &:disabled {\n    background-color: #d1d1d1;\n    box-shadow: none;\n  }\n`\n\nconst DeleteLink = styled.button`\n  text-align: center;\n  border: 1px solid var(--tina-color-grey-2);\n  border-radius: var(--tina-radius-big);\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12);\n  background-color: white;\n  color: #0084ff;\n  font-weight: var(--tina-font-weight-regular);\n  cursor: pointer;\n  transition: all 85ms ease-out;\n  font-size: var(--tina-font-size-0);\n  padding: 8px 20px;\n  margin-left: 8px;\n  &:hover {\n    background-color: #f6f6f9;\n    opacity: 1;\n  }\n  &:active {\n    background-color: #0574e4;\n  }\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { createRef, useState, useEffect } from 'react'\nimport styled from 'styled-components'\nimport { StyleReset } from '@tinacms/styles'\n\nimport { useEditorStateContext } from '../../../context/editorState'\nimport {\n  findElementOffsetTop,\n  findElementOffsetLeft,\n  getMarkPresent,\n} from '../../../utils'\nimport {\n  removeLinkBeingEdited,\n  unmountLinkForm,\n  updateLinkBeingEdited,\n} from '../commands'\nimport { linkPluginKey } from '../plugin'\nimport { InnerForm } from './InnerForm'\n\nconst width = 240\n\nexport const LinkForm = () => {\n  const { editorView } = useEditorStateContext()\n  const [position, setPosition] = useState<any>(undefined)\n\n  if (!editorView) return null\n  const { view } = editorView\n  const linkPluginState = linkPluginKey.getState(view.state)\n  const { anchor, head } = view.state.selection\n  const selState = anchor < head ? anchor : head\n  const node = view.state.selection.empty\n    ? view.domAtPos(selState).node\n    : view.domAtPos(selState + 1).node\n  const clickTarget = node.parentNode as HTMLElement\n\n  const onChange = (attrs: any) => {\n    updateLinkBeingEdited(view.state, view.dispatch, attrs)\n    view.focus()\n  }\n\n  const onCancel = () => {\n    unmountLinkForm(view)\n    view.focus()\n  }\n\n  const wrapperRef = createRef<any>()\n\n  // eslint-disable-next-line react-hooks/rules-of-hooks\n  useEffect(() => {\n    if (!clickTarget || !wrapperRef.current) {\n      setPosition(undefined)\n      return\n    }\n    const left = calcLeftOffset(clickTarget!, wrapperRef.current, width)\n    const top = `calc(32px + ${findElementOffsetTop(clickTarget) -\n      findElementOffsetTop(wrapperRef.current)}px)`\n    const arrowOffset = calcArrowLeftOffset(\n      clickTarget,\n      wrapperRef.current,\n      width\n    )\n    setPosition({ arrowOffset, left, top })\n  }, [linkPluginState])\n\n  if (!linkPluginState!.show_link_toolbar) {\n    return null\n  }\n\n  const { arrowOffset, left, top } = position || {}\n  const { state, dispatch } = view\n  let href = ''\n  // let title = ''\n  const linkMark = getMarkPresent(state, state.schema.marks.link)\n  if (linkMark) {\n    href = linkMark.attrs.href\n    // title = linkMark.attrs.title\n  }\n\n  return (\n    <div ref={wrapperRef} style={{ position: 'absolute' }}>\n      {position && (\n        <StyleReset>\n          <LinkFormWrapper>\n            <LinkArrow offset={arrowOffset} top={top}></LinkArrow>\n            <InnerForm\n              style={{\n                left,\n                top,\n                width: `${width}px`,\n              }}\n              removeLink={() => removeLinkBeingEdited(state, dispatch)}\n              onChange={onChange}\n              href={href}\n              // title={title}\n              cancel={onCancel}\n            />\n          </LinkFormWrapper>\n        </StyleReset>\n      )}\n    </div>\n  )\n}\n\nconst LinkFormWrapper = styled.div`\n  position: relative;\n`\n\nconst LinkArrow = styled.div<{ offset: string; top: string }>`\n  position: absolute;\n  top: ${p => p.top};\n  left: ${p => p.offset};\n  margin-top: 3px;\n  transform: translate3d(-50%, -100%, 0);\n  width: 16px;\n  height: 13px;\n  clip-path: polygon(50% 0%, 0% 100%, 100% 100%);\n  background-color: #f6f6f9;\n  z-index: 100;\n`\n\n/**\n * Calculates the leftOffset of the form.\n *\n * It centers the form on the link, unless the form would\n * show up outside of the window, in which case the offset is the edge\n * of the editor.\n *\n * @param {HTMLElement} clickTarget\n * @param {HTMLElement} renderTarget\n * @param {number} minWidth\n * @returns {string}\n */\nfunction calcLeftOffset(\n  clickTarget: HTMLElement,\n  renderTarget: HTMLElement,\n  minWidth: number\n) {\n  const ow_ct = clickTarget.offsetWidth\n  const ol_ct = findElementOffsetLeft(clickTarget)\n  const ow_rt = renderTarget.parentElement!.offsetWidth\n  const ol_rt = findElementOffsetLeft(renderTarget)\n  const ol = ol_ct - ol_rt + ow_ct / 2 - minWidth / 2\n\n  const leftEdgeOutsideView = ol < -ol_rt\n  if (leftEdgeOutsideView) {\n    return `-8px`\n  }\n\n  const rightEdgeOutsideView = ol + minWidth > ow_rt\n  if (rightEdgeOutsideView) {\n    return `calc(${ol - (ol + minWidth - ow_rt)}px + 8px)`\n  }\n\n  return `${ol}px`\n}\n\nfunction calcArrowLeftOffset(\n  clickTarget: HTMLElement,\n  renderTarget: HTMLElement,\n  _minWidth: number\n) {\n  const ow_ct = clickTarget.offsetWidth\n  const ol_ct = findElementOffsetLeft(clickTarget)\n  const ol_rt = findElementOffsetLeft(renderTarget)\n  const ol = ol_ct - ol_rt + ow_ct / 2\n  return `${ol}px`\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport styled, { css } from 'styled-components'\n\ntype MenuPlaceholderProps = {\n  menuBoundingBox: any\n}\n\nexport const MenuPlaceholder = styled.div<MenuPlaceholderProps>`\n  color: transparent;\n  background: transparent;\n  pointer-events: none;\n  position: relative;\n  display: block;\n  height: ${props => props.menuBoundingBox.height}px;\n  width: ${props => props.menuBoundingBox.width}px;\n`\n\ntype MenuWrapperProps = {\n  menuFixed: boolean\n  menuBoundingBox: any\n  menuFixedTopOffset: string\n}\n\nexport const MenuWrapper = styled.div<MenuWrapperProps>`\n  position: relative;\n  margin-bottom: 14px;\n  z-index: var(--tina-z-index-1);\n\n  ${props =>\n    props.menuFixed &&\n    css`\n      position: fixed;\n      width: ${props.menuBoundingBox.width}px;\n      top: ${props.menuFixedTopOffset};\n    `};\n`\n\nexport const MenuContainer = styled.div`\n  display: flex;\n  flex-direction: row;\n  justify-content: flex-start;\n  flex-wrap: wrap;\n  justify-content: space-between;\n  position: relative;\n  top: 0;\n  width: 100%;\n  background-color: white;\n  border-radius: var(--tina-radius-small);\n  box-shadow: 0px 2px 3px rgba(0, 0, 0, 0.12);\n  border: 1px solid var(--tina-color-grey-2);\n  overflow: hidden;\n  z-index: var(--tina-z-index-0);\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { ReactElement } from 'react'\nimport { useState, useRef, useEffect, useLayoutEffect } from 'react'\n\nimport { useEditorStateContext } from '../../context/editorState'\nimport { useEditorModeContext } from '../../context/editorMode'\nimport { MenuPortalProvider } from '../../context/MenuPortal'\nimport { Plugin } from '../../types'\n\nimport {\n  MenuPlaceholder,\n  MenuWrapper,\n  MenuContainer,\n} from '../MenuHelpers/styledComponents'\n\ninterface Props {\n  sticky?: boolean | string\n  menus?: ReactElement[]\n  plugins?: Plugin[]\n  popups?: ReactElement[]\n}\n\nexport const BaseMenubar = ({\n  sticky = true,\n  menus,\n  plugins,\n  popups,\n}: Props) => {\n  const [menuFixed, setMenuFixed] = useState(false)\n  const isBrowser = typeof window !== `undefined`\n  const menuRef = useRef<HTMLDivElement>(null)\n  const [menuBoundingBox, setMenuBoundingBox] = useState<any>(null)\n  const menuFixedTopOffset = typeof sticky === 'string' ? sticky : '0'\n  const { editorView } = useEditorStateContext()\n  const { mode } = useEditorModeContext()\n\n  useEffect(() => {\n    if (menuRef.current && sticky) {\n      setMenuBoundingBox(menuRef.current.getBoundingClientRect())\n    }\n    // todo: cleanup use of editor view here\n  }, [menuRef, editorView, mode])\n\n  useLayoutEffect(() => {\n    if (!isBrowser || !menuRef.current || !sticky) {\n      return\n    }\n\n    const handleScroll = () => {\n      const wysiwygWrapper = menuRef.current!.parentElement\n      const startPosition = wysiwygWrapper ? wysiwygWrapper.offsetTop : 0\n      const endPosition = wysiwygWrapper\n        ? startPosition + wysiwygWrapper.offsetHeight\n        : 0\n\n      if (window.scrollY > startPosition && window.scrollY < endPosition) {\n        setMenuFixed(true)\n      } else {\n        setMenuFixed(false)\n      }\n    }\n\n    const handleResize = () => {\n      if (menuRef.current) {\n        const wasMenuFixed = menuFixed\n        setMenuFixed(false)\n        setMenuBoundingBox(menuRef.current.getBoundingClientRect())\n        setMenuFixed(wasMenuFixed)\n      }\n    }\n\n    handleScroll()\n    window.addEventListener('scroll', handleScroll)\n    window.addEventListener('resize', handleResize)\n\n    return () => {\n      window.removeEventListener('scroll', handleScroll)\n      window.removeEventListener('resize', handleResize)\n    }\n  }, [menuRef, menuBoundingBox])\n\n  const preventProsemirrorFocusLoss = React.useCallback((e: any) => {\n    e.stopPropagation()\n    e.preventDefault()\n  }, [])\n\n  return (\n    <>\n      {menuFixed && (\n        <MenuPlaceholder menuBoundingBox={menuBoundingBox}></MenuPlaceholder>\n      )}\n      <MenuWrapper\n        menuFixedTopOffset={menuFixedTopOffset}\n        menuFixed={menuFixed}\n        menuBoundingBox={menuBoundingBox}\n        ref={menuRef}\n        data-testid=\"base-menubar\"\n      >\n        <MenuPortalProvider>\n          <MenuContainer onMouseDown={preventProsemirrorFocusLoss}>\n            {menus}\n            {plugins?.map(({ MenuItem }) => (\n              <MenuItem mode={mode} editorView={editorView} />\n            ))}\n          </MenuContainer>\n        </MenuPortalProvider>\n      </MenuWrapper>\n      {popups}\n    </>\n  )\n}\n\n// todo: sub-menus to return null if schema does not have related type of node / mark.\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\n\nimport { MarkdownMenu as BlockMenu } from '../../../plugins/Block'\nimport { MarkdownMenu as CodeBlockMenu } from '../../../plugins/CodeBlock'\nimport { MarkdownMenu as HistoryMenu } from '../../../plugins/History'\nimport { MarkdownMenu as InlineMenu } from '../../../plugins/Inline'\nimport { MarkdownMenu as ListMenu } from '../../../plugins/List'\nimport { MarkdownMenu as QuoteMenu } from '../../../plugins/Blockquote'\nimport { MarkdownMenu as TableMenu } from '../../../plugins/Table'\nimport { MarkdownMenu as ImageMenu } from '../../../plugins/Image'\nimport { MarkdownMenu as LinkMenu } from '../../../plugins/Link'\n\nimport { Plugin } from '../../../types'\nimport { BaseMenubar } from '../../BaseMenubar'\n\ninterface Props {\n  sticky?: boolean | string\n  uploadImages?: (files: File[]) => Promise<string[]>\n  plugins?: Plugin[]\n}\n\nexport const Menubar = ({ plugins, uploadImages, ...rest }: Props) => (\n  <BaseMenubar\n    {...rest}\n    menus={[\n      <BlockMenu />,\n      <InlineMenu />,\n      <LinkMenu />,\n      <ImageMenu uploadImages={uploadImages} />,\n      <TableMenu />,\n      <QuoteMenu />,\n      <CodeBlockMenu />,\n      <ListMenu />,\n      <HistoryMenu />,\n    ]}\n    plugins={plugins}\n  />\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useEffect, useRef, useState } from 'react'\nimport styled from 'styled-components'\n\nimport { useBrowserFocusContext } from '../../context/browserFocus'\nimport { ImageProps, Plugin } from '../../types'\nimport { Menubar } from './Menubar'\n\nexport interface MarkdownEditorProps {\n  imageProps?: ImageProps\n  onChange: (value: string) => void\n  value: string\n  plugins?: Plugin[]\n  sticky?: boolean | string\n}\n\nconst inputLineHeight = 20\n\nexport const MarkdownEditor = ({\n  imageProps,\n  onChange,\n  value,\n  plugins,\n  sticky,\n}: MarkdownEditorProps) => {\n  const inputRef = useRef<HTMLTextAreaElement>(null)\n  const [val, setVal] = useState(value)\n  const { browserFocused } = useBrowserFocusContext()\n\n  // Code below put focus to end of content in text area as component is mounted.\n  useEffect(() => {\n    const inputElm = inputRef.current\n    if (!inputElm) return\n    inputElm.focus({ preventScroll: true })\n    inputElm.setSelectionRange(inputElm.value.length, inputElm.value.length)\n  }, [])\n\n  // Code below resize textarea to its content\n  useEffect(() => {\n    const inputElm = inputRef.current\n    if (!inputElm) return\n    inputElm.style.height = '0'\n    inputElm.style.height = inputElm.scrollHeight + inputLineHeight + 'px'\n  })\n\n  // Code below update component content if new value is received when editor is not focused.\n  useEffect(() => {\n    const editorElementFocused = inputRef.current === document.activeElement\n    if (browserFocused && editorElementFocused) return\n    setVal(value)\n  }, [value])\n\n  return (\n    <>\n      <Menubar\n        sticky={sticky}\n        uploadImages={imageProps?.upload}\n        plugins={plugins}\n      />\n      <EditingSection\n        data-testid=\"markdown-editing-textarea\"\n        ref={inputRef}\n        value={val}\n        onChange={evt => {\n          const v = evt.target.value\n          setVal(v)\n          onChange(v)\n        }}\n        onFocus={e => {\n          e.preventDefault()\n          e.target.focus({ preventScroll: true })\n        }}\n      />\n    </>\n  )\n}\n\nconst EditingSection = styled.textarea`\n  border: none;\n  font-family: monospace;\n  font-size: 16px;\n  margin: 10px 0;\n  resize: none;\n  width: 100%;\n  &:focus {\n    outline: none;\n  }\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport function domAttrs(attrs: any) {\n  const domAttrs: any = {}\n  for (const key in attrs) {\n    if (attrs[key]) {\n      domAttrs[`forestry-${key}`] = attrs[key]\n    }\n  }\n  return domAttrs\n}\n\nexport function docAttrs(attrs: any) {\n  const domAttrs: any = {}\n  for (const key in attrs) {\n    if (attrs[key]) {\n      domAttrs[key] = attrs[key]\n    }\n  }\n  return domAttrs\n}\n\nexport function getAttrsWith(attrs: object) {\n  return function(dom: HTMLElement) {\n    return {\n      ...attrs,\n      ...getAttrs(dom),\n    }\n  }\n}\n\nexport function getAttrs(dom: HTMLElement) {\n  const attrs: any = {}\n  const attributes = dom.attributes\n  for (let i = 0; i < attributes.length; i++) {\n    const attribute = attributes[i]\n    if (attribute.value) {\n      const name = attribute.name.startsWith('forestry-')\n        ? attribute.name.slice(9)\n        : attribute.name\n\n      attrs[name] = attribute.value\n    }\n  }\n  return attrs\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\nimport { getAttrsWith, docAttrs, domAttrs } from './utils'\n\nexport const heading = {\n  attrs: {\n    level: { default: 1 },\n    class: { default: '' },\n    id: { default: '' },\n  },\n  content: 'inline*',\n  marks: '_',\n  group: 'block',\n  defining: true,\n  parseDOM: [\n    { tag: 'h1', getAttrs: getAttrsWith({ level: 1 }) },\n    { tag: 'h2', getAttrs: getAttrsWith({ level: 2 }) },\n    { tag: 'h3', getAttrs: getAttrsWith({ level: 3 }) },\n    { tag: 'h4', getAttrs: getAttrsWith({ level: 4 }) },\n    { tag: 'h5', getAttrs: getAttrsWith({ level: 5 }) },\n    { tag: 'h6', getAttrs: getAttrsWith({ level: 6 }) },\n  ],\n  toDocument(node: Node) {\n    const { level, ...other } = node.attrs\n    return ['h' + level, docAttrs(other), 0]\n  },\n  toDOM(node: Node) {\n    const { level, ...other } = node.attrs\n    return ['h' + level, domAttrs(other), 0]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport const image = {\n  inline: true,\n  attrs: {\n    src: {},\n    align: { default: null },\n    alt: { default: null },\n    title: { default: null },\n    width: { default: null },\n    height: { default: null },\n  },\n  group: 'inline',\n  draggable: true,\n  allowGapCursor: true,\n  parseDOM: [\n    {\n      tag: 'img[src]',\n      getAttrs(dom: HTMLElement) {\n        return {\n          src: dom.getAttribute('src'),\n          title: dom.getAttribute('title'),\n          alt: dom.getAttribute('alt'),\n          align: getAlignFromDOM(dom),\n          width: dom.getAttribute('width'),\n          height: dom.getAttribute('height'),\n        }\n      },\n    },\n  ],\n  toDOM(node: Node) {\n    const attrs: any = {\n      src: node.attrs.src,\n    }\n\n    if (node.attrs.title) attrs.title = node.attrs.title\n    if (node.attrs.alt) attrs.alt = node.attrs.alt\n    if (node.attrs.width) attrs.width = node.attrs.width\n    if (node.attrs.height) attrs.height = node.attrs.height\n    if (node.attrs.align) attrs['class'] = `align-${node.attrs.align}`\n\n    return ['img', attrs]\n  },\n}\n\nconst alignRegex = /align-([a-z]*)/\n\nexport function getAlignFromDOM(image: HTMLElement) {\n  const className = image.getAttribute('class') || ''\n\n  const match = alignRegex.exec(className)\n\n  if (match && match.length > 1) {\n    return match[1]\n  }\n\n  return null\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const list_item = {\n  content: 'paragraph block*',\n  defining: true,\n  parseDOM: [{ tag: 'li' }],\n  toDOM() {\n    return ['li', 0]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\nimport { docAttrs, getAttrs, domAttrs } from './utils'\n\nexport const paragraph = {\n  content: 'inline*',\n  marks: '_',\n  attrs: {\n    class: { default: '' },\n    id: { default: '' },\n  },\n  group: 'block',\n  parseDOM: [{ tag: 'p', getAttrs }],\n  toDocument(node: Node) {\n    return ['p', docAttrs(node.attrs), 0]\n  },\n  toDOM(node: Node) {\n    return ['p', domAttrs(node.attrs), 0]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { tableNodes } from 'prosemirror-tables'\nimport { Node } from 'prosemirror-model'\n\nconst tables = tableNodes({\n  tableGroup: 'block',\n  cellContent: 'inline*',\n  cellAttributes: {},\n})\n\ntables.table_cell = {\n  ...tables.table_cell,\n  marks: '_',\n  attrs: { ...tables.table_cell.attrs, align: { default: null } },\n  toDOM(node: Node) {\n    const attrs: { style?: string } = {}\n    if (node.attrs.align) {\n      attrs.style = `text-align: ${node.attrs.align};`\n    }\n    return ['td', attrs, 0]\n  },\n} as any\n\ntables.table_header = {\n  ...tables.table_header,\n  marks: '_',\n  attrs: { ...tables.table_header.attrs, align: { default: null } },\n  toDOM(node: Node) {\n    const attrs: { style?: string } = {}\n    if (node.attrs.align) {\n      attrs.style = `text-align: ${node.attrs.align};`\n    }\n    return ['th', attrs, 0]\n  },\n} as any\n\nexport { tables }\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Schema } from 'prosemirror-model'\n\nimport { code } from './marks/code'\nimport { em } from './marks/em'\nimport { link } from './marks/link'\nimport { strike } from './marks/strike'\nimport { strong } from './marks/strong'\n\nimport { doc } from './nodes/doc'\nimport { blockquote } from './nodes/blockquote'\nimport { bullet_list } from './nodes/list-bullet'\nimport { code_block } from './nodes/code-block'\nimport { hard_break } from './nodes/hard-break'\nimport { heading } from './nodes/heading'\nimport { horizontal_rule } from './nodes/hr'\nimport { image } from './nodes/image'\nimport { list_item } from './nodes/list-item'\nimport { ordered_list } from './nodes/list-ordered'\nimport { paragraph } from './nodes/paragraph'\nimport { text } from './nodes/text'\nimport { tables } from './nodes/tables'\n\nexport const marks = { code, em, link, strike, strong }\n\nexport const nodes = {\n  doc,\n  paragraph,\n  blockquote,\n  bullet_list,\n  code_block,\n  hard_break,\n  heading,\n  horizontal_rule,\n  image,\n  list_item,\n  ordered_list,\n  text,\n  ...tables,\n}\n\nexport const buildSchema = () => {\n  return new Schema({\n    nodes,\n    marks,\n  } as any)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const code = {\n  parseDOM: [{ tag: 'code' }],\n  toDOM() {\n    return ['code']\n  },\n  excludes: 'em strong strike',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const em = {\n  parseDOM: [\n    { tag: 'i' },\n    { tag: 'em' },\n    {\n      style: 'font-style',\n      getAttrs: (value: string): null | boolean => value === 'italic' && null,\n    },\n  ],\n  toDOM() {\n    return ['em']\n  },\n  excludes: 'code',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport const link = {\n  attrs: {\n    href: {},\n    title: { default: null as any },\n  },\n  inclusive: false,\n  parseDOM: [\n    {\n      tag: 'a[href]',\n      getAttrs(dom: HTMLElement) {\n        return {\n          href: dom.getAttribute('href'),\n          title: dom.getAttribute('title'),\n        }\n      },\n    },\n  ],\n  toDOM(node: Node) {\n    return ['a', node.attrs]\n  },\n  toDocument(node: Node) {\n    return ['a', node.attrs]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n/**\n * strikethrough\n */\nexport const strike = {\n  parseDOM: [\n    { tag: 'strike' },\n    { tag: 's' },\n    { tag: 'del' },\n    {\n      style: 'text-decoration',\n      getAttrs: (value: string) => value === 'line-through' && null,\n    },\n  ],\n  toDOM: () => ['s', 0],\n  excludes: 'code',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const strong = {\n  parseDOM: [\n    { tag: 'strong' },\n    // This works around a Google Docs misbehavior where\n    // pasted content will be inexplicably wrapped in `<b>`\n    // tags with a font-weight normal.\n    {\n      tag: 'b',\n      getAttrs: (node: HTMLElement) => {\n        return node.style.fontWeight != 'normal' && null\n      },\n    },\n    {\n      style: 'font-weight',\n      getAttrs: (value: string) => {\n        return /^(bold(er)?|[5-9]\\d{2,})$/.test(value) && null\n      },\n    },\n  ],\n  toDOM() {\n    return ['strong']\n  },\n  excludes: 'code',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const doc = {\n  content: 'block+',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const blockquote = {\n  content: 'block+',\n  group: 'block',\n  defining: true,\n  parseDOM: [{ tag: 'blockquote' }],\n  toDOM() {\n    return ['blockquote', 0]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport const bullet_list = {\n  content: 'list_item+',\n  group: 'block',\n  attrs: { tight: { default: false } },\n  parseDOM: [\n    {\n      tag: 'ul',\n      getAttrs: (dom: Element) => ({ tight: dom.hasAttribute('data-tight') }),\n    },\n  ],\n  toDOM(node: Node) {\n    return ['ul', { 'data-tight': node.attrs.tight ? 'true' : null }, 0]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport const code_block = {\n  content: 'text*',\n  attrs: { params: { default: '' } },\n  group: 'block',\n  code: true,\n  defining: true,\n  parseDOM: [\n    {\n      tag: 'pre',\n      preserveWhitespace: 'full',\n      getAttrs: (dom: Element) => ({\n        params: dom.getAttribute('data-params'),\n      }),\n    },\n  ],\n  toDOM(node: Node) {\n    return ['pre', { 'data-params': node.attrs.params }, ['code', 0]]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const hard_break = {\n  inline: true,\n  group: 'inline',\n  selectable: false,\n  parseDOM: [{ tag: 'br' }],\n  toDOM() {\n    return ['br']\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const horizontal_rule = {\n  group: 'block',\n  allowGapCursor: true,\n  parseDOM: [{ tag: 'hr' }],\n  toDOM() {\n    return ['hr']\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport const ordered_list = {\n  content: 'list_item+',\n  group: 'block',\n  attrs: { order: { default: 1 }, tight: { default: false } },\n  parseDOM: [\n    {\n      tag: 'ol',\n      getAttrs(dom: Element) {\n        return {\n          order: dom.hasAttribute('start')\n            ? +(dom.getAttribute('start') || 0)\n            : 1,\n          tight: dom.hasAttribute('data-tight'),\n        }\n      },\n    },\n  ],\n  toDOM(node: Node) {\n    return [\n      'ol',\n      {\n        start: node.attrs.order == 1 ? null : node.attrs.order,\n        'data-tight': node.attrs.tight ? 'true' : null,\n      },\n      0,\n    ]\n  },\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport const text = {\n  group: 'inline',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Node } from 'prosemirror-model'\n\nexport abstract class TranslatorClass {\n  abstract nodeFromString(content: string): Node | null\n  abstract stringFromNode(node: Node): string\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n// ::- A specification for serializing a ProseMirror document as\n// Markdown/CommonMark text.\nimport { Mark, Node } from 'prosemirror-model'\n\ninterface Hash<T> {\n  [key: string]: T\n}\n\ninterface MarkSerializer {\n  open:\n    | string\n    | ((state: MarkdownSerializerState, mark: any, node: Node | null) => string)\n  close:\n    | string\n    | ((state: MarkdownSerializerState, mark: any, node: Node | null) => string)\n  mixable?: boolean\n  expelEnclosingWhitespace?: boolean\n}\n\nexport interface Nodes {\n  [key: string]: (\n    state: MarkdownSerializerState,\n    node: Node,\n    parent?: Node,\n    index?: number,\n    escFn?: (str: string) => string\n  ) => void\n}\n\nexport class MarkdownSerializer {\n  // :: (Object<(state: MarkdownSerializerState, node: Node, parent: Node, index: number)>, Object)\n\n  // Construct a serializer with the given configuration. The `nodes`\n  // object should map node names in a given schema to function that\n  // take a serializer state and such a node, and serialize the node.\n  //\n  // The `marks` object should hold objects with `open` and `close`\n  // properties, which hold the strings that should appear before and\n  // after a piece of text marked that way, either directly or as a\n  // function that takes a serializer state and a mark, and returns a\n  // string.\n  //\n  // Mark information objects can also have a `mixable` property\n  // which, when `true`, indicates that the order in which the mark's\n  // opening and closing syntax appears relative to other mixable\n  // marks can be varied. (For example, you can say `**a *b***` and\n  // `*a **b***`, but not `` `a *b*` ``.)\n  //\n  // The `expelEnclosingWhitespace` mark property causes the\n  // serializer to move enclosing whitespace from inside the marks to\n  // outside the marks. This is necessary for emphasis marks as\n  // CommonMark does not permit enclosing whitespace inside emphasis\n  // marks, see: http://spec.commonmark.org/0.26/#example-330\n  nodes: Nodes\n  marks: Hash<MarkSerializer>\n  constructor(nodes: Nodes, marks: Hash<MarkSerializer>) {\n    // :: Object<(MarkdownSerializerState, Node)> The node serializer\n    // functions for this serializer.\n    this.nodes = nodes\n    // :: Object The mark serializer info.\n    this.marks = marks\n  }\n\n  // :: (Node, ?Object)  string\n  // Serialize the content of the given node to\n  // [CommonMark](http://commonmark.org/).\n  serialize(content: Node, options: object = {}) {\n    const state = new MarkdownSerializerState(this.nodes, this.marks, options)\n    state.renderContent(content)\n    return state.out\n  }\n}\n\ninterface MarkdownSerializerStateOptions {\n  tightLists?: boolean\n}\n\n// ::- This is an object used to track state and expose\n// methods related to markdown serialization. Instances are passed to\n// node and mark serialization methods (see `toMarkdown`).\nexport class MarkdownSerializerState {\n  nodes: Nodes\n  marks: Hash<MarkSerializer>\n  out: string\n  delim: string\n  closed: false | Node\n  inTightList: boolean\n  options: MarkdownSerializerStateOptions\n\n  constructor(\n    nodes: Nodes,\n    marks: Hash<MarkSerializer>,\n    options: MarkdownSerializerStateOptions\n  ) {\n    this.nodes = nodes\n    this.marks = marks\n    this.delim = this.out = ''\n    this.closed = false\n    this.inTightList = false\n    // :: Object\n    // The options passed to the serializer.\n    //   tightLists:: ?bool\n    //   Whether to render lists in a tight style. This can be overridden\n    //   on a node level by specifying a tight attribute on the node.\n    //   Defaults to false.\n    this.options = options || {}\n    if (typeof this.options.tightLists == 'undefined')\n      this.options.tightLists = false\n  }\n\n  flushClose(size?: number) {\n    if (this.closed) {\n      if (!this.atBlank()) this.out += '\\n'\n      if (size == null) size = 2\n      if (size > 1) {\n        let delimMin = this.delim\n        const trim = /\\s+$/.exec(delimMin)\n        if (trim) delimMin = delimMin.slice(0, delimMin.length - trim[0].length)\n        for (let i = 1; i < size; i++) this.out += delimMin + '\\n'\n      }\n      this.closed = false\n    }\n  }\n\n  // :: (string, ?string, Node, ())\n  // Render a block, prefixing each line with `delim`, and the first\n  // line in `firstDelim`. `node` should be the node that is closed at\n  // the end of the block, and `f` is a function that renders the\n  // content of the block.\n  wrapBlock(delim: string, firstDelim: string | null, node: Node, f: Function) {\n    const old = this.delim\n    this.write(firstDelim || delim)\n    this.delim += delim\n    f()\n    this.delim = old\n    this.closeBlock(node)\n  }\n\n  atBlank() {\n    return /(^|\\n)$/.test(this.out)\n  }\n\n  // :: ()\n  // Ensure the current content ends with a newline.\n  ensureNewLine() {\n    if (!this.atBlank()) this.out += '\\n'\n  }\n\n  // :: (?string)\n  // Prepare the state for writing output (closing closed paragraphs,\n  // adding delimiters, and so on), and then optionally add content\n  // (unescaped) to the output.\n  write(content?: string) {\n    this.flushClose()\n    if (this.delim && this.atBlank()) this.out += this.delim\n    if (content) this.out += content\n  }\n\n  // :: (Node)\n  // Close the block for the given node.\n  closeBlock(node: Node) {\n    this.closed = node\n  }\n\n  // :: (string, ?bool)\n  // Add the given text to the document. When escape is not `false`,\n  // it will be escaped.\n  text(text: string, escape?: boolean, escFn?: (str: string) => string) {\n    const lines = text.split('\\n')\n    for (let i = 0; i < lines.length; i++) {\n      const startOfLine = this.atBlank() || this.closed\n      this.write()\n      let escapedString =\n        escape !== false ? this.esc(lines[i], startOfLine) : lines[i]\n      escapedString = escFn ? escFn(escapedString) : escapedString\n      this.out += escapedString\n      if (i != lines.length - 1) this.out += '\\n'\n    }\n  }\n\n  // :: (Node)\n  // Render the given node as a block.\n  render(\n    node: Node,\n    parent: Node | number,\n    index: number,\n    escFn?: (str: string) => string\n  ) {\n    if (typeof parent == 'number') throw new Error('!')\n    this.nodes[node.type.name](this, node, parent, index, escFn)\n  }\n\n  // :: (Node)\n  // Render the contents of `parent` as block nodes.\n  renderContent(parent: Node) {\n    parent.forEach((node, _, i) => this.render(node, parent, i))\n  }\n\n  // :: (Node)\n  // Render the contents of `parent` as inline content.\n  renderInline(parent: Node, escFn?: (str: string) => string) {\n    const active: any[] = []\n    let trailing = ''\n    const progress = (node: Node | null, _?: any, index: number = 0) => {\n      let marks = node ? node.marks : []\n\n      const indexOfCode = marks.findIndex(p => p.type.name === 'code')\n      if (indexOfCode >= 0 && marks.length > 1) {\n        marks = [\n          ...marks.slice(0, indexOfCode),\n          ...marks.slice(indexOfCode + 1, marks.length),\n          marks[indexOfCode],\n        ]\n      }\n\n      let leading = trailing\n      trailing = ''\n      // If whitespace has to be expelled from the node, adjust\n      // leading and trailing accordingly.\n      if (\n        node &&\n        node.isText &&\n        marks.some((mark, _i, _a) => {\n          const info = this.marks[mark.type.name]\n          return !!(info && info.expelEnclosingWhitespace)\n        }) &&\n        /^(\\s*)(.*?)(\\s*)$/.test(node.text || '') // Todo: Don't duplicate this check.\n      ) {\n        const [, lead, inner, trail] = Array.from(\n          /^(\\s*)(.*?)(\\s*)$/.exec(node.text || '') || []\n        )\n        leading += lead\n        trailing = trail\n        if (lead || trail) {\n          node = inner ? (node as any).withText(inner) : null\n          if (!node) marks = active\n        }\n      }\n\n      const inner = marks.length && marks[marks.length - 1]\n      const noEsc =\n        inner && (this.marks[inner.type.name] as any).escape === false\n      const len = marks.length - (noEsc ? 1 : 0)\n\n      // Try to reorder 'mixable' marks, such as em and strong, which\n      // in Markdown may be opened and closed in different order, so\n      // that order of the marks for the token matches the order in\n      // active.\n      outer: for (let i = 0; i < len; i++) {\n        const mark = marks[i]\n        if (!this.marks[mark.type.name].mixable) break\n        for (let j = 0; j < active.length; j++) {\n          const other = active[j]\n          if (!this.marks[other.type.name].mixable) break\n          if (mark.eq(other)) {\n            if (i > j)\n              marks = marks\n                .slice(0, j)\n                .concat(mark)\n                .concat(marks.slice(j, i))\n                .concat(marks.slice(i + 1, len))\n            else if (j > i)\n              marks = marks\n                .slice(0, i)\n                .concat(marks.slice(i + 1, j))\n                .concat(mark)\n                .concat(marks.slice(j, len))\n            continue outer\n          }\n        }\n      }\n\n      // Find the prefix of the mark set that didn't change\n      let keep = 0\n      while (\n        keep < Math.min(active.length, len) &&\n        marks[keep].eq(active[keep])\n      )\n        ++keep\n\n      // Close the marks that need to be closed\n      while (keep < active.length)\n        this.text(this.markString(active.pop(), false, node), false)\n\n      // Output any previously expelled trailing whitespace outside the marks\n      if (leading) this.text(leading)\n\n      // Open the marks that need to be opened\n      if (node) {\n        while (active.length < len) {\n          const add = marks[active.length]\n          active.push(add)\n          this.text(this.markString(add, true, node), false)\n        }\n\n        // Render the node. Special case code marks, since their content\n        // may not be escaped.\n        if (noEsc && node.isText && inner)\n          this.text(\n            this.markString(inner, false, node) +\n              node.text +\n              this.markString(inner, true, node),\n            false,\n            escFn\n          )\n        else this.render(node, parent, index, escFn)\n      }\n    }\n    parent.forEach(progress)\n    progress(null)\n  }\n\n  // :: (Node, string, (number)  string)\n  // Render a node's content as a list. `delim` should be the extra\n  // indentation added to all lines except the first in an item,\n  // `firstDelim` is a function going from an item index to a\n  // delimiter for the first line of the item.\n  renderList(node: Node, delim: string, firstDelim: (n: number) => string) {\n    if (this.closed && this.closed.type == node.type) this.flushClose(3)\n    else if (this.inTightList) this.flushClose(1)\n\n    const isTight = this.options.tightLists\n    const prevTight = this.inTightList\n    this.inTightList = !!isTight\n    node.forEach((child, _, i) => {\n      if (i && isTight) this.flushClose(1)\n      this.wrapBlock(delim, firstDelim(i), node, () =>\n        this.render(child, node, i)\n      )\n    })\n    this.inTightList = prevTight\n  }\n\n  // :: (string, ?bool)  string\n  // Escape the given string so that it can safely appear in Markdown\n  // content. If `startOfLine` is true, also escape characters that\n  // has special meaning only at the start of the line.\n  esc(str: string, startOfLine?: boolean | Node) {\n    str = str.replace(/[`\\\\~\\[\\]]/g, '\\\\$&')\n    if (startOfLine)\n      str = str.replace(/^[#\\-*+]/, '\\\\$&').replace(/^(\\d+)\\./, '$1\\\\.')\n    return str\n  }\n\n  quote(str: string) {\n    const wrap =\n      str.indexOf('\"') == -1 ? '\"\"' : str.indexOf(\"'\") == -1 ? \"''\" : '()'\n    return wrap[0] + str + wrap[1]\n  }\n\n  // :: (string, number)  string\n  // Repeat the given string `n` times.\n  repeat(str: string, n: number) {\n    let out = ''\n    for (let i = 0; i < n; i++) out += str\n    return out\n  }\n\n  // : (Mark, bool)  string\n  // Get the markdown string for a given opening or closing mark.\n  markString(mark: Mark, open: boolean, node: Node | null) {\n    const info = this.marks[mark.type.name]\n    const value = open ? info.open : info.close\n    return typeof value == 'string' ? value : value(this, mark, node)\n  }\n\n  // :: (string)  { leading: ?string, trailing: ?string }\n  // Get leading and trailing whitespace from a string. Values of\n  // leading or trailing property of the return object will be undefined\n  // if there is no match.\n  getEnclosingWhitespace(\n    text: string\n  ): { leading?: string; trailing?: string } {\n    return {\n      leading: (text.match(/^(\\s+)/) || [])[0],\n      trailing: (text.match(/(\\s+)$/) || [])[0],\n    }\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Token } from '../types'\nimport { Schema, Mark, Node } from 'prosemirror-model'\nimport { MarkdownSerializerState, Nodes } from '../to_markdown'\n\nconst get = require('lodash.get')\ninterface Hash<T> {\n  [key: string]: T\n}\n\nconst ALIGN_STYLES: any = {\n  ['text-align:left']: 'left',\n  ['text-align:center']: 'center',\n  ['text-align:right']: 'right',\n}\n\nconst ALIGN_DASHES: any = {\n  left: ':---',\n  center: ':---:',\n  right: '---:',\n}\n\nconst TOKENS = {\n  blockquote: { block: 'blockquote' },\n  paragraph: { block: 'paragraph' },\n  list_item: { block: 'list_item' },\n  bullet_list: { block: 'bullet_list' },\n  ordered_list: {\n    block: 'ordered_list',\n    getAttrs: (tok: Token) => ({ order: +tok.attrGet('order') || 1 }),\n  },\n  heading: {\n    block: 'heading',\n    getAttrs: (tok: Token) => ({ level: +tok.tag.slice(1) }),\n  },\n  code_block: { block: 'code_block' },\n  fence: {\n    block: 'code_block',\n    getAttrs: (tok: Token) => ({ params: tok.info || '' }),\n  },\n  hr: { node: 'horizontal_rule' },\n  image: {\n    node: 'image',\n    getAttrs: (tok: Token) => ({\n      src: tok.attrGet('src'),\n      title: tok.attrGet('title') || null,\n      alt: (tok.children[0] && tok.children[0].content) || null,\n      width: tok.attrGet('width') || null,\n      height: tok.attrGet('height') || null,\n    }),\n  },\n  table: {\n    block: 'table',\n  },\n  table_row: { block: 'table_row' },\n  table_cell: {\n    block: 'table_cell',\n    getAttrs(tok: Token) {\n      let style: string = ''\n\n      if (tok.attrs) {\n        for (let i = 0; i < tok.attrs.length; i++) {\n          if (tok.attrs[i][0] === 'style') {\n            style = tok.attrs[i][1]\n          }\n        }\n      }\n\n      return { align: ALIGN_STYLES[style] }\n    },\n  },\n  table_header: {\n    block: 'table_header',\n    getAttrs(tok: Token) {\n      let style: string = ''\n      if (tok.attrs) {\n        for (let i = 0; i < tok.attrs.length; i++) {\n          if (tok.attrs[i][0] === 'style') {\n            style = tok.attrs[i][1]\n          }\n        }\n      }\n\n      return { align: ALIGN_STYLES[style] }\n    },\n  },\n  hardbreak: { node: 'hard_break' },\n  em: { mark: 'em' },\n  strike: { mark: 'strike' },\n  strong: { mark: 'strong' },\n  link: {\n    mark: 'link',\n    getAttrs: (tok: Token) => ({\n      href: tok.attrGet('href'),\n      title: tok.attrGet('title') || null,\n    }),\n  },\n  code_inline: { mark: 'code' },\n}\n\nconst NODES: Nodes = {\n  blockquote(state: MarkdownSerializerState, node: Node) {\n    state.wrapBlock('> ', null, node, () => state.renderContent(node))\n  },\n  code_block(state: MarkdownSerializerState, node: Node) {\n    if (!node.attrs.params) {\n      state.wrapBlock('    ', null, node, () =>\n        state.text(node.textContent, false)\n      )\n    } else {\n      state.write('```' + node.attrs.params + '\\n')\n      state.text(node.textContent, false)\n      state.ensureNewLine()\n      state.write('```')\n      state.closeBlock(node)\n    }\n  },\n  heading(state: MarkdownSerializerState, node: Node) {\n    if (/\\n/.test(node.textContent) && node.attrs.level < 3) {\n      state.renderInline(node)\n      state.write('\\n')\n      state.write(node.attrs.level === 1 ? '=' : '-')\n    } else {\n      state.write(state.repeat('#', node.attrs.level) + ' ')\n      state.renderInline(node)\n    }\n    state.closeBlock(node)\n  },\n  horizontal_rule(state: MarkdownSerializerState, node: Node) {\n    state.write(node.attrs.markup || '***')\n    state.closeBlock(node)\n  },\n  bullet_list(state: MarkdownSerializerState, node: Node) {\n    state.renderList(node, '  ', () => (node.attrs.bullet || '*') + ' ')\n  },\n  ordered_list(state: MarkdownSerializerState, node: Node) {\n    const start = node.attrs.order || 1\n    const maxW = String(start + node.childCount - 1).length\n    const space = state.repeat(' ', maxW + 2)\n    state.renderList(node, space, i => {\n      const nStr = String(start + i)\n      return state.repeat(' ', maxW - nStr.length) + nStr + '. '\n    })\n  },\n  list_item(state: MarkdownSerializerState, node: Node) {\n    state.renderContent(node)\n  },\n\n  paragraph(\n    state: MarkdownSerializerState,\n    node: Node,\n    _parent?: Node,\n    _index?: number\n  ) {\n    state.renderInline(node)\n    state.closeBlock(node)\n  },\n\n  image(state: MarkdownSerializerState, node: Node) {\n    let size: string = ''\n    if (node.attrs.height || node.attrs.width) {\n      size = ` =${node.attrs.width || ''}x${node.attrs.height || ''}`\n    }\n    const alt = state.esc(node.attrs.alt || '')\n    const src = state.esc(node.attrs.src)\n    const title = node.attrs.title ? ' ' + state.quote(node.attrs.title) : ''\n    state.write(`![${alt}](${src}${title}${size})`)\n  },\n\n  hard_break(\n    state: MarkdownSerializerState,\n    node: Node,\n    parent?: Node,\n    index?: number\n  ) {\n    if (!parent || typeof index !== 'number') return\n    for (let i = index + 1; i < parent.childCount; i++)\n      if (parent.child(i).type != node.type) {\n        state.write('  \\n')\n        return\n      }\n  },\n  text(\n    state: MarkdownSerializerState,\n    node: Node,\n    _1,\n    _2,\n    escFn?: (str: string) => string\n  ) {\n    if (typeof node.text !== 'string') return\n    state.text(node.text, true, escFn)\n  },\n  table(state: MarkdownSerializerState, node: Node) {\n    let inHead = true\n\n    node.forEach(row => {\n      const nextRowIsInBody = row.content.child(0).type.name === 'table_cell'\n\n      if (inHead && nextRowIsInBody) {\n        state.write('|')\n        for (let i = 0; i < row.childCount; i++) {\n          const align = row.content.child(i).attrs.align\n          const dash = ALIGN_DASHES[align] || '---'\n          state.write(` ${dash} |`)\n        }\n        state.write('\\n')\n        inHead = false\n      }\n\n      NODES.table_row(state, row)\n    })\n\n    state.closeBlock(node)\n  },\n  table_row(state: MarkdownSerializerState, node: Node) {\n    state.write('|')\n    state.renderContent(node)\n    state.write('\\n')\n  },\n  table_cell(state: MarkdownSerializerState, node: Node) {\n    state.write(' ')\n    /**\n     * In the case of table's are pipes escaped.\n     */\n    state.renderInline(node, (str: String) => str.replace(/[\\|]/g, '\\\\$&'))\n    state.write(' |')\n  },\n  table_header(state: MarkdownSerializerState, node: Node) {\n    NODES.table_cell(state, node)\n  },\n}\n\nconst MARKS = {\n  em: {\n    open: '_',\n    close: '_',\n    mixable: true,\n    expelEnclosingWhitespace: true,\n  },\n  strong: {\n    open(\n      _state: MarkdownSerializerState,\n      mark: Mark & { openedWith: string },\n      node: Node | null\n    ) {\n      if (get(node, 'text', '').endsWith('*')) return (mark.openedWith = '__')\n      return '**'\n    },\n    close(\n      _state: MarkdownSerializerState,\n      mark: Mark & { openedWith: string | null },\n      node: Node | null\n    ) {\n      if (mark.openedWith) {\n        const closeWith = mark.openedWith\n        mark.openedWith = null\n        return closeWith\n      }\n      if (get(node, 'text', '').endsWith('*')) return '__'\n      return '**'\n    },\n    mixable: true,\n    expelEnclosingWhitespace: true,\n  },\n  link: {\n    open: '[',\n    close(state: MarkdownSerializerState, mark: Mark) {\n      return (\n        '](' +\n        state.esc(mark.attrs.href) +\n        (mark.attrs.title ? ' ' + state.quote(mark.attrs.title) : '') +\n        ')'\n      )\n    },\n  },\n  strike: {\n    open: '~~',\n    close: '~~',\n    mixable: true,\n    expelEnclosingWhitespace: true,\n  },\n  code: { open: '`', close: '`', escape: false },\n}\n\nexport function buildTokensForSchema(schema: Schema): Hash<Token> {\n  const tokens: Hash<Token> = {}\n\n  if (schema.nodes.blockquote) tokens.blockquote = TOKENS.blockquote\n  if (schema.nodes.paragraph) tokens.paragraph = TOKENS.paragraph\n  if (schema.nodes.list_item) tokens.list_item = TOKENS.list_item\n  if (schema.nodes.bullet_list) tokens.bullet_list = TOKENS.bullet_list\n  if (schema.nodes.ordered_list) tokens.ordered_list = TOKENS.ordered_list\n  if (schema.nodes.heading) tokens.heading = TOKENS.heading\n  if (schema.nodes.code_block) {\n    tokens.code_block = TOKENS.code_block\n    tokens.fence = TOKENS.fence\n  }\n  if (schema.nodes.horizontal_rule) tokens.hr = TOKENS.hr\n  if (schema.nodes.image) tokens.image = TOKENS.image\n  if (schema.nodes.hard_break) tokens.hardbreak = TOKENS.hardbreak\n  if (schema.nodes.ordered_list) tokens.ordered_list = TOKENS.ordered_list\n  if (schema.nodes.bullet_list) tokens.bullet_list = TOKENS.bullet_list\n  if (schema.nodes.list_item) tokens.list_item = TOKENS.list_item\n  if (schema.nodes.table) {\n    tokens.table = TOKENS.table\n    tokens.thead = { ignore: true }\n    tokens.th = TOKENS.table_header\n\n    tokens.tbody = { ignore: true }\n    tokens.tr = TOKENS.table_row\n\n    tokens.td = TOKENS.table_cell\n  }\n  if (schema.marks.em) tokens.em = TOKENS.em\n  if (schema.marks.strong) tokens.strong = TOKENS.strong\n  if (schema.marks.link) tokens.link = TOKENS.link\n  if (schema.marks.code) tokens.code_inline = TOKENS.code_inline\n  if (schema.marks.strike) tokens.strike = TOKENS.strike\n\n  return tokens\n}\n\nexport function buildNodesFromSchema(schema: Schema): Nodes {\n  const nodes: Nodes = {}\n\n  if (schema.nodes.blockquote) nodes.blockquote = NODES.blockquote\n  if (schema.nodes.paragraph) nodes.paragraph = NODES.paragraph\n  if (schema.nodes.list_item) nodes.list_item = NODES.list_item\n  if (schema.nodes.bullet_list) nodes.bullet_list = NODES.bullet_list\n  if (schema.nodes.ordered_list) nodes.ordered_list = NODES.ordered_list\n  if (schema.nodes.heading) nodes.heading = NODES.heading\n  if (schema.nodes.code_block) nodes.code_block = NODES.code_block\n  if (schema.nodes.horizontal_rule)\n    nodes.horizontal_rule = NODES.horizontal_rule\n  if (schema.nodes.image) nodes.image = NODES.image\n  if (schema.nodes.hard_break) nodes.hard_break = NODES.hard_break\n  if (schema.nodes.ordered_list) nodes.ordered_list = NODES.ordered_list\n  if (schema.nodes.bullet_list) nodes.bullet_list = NODES.bullet_list\n  if (schema.nodes.list_item) nodes.list_item = NODES.list_item\n  if (schema.nodes.table) {\n    nodes.table = NODES.table\n    nodes.table_header = NODES.table_header\n    nodes.table_row = NODES.table_row\n    nodes.table_cell = NODES.table_cell\n  }\n\n  nodes.text = NODES.text\n\n  return nodes\n}\n\nexport function buildMarksFromSchema(schema: Schema) {\n  const marks: any = {}\n  if (schema.marks.em) marks.em = MARKS.em\n  if (schema.marks.strong) marks.strong = MARKS.strong\n  if (schema.marks.link) marks.link = MARKS.link\n  if (schema.marks.code) marks.code = MARKS.code\n  return MARKS\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n// :: MarkdownSerializer\n// A serializer for the [basic schema](#schema).\nimport { MarkdownSerializer } from '../to_markdown'\nimport { Schema } from 'prosemirror-model'\nimport { buildMarksFromSchema, buildNodesFromSchema } from './tokens'\n\nexport function CommonMarkSerializer(schema: Schema) {\n  return new MarkdownSerializer(\n    buildNodesFromSchema(schema),\n    buildMarksFromSchema(schema)\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n// Parse image size\n//\n'use strict'\n\ntype Result = {\n  ok: boolean\n  pos: number\n  value?: number\n  width?: number\n  height?: number\n}\n\nfunction parseNextNumber(str: string, pos: number, max: number) {\n  let code\n  const start = pos\n  const result: Result = {\n    ok: false,\n    pos: pos,\n  }\n\n  code = str.charCodeAt(pos)\n\n  while (\n    (pos < max && code >= 0x30 /* 0 */ && code <= 0x39) /* 9 */ ||\n    code === 0x25 /* % */\n  ) {\n    code = str.charCodeAt(++pos)\n  }\n\n  result.ok = true\n  result.pos = pos\n  result.value = Number(str.slice(start, pos))\n\n  return result\n}\n\nexport function parseImageSize(str: string, pos: number, max: number) {\n  let code\n\n  const result: Result = {\n    ok: false,\n    pos: 0,\n  }\n\n  if (pos >= max) {\n    return result\n  }\n\n  code = str.charCodeAt(pos)\n\n  if (code !== 0x3d /* = */) {\n    return result\n  }\n\n  pos++\n\n  // size must follow = without any white spaces as follows\n  // (1) =300x200\n  // (2) =300x\n  // (3) =x200\n  code = str.charCodeAt(pos)\n  if (code !== 0x78 /* x */ && (code < 0x30 || code > 0x39) /* [0-9] */) {\n    return result\n  }\n\n  // parse width\n  const resultW = parseNextNumber(str, pos, max)\n  pos = resultW.pos\n\n  // next charactor must be 'x'\n  code = str.charCodeAt(pos)\n  if (code !== 0x78 /* x */) {\n    return result\n  }\n\n  pos++\n\n  // parse height\n  const resultH = parseNextNumber(str, pos, max)\n  pos = resultH.pos\n\n  result.width = resultW.value\n  result.height = resultH.value\n  result.pos = pos\n  result.ok = true\n  return result\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nexport function parseLinkDestination(md: any, state: any, pos: any): any {\n  const isSpace = md.utils.isSpace\n  const unescapeAll = md.utils.unescapeAll\n  const str = state.src\n  const max = state.posMax\n\n  let code\n  let level: number\n  const lines = 0\n  const start = pos\n  const result = {\n    ok: false,\n    pos: 0,\n    lines: 0,\n    str: '',\n  }\n\n  if (str.charCodeAt(pos) === 0x3c /* < */) {\n    pos++\n    while (pos < max) {\n      code = str.charCodeAt(pos)\n      if (code === 0x0a /* \\n */ || isSpace(code)) {\n        return result\n      }\n      if (code === 0x3e /* > */) {\n        result.pos = pos + 1\n        result.str = unescapeAll(str.slice(start + 1, pos))\n        result.ok = true\n        return result\n      }\n      if (code === 0x5c /* \\ */ && pos + 1 < max) {\n        pos += 2\n        continue\n      }\n\n      pos++\n    }\n\n    // no closing '>'\n    return result\n  }\n\n  // this should be ... } else { ... branch\n\n  level = 0\n  while (pos < max) {\n    code = str.charCodeAt(pos)\n\n    if (\n      code == 61 /* = */ ||\n      code == 34 /* \" */ ||\n      code == 39 /* ' */\n      // code === 0x20\n    ) {\n      pos--\n      break\n    }\n\n    // ascii control characters\n    if (code < 0x20 || code === 0x7f) {\n      break\n    }\n\n    if (code === 0x5c /* \\ */ && pos + 1 < max) {\n      pos += 2\n      continue\n    }\n\n    if (code === 0x28 /* ( */) {\n      level++\n    }\n\n    if (code === 0x29 /* ) */) {\n      if (level === 0) {\n        break\n      }\n      level--\n    }\n\n    pos++\n  }\n\n  if (start === pos) {\n    return result\n  }\n  if (level !== 0) {\n    return result\n  }\n\n  result.str = unescapeAll(str.slice(start, pos))\n  result.lines = lines\n  result.pos = pos\n  result.ok = true\n  return result\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n// Process ![test]( x =100x200)\n//                    ^^^^^^^^ this size specification\n\nimport { parseImageSize } from './helpers/parse_image_size'\nimport { parseLinkDestination } from '../helpers/parseLinkDestination'\n\nfunction image_with_size(md: any) {\n  return function(state: any, silent: any) {\n    let attrs,\n      code,\n      label,\n      pos,\n      ref,\n      res,\n      title,\n      width = null,\n      height = null,\n      token,\n      tokens: any,\n      start,\n      href = ''\n\n    const oldPos = state.pos,\n      max = state.posMax\n\n    if (state.src.charCodeAt(state.pos) !== 0x21 /* ! */) {\n      return false\n    }\n    if (state.src.charCodeAt(state.pos + 1) !== 0x5b /* [ */) {\n      return false\n    }\n\n    const labelStart = state.pos + 2\n    const labelEnd = md.helpers.parseLinkLabel(state, state.pos + 1, false)\n\n    // parser failed to find ']', so it's not a valid link\n    if (labelEnd < 0) {\n      return false\n    }\n\n    pos = labelEnd + 1\n    if (pos < max && state.src.charCodeAt(pos) === 0x28 /* ( */) {\n      //\n      // Inline link\n      //\n\n      // [link](  <href>  \"title\"  )\n      //        ^^ skipping these spaces\n      pos++\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos)\n        if (code !== 0x20 && code !== 0x0a) {\n          break\n        }\n      }\n      if (pos >= max) {\n        return false\n      }\n\n      // [link](  <href>  \"title\"  )\n      //          ^^^^^^ parsing link destination\n      start = pos\n      res = parseLinkDestination(md, state, pos)\n      if (res.ok) {\n        href = res.str\n        if (state.md.validateLink(href)) {\n          pos = res.pos\n        } else {\n          href = ''\n        }\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                ^^ skipping these spaces\n      start = pos\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos)\n        if (code !== 0x20 && code !== 0x0a) {\n          break\n        }\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                  ^^^^^^^ parsing link title\n      res = md.helpers.parseLinkTitle(state.src, pos, state.posMax)\n      if (pos < max && start !== pos && res.ok) {\n        title = res.str\n        pos = res.pos\n\n        // [link](  <href>  \"title\"  )\n        //                         ^^ skipping these spaces\n        for (; pos < max; pos++) {\n          code = state.src.charCodeAt(pos)\n          if (code !== 0x20 && code !== 0x0a) {\n            break\n          }\n        }\n      } else {\n        title = ''\n      }\n\n      // [link](  <href>  \"title\" =WxH  )\n      //                          ^^^^ parsing image size\n      if (pos - 1 >= 0) {\n        code = state.src.charCodeAt(pos - 1)\n\n        // there must be at least one white spaces\n        // between previous field and the size\n        if (code === 0x20) {\n          res = parseImageSize(state.src, pos, state.posMax)\n          if (res.ok) {\n            width = res.width\n            height = res.height\n            pos = res.pos\n\n            // [link](  <href>  \"title\" =WxH  )\n            //                              ^^ skipping these spaces\n            for (; pos < max; pos++) {\n              code = state.src.charCodeAt(pos)\n              if (code !== 0x20 && code !== 0x0a) {\n                break\n              }\n            }\n          }\n        }\n      }\n\n      if (pos >= max || state.src.charCodeAt(pos) !== 0x29 /* ) */) {\n        state.pos = oldPos\n        return false\n      }\n      pos++\n    } else {\n      //\n      // Link reference\n      //\n      if (typeof state.env.references === 'undefined') {\n        return false\n      }\n\n      // [foo]  [bar]\n      //      ^^ optional whitespace (can include newlines)\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos)\n        if (code !== 0x20 && code !== 0x0a) {\n          break\n        }\n      }\n\n      if (pos < max && state.src.charCodeAt(pos) === 0x5b /* [ */) {\n        start = pos + 1\n        pos = md.helpers.parseLinkLabel(state, pos)\n        if (pos >= 0) {\n          label = state.src.slice(start, pos++)\n        } else {\n          pos = labelEnd + 1\n        }\n      } else {\n        pos = labelEnd + 1\n      }\n\n      // covers label === '' and label === undefined\n      // (collapsed reference link and shortcut reference link respectively)\n      if (!label) {\n        label = state.src.slice(labelStart, labelEnd)\n      }\n\n      ref = state.env.references[md.utils.normalizeReference(label)]\n      if (!ref) {\n        state.pos = oldPos\n        return false\n      }\n      href = ref.href\n      title = ref.title\n    }\n\n    //\n    // We found the end of the link, and know for a fact it's a valid link;\n    // so all that's left to do is to call tokenizer.\n    //\n    if (!silent) {\n      state.pos = labelStart\n      state.posMax = labelEnd\n\n      const newState = new state.md.inline.State(\n        state.src.slice(labelStart, labelEnd),\n        state.md,\n        state.env,\n        (tokens = [])\n      )\n      newState.md.inline.tokenize(newState)\n\n      token = state.push('image', 'img', 0)\n      token.attrs = attrs = [\n        ['src', href],\n        ['alt', ''],\n      ]\n      token.children = tokens\n      if (title) {\n        attrs.push(['title', title])\n      }\n\n      if (width !== null) {\n        attrs.push(['width', width as any])\n      }\n\n      if (height !== null) {\n        attrs.push(['height', height as any])\n      }\n    }\n\n    state.pos = pos\n    state.posMax = max\n    return true\n  }\n}\n\nexport function imsize(md: any) {\n  md.inline.ruler.before('emphasis', 'image', image_with_size(md))\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\n// Process [link](<to> \"stuff\")\n// https://github.com/markdown-it/markdown-it/blob/master/lib/rules_inline/link.js\n'use strict'\n\nimport { parseLinkDestination } from '../helpers/parseLinkDestination'\n\nfunction _link(md: any) {\n  return function(state: any, silent: any) {\n    const normalizeReference = state.md.utils.normalizeReference\n    const isSpace = state.md.utils.isSpace\n\n    let attrs,\n      code,\n      label,\n      pos,\n      res,\n      ref,\n      title,\n      token,\n      href = '',\n      start = state.pos,\n      parseReference = true\n\n    const oldPos = state.pos,\n      max = state.posMax\n\n    if (state.src.charCodeAt(state.pos) !== 0x5b /* [ */) {\n      return false\n    }\n\n    const labelStart = state.pos + 1\n    const labelEnd = state.md.helpers.parseLinkLabel(state, state.pos, true)\n\n    // parser failed to find ']', so it's not a valid link\n    if (labelEnd < 0) {\n      return false\n    }\n\n    pos = labelEnd + 1\n    if (pos < max && state.src.charCodeAt(pos) === 0x28 /* ( */) {\n      //\n      // Inline link\n      //\n\n      // might have found a valid shortcut link, disable reference parsing\n      parseReference = false\n\n      // [link](  <href>  \"title\"  )\n      //        ^^ skipping these spaces\n      pos++\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos)\n        if (!isSpace(code) && code !== 0x0a) {\n          break\n        }\n      }\n      if (pos >= max) {\n        return false\n      }\n\n      start = pos\n      res = parseLinkDestination(md, state, pos)\n      if (res.ok) {\n        href = res.str\n        if (state.md.validateLink(href)) {\n          pos = res.pos\n        } else {\n          href = ''\n        }\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                ^^ skipping these spaces\n      start = pos\n      for (; pos < max; pos++) {\n        code = state.src.charCodeAt(pos)\n        if (!isSpace(code) && code !== 0x0a) {\n          break\n        }\n      }\n\n      // [link](  <href>  \"title\"  )\n      //                  ^^^^^^^ parsing link title\n      res = state.md.helpers.parseLinkTitle(state.src, pos, state.posMax)\n      if (pos < max && start !== pos && res.ok) {\n        title = res.str\n        pos = res.pos\n\n        // [link](  <href>  \"title\"  )\n        //                         ^^ skipping these spaces\n        for (; pos < max; pos++) {\n          code = state.src.charCodeAt(pos)\n          if (!isSpace(code) && code !== 0x0a) {\n            break\n          }\n        }\n      } else {\n        title = ''\n      }\n\n      if (pos >= max || state.src.charCodeAt(pos) !== 0x29 /* ) */) {\n        // parsing a valid shortcut link failed, fallback to reference\n        parseReference = true\n      }\n      pos++\n    }\n\n    if (parseReference) {\n      //\n      // Link reference\n      //\n      if (typeof state.env.references === 'undefined') {\n        return false\n      }\n\n      if (pos < max && state.src.charCodeAt(pos) === 0x5b /* [ */) {\n        start = pos + 1\n        pos = state.md.helpers.parseLinkLabel(state, pos)\n        if (pos >= 0) {\n          label = state.src.slice(start, pos++)\n        } else {\n          pos = labelEnd + 1\n        }\n      } else {\n        pos = labelEnd + 1\n      }\n\n      // covers label === '' and label === undefined\n      // (collapsed reference link and shortcut reference link respectively)\n      if (!label) {\n        label = state.src.slice(labelStart, labelEnd)\n      }\n\n      ref = state.env.references[normalizeReference(label)]\n      if (!ref) {\n        state.pos = oldPos\n        return false\n      }\n      href = ref.href\n      title = ref.title\n    }\n\n    //\n    // We found the end of the link, and know for a fact it's a valid link;\n    // so all that's left to do is to call tokenizer.\n    //\n    if (!silent) {\n      state.pos = labelStart\n      state.posMax = labelEnd\n\n      token = state.push('link_open', 'a', 1)\n      token.attrs = attrs = [['href', href]]\n      if (title) {\n        attrs.push(['title', title])\n      }\n\n      state.md.inline.tokenize(state)\n\n      token = state.push('link_close', 'a', -1)\n    }\n\n    state.pos = pos\n    state.posMax = max\n    return true\n  }\n}\n\nexport function link(md: any) {\n  md.inline.ruler.before('emphasis', 'link', _link(md))\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Mark, MarkType, Node, NodeType, Schema } from 'prosemirror-model'\nimport { Token } from './types'\n\nconst MarkMapping: { [key: string]: any } = {\n  strike: 's',\n}\n\nfunction maybeMerge(a: any, b: any) {\n  if (a.isText && b.isText && Mark.sameSet(a.marks, b.marks))\n    return a.copy(a.text + b.text)\n}\n\ninterface TokenHandlers {\n  [key: string]: (state: MarkdownParseState, token: Token) => void\n}\n\n// Object used to track the context of a running parse.\nclass MarkdownParseState {\n  schema: Schema\n  stack: { type: NodeType; content: any[]; attrs?: object }[]\n  marks: Mark[]\n  tokenHandlers: TokenHandlers\n  constructor(schema: Schema, tokenHandlers: TokenHandlers) {\n    this.schema = schema\n    this.stack = [{ type: schema.topNodeType, content: [] }]\n    this.marks = Mark.none\n    this.tokenHandlers = tokenHandlers\n  }\n\n  top() {\n    return this.stack[this.stack.length - 1]\n  }\n\n  push(elt: any) {\n    if (this.stack.length) this.top().content.push(elt)\n  }\n\n  // : (string)\n  // Adds the given text to the current position in the document,\n  // using the current marks as styling.\n  addText(text: string) {\n    if (!text) return\n    const nodes = this.top().content,\n      last = nodes[nodes.length - 1],\n      node = this.schema.text(text, this.marks)\n\n    let merged\n\n    if (last && (merged = maybeMerge(last, node)))\n      nodes[nodes.length - 1] = merged\n    else nodes.push(node)\n  }\n\n  // : (Mark)\n  // Adds the given mark to the set of active marks.\n  openMark(mark: Mark) {\n    this.marks = mark.addToSet(this.marks)\n  }\n\n  // : (Mark)\n  // Removes the given mark from the set of active marks.\n  closeMark(mark: MarkType) {\n    this.marks = mark.removeFromSet(this.marks)\n  }\n\n  parseTokens(toks: Token[]) {\n    for (let i = 0; i < toks.length; i++) {\n      const tok = toks[i]\n      const handler = this.tokenHandlers[tok.type]\n      if (!handler)\n        throw new Error(\n          'Token type `' + tok.type + '` not supported by Markdown parser'\n        )\n      handler(this, tok)\n    }\n  }\n\n  // : (NodeType, ?Object, ?[Node])  ?Node\n  // Add a node at the current position.\n  addNode(type: NodeType, attrs?: object, content?: Node[]) {\n    const node = type.createAndFill(attrs, content, this.marks)\n    if (!node) return null\n    this.push(node)\n    return node\n  }\n\n  // : (NodeType, ?Object)\n  // Wrap subsequent content in a node of the given type.\n  openNode(type: NodeType, attrs?: object) {\n    this.stack.push({ type: type, attrs, content: [] })\n  }\n\n  // : ()  ?Node\n  // Close and return the node that is currently on top of the stack.\n  closeNode() {\n    if (this.marks.length) this.marks = Mark.none\n    const info = this.stack.pop()\n    if (!info) return //devWarn(\"Attempted to close a non-existent node.\")\n    return this.addNode(info.type, info.attrs, info.content)\n  }\n}\n\nfunction attrs(spec: any, token: Token) {\n  if (spec.getAttrs) return spec.getAttrs(token)\n  // For backwards compatibility when `attrs` is a Function\n  else if (spec.attrs instanceof Function) return spec.attrs(token)\n  else return spec.attrs\n}\n\n// Code content is represented as a single token with a `content`\n// property in Markdown-it.\nfunction noOpenClose(type: String) {\n  return type == 'code_inline' || type == 'code_block' || type == 'fence'\n}\n\nfunction withoutTrailingNewline(str: string) {\n  return str[str.length - 1] == '\\n' ? str.slice(0, str.length - 1) : str\n}\n\nfunction noOp() {}\n\ntype THSchema = any\n\ninterface Hash<T> {\n  [key: string]: T\n}\n\nfunction tokenHandlers(schema: THSchema, tokens: Hash<Token>) {\n  const handlers = Object.create(null)\n  for (const type in tokens) {\n    const spec = tokens[type]\n    if (spec.block) {\n      const nodeType = schema.nodeType(spec.block)\n      if (noOpenClose(type)) {\n        handlers[type] = (state: MarkdownParseState, tok: Token) => {\n          state.openNode(nodeType, attrs(spec, tok))\n          state.addText(withoutTrailingNewline(tok.content))\n          state.closeNode()\n        }\n      } else {\n        handlers[type + '_open'] = (state: MarkdownParseState, tok: Token) =>\n          state.openNode(nodeType, attrs(spec, tok))\n        handlers[type + '_close'] = (state: MarkdownParseState) =>\n          state.closeNode()\n      }\n    } else if (spec.node) {\n      const nodeType = schema.nodeType(spec.node)\n      handlers[type] = (state: MarkdownParseState, tok: Token) =>\n        state.addNode(nodeType, attrs(spec, tok))\n    } else if (spec.mark) {\n      const markType = schema.marks[spec.mark]\n      if (noOpenClose(type)) {\n        handlers[type] = (state: MarkdownParseState, tok: Token) => {\n          state.openMark(markType.create(attrs(spec, tok)))\n          state.addText(withoutTrailingNewline(tok.content))\n          state.closeMark(markType)\n        }\n      } else {\n        handlers[(MarkMapping[type] || type) + '_open'] = (\n          state: MarkdownParseState,\n          tok: Token\n        ) => state.openMark(markType.create(attrs(spec, tok)))\n        handlers[(MarkMapping[type] || type) + '_close'] = (\n          state: MarkdownParseState\n        ) => state.closeMark(markType)\n      }\n    } else if (spec.ignore) {\n      if (noOpenClose(type)) {\n        handlers[type] = noOp\n      } else {\n        handlers[type + '_open'] = noOp\n        handlers[type + '_close'] = noOp\n      }\n    } else {\n      throw new RangeError('Unrecognized parsing spec ' + JSON.stringify(spec))\n    }\n  }\n\n  handlers.text = (state: MarkdownParseState, tok: Token) =>\n    state.addText(tok.content)\n  handlers.inline = (state: MarkdownParseState, tok: Token) =>\n    state.parseTokens(tok.children)\n  handlers.softbreak = (state: MarkdownParseState) => state.addText('\\n')\n\n  return handlers\n}\n\n// ::- A configuration of a Markdown parser. Such a parser uses\n// [markdown-it](https://github.com/markdown-it/markdown-it) to\n// tokenize a file, and then runs the custom rules it is given over\n// the tokens to create a ProseMirror document tree.\nexport class MarkdownParser {\n  tokens: Hash<Token>\n  schema: Schema\n  tokenizer: any\n  tokenHandlers: TokenHandlers\n  // :: (Schema, MarkdownIt, Object)\n  // Create a parser with the given configuration. You can configure\n  // the markdown-it parser to parse the dialect you want, and provide\n  // a description of the ProseMirror entities those tokens map to in\n  // the `tokens` object, which maps token names to descriptions of\n  // what to do with them. Such a description is an object, and may\n  // have the following properties:\n  //\n  // **`node`**`: ?string`\n  //   : This token maps to a single node, whose type can be looked up\n  //     in the schema under the given name. Exactly one of `node`,\n  //     `block`, or `mark` must be set.\n  node?: string\n  //\n  // **`block`**`: ?string`\n  //   : This token comes in `_open` and `_close` variants (which are\n  //     appended to the base token name provides a the object\n  //     property), and wraps a block of content. The block should be\n  //     wrapped in a node of the type named to by the property's\n  //     value.\n  block?: string\n  //\n  // **`mark`**`: ?string`\n  //   : This token also comes in `_open` and `_close` variants, but\n  //     should add a mark (named by the value) to its content, rather\n  //     than wrapping it in a node.\n  mark?: string\n  //\n  // **`attrs`**`: ?Object`\n  //   : Attributes for the node or mark. When `getAttrs` is provided,\n  //     it takes precedence.\n  attrs?: object\n  //\n  // **`getAttrs`**`: ?(MarkdownToken)  Object`\n  //   : A function used to compute the attributes for the node or mark\n  //     that takes a [markdown-it\n  //     token](https://markdown-it.github.io/markdown-it/#Token) and\n  //     returns an attribute object.\n  //\n  // **`ignore`**`: ?bool`\n  //   : When true, ignore content for the matched token.\n  constructor(schema: Schema, tokenizer: any, tokens: Hash<Token>) {\n    // :: Object The value of the `tokens` object used to construct\n    // this parser. Can be useful to copy and modify to base other\n    // parsers on.\n    this.tokens = tokens\n    this.schema = schema\n    this.tokenizer = tokenizer\n    this.tokenHandlers = tokenHandlers(schema, tokens)\n  }\n\n  // :: (string)  Node\n  // Parse a string as [CommonMark](http://commonmark.org/) markup,\n  // and create a ProseMirror document as prescribed by this parser's\n  // rules.\n  parse(text: string) {\n    const state = new MarkdownParseState(this.schema, this.tokenHandlers)\n    let doc\n    state.parseTokens(this.tokenizer.parse(text, {}))\n    do {\n      doc = state.closeNode()\n    } while (state.stack.length)\n    return doc\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { imsize } from '../markdown-it-plugins/markdown-it-imsize'\nimport { link } from '../markdown-it-plugins/markdown-it-links'\nimport { MarkdownParser } from '../from_markdown'\nimport { Schema } from 'prosemirror-model'\nimport { buildTokensForSchema } from './tokens'\n\nconst markdownit = require('markdown-it')\n\nexport function CommonMarkParser(schema: Schema) {\n  const parser = markdownit({ html: false })\n  parser.use(imsize)\n  parser.use(link)\n  return new MarkdownParser(schema, parser, buildTokensForSchema(schema))\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Schema, Node } from 'prosemirror-model'\nimport { MarkdownParser } from './from_markdown'\nimport { MarkdownSerializer } from './to_markdown'\nimport { CommonMarkParser, CommonMarkSerializer } from './commonmark'\nimport { TranslatorClass } from '../TranslatorClass'\n\nexport class MarkdownTranslator extends TranslatorClass {\n  schema: Schema\n  parser: MarkdownParser | null = null\n  serializer: MarkdownSerializer | null = null\n\n  constructor(schema: Schema) {\n    super()\n    this.schema = schema\n  }\n\n  static fromSchema(schema: Schema) {\n    return MarkdownTranslator.commonMarkFromSchema(schema)\n  }\n\n  static commonMarkFromSchema(schema: Schema) {\n    const translator = new MarkdownTranslator(schema)\n    translator.parser = CommonMarkParser(schema)\n    translator.serializer = CommonMarkSerializer(schema)\n    return translator\n  }\n\n  nodeFromString(value: string): Node | null {\n    return this.parser!.parse(value) as Node | null\n  }\n\n  stringFromNode(node: Node): string {\n    return this.serializer!.serialize(node, {\n      tightLists: true,\n    })\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport {\n  DOMSerializer as _DOMSerializer,\n  Schema,\n  Node,\n} from 'prosemirror-model'\n\nexport class DOMSerializer extends _DOMSerializer {\n  static nodesFromSchema(schema: Schema) {\n    let result = gatherToDOM(schema.nodes)\n    if (!result.text) result.text = (node: Node) => node.text\n    return result\n  }\n  static marksFromSchema(schema: Schema) {\n    return gatherToDOM(schema.marks)\n  }\n}\n\nfunction gatherToDOM(obj: any): any {\n  let result: any = {}\n  for (let name in obj) {\n    let toDocument = obj[name].spec.toDocument\n    let toDOM = obj[name].spec.toDOM\n    if (toDocument) result[name] = toDocument\n    else if (toDOM) result[name] = toDOM\n  }\n  return result\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Schema, DOMParser as PDOMParser, Node } from 'prosemirror-model'\nimport { DOMSerializer } from './to_dom'\nimport { TranslatorClass } from '../TranslatorClass'\n\nexport class DOMTranslator extends TranslatorClass {\n  schema: Schema\n  parser: PDOMParser\n  serializer: DOMSerializer\n\n  constructor(schema: Schema) {\n    super()\n    this.schema = schema\n    this.parser = PDOMParser.fromSchema(schema)\n    this.serializer = DOMSerializer.fromSchema(schema)\n  }\n\n  static fromSchema(schema: Schema) {\n    return new DOMTranslator(schema)\n  }\n\n  nodeFromString(value: string): Node {\n    let al\n\n    try {\n      al = window.document.createRange().createContextualFragment(value)\n    } catch (e) {\n      al = new DOMParser().parseFromString(value, 'text/html')\n    }\n\n    return this.parser.parse(al)\n  }\n\n  stringFromNode(node: Node): string {\n    const el = document.createElement('div')\n\n    el.appendChild(this.serializer.serializeFragment(node.content))\n\n    return el.innerHTML\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Plugin, PluginKey, Transaction } from 'prosemirror-state'\n\nexport interface CommonPluginState {\n  editorFocused: boolean\n}\n\nexport const commonPluginKey = new PluginKey('common')\n\nexport const commonPlugin = new Plugin({\n  key: commonPluginKey,\n  state: {\n    init: () => {\n      return { editorFocused: false }\n    },\n    apply(tr: Transaction, prev: CommonPluginState) {\n      if (tr.getMeta('editor_focused') === false) {\n        return {\n          editorFocused: false,\n        }\n      }\n\n      if (tr.getMeta('editor_focused')) {\n        return {\n          editorFocused: true,\n        }\n      }\n\n      return prev\n    },\n  },\n  props: {\n    handleScrollToSelection() {\n      return true\n    },\n    handleDOMEvents: {\n      focus(view) {\n        const { state, dispatch } = view\n        dispatch(state.tr.setMeta('editor_focused', true))\n        return false\n      },\n      blur(view) {\n        const { state, dispatch } = view\n        dispatch(state.tr.setMeta('editor_focused', false))\n        return false\n      },\n    },\n  },\n})\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\nimport { NodeType } from 'prosemirror-model'\nimport { liftTarget } from 'prosemirror-transform'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\nexport function liftBlockquote(state: EditorState, dispatch: Dispatch | null) {\n  const range = getRangeForType(state, state.schema.nodes.blockquote)\n  if (!range) return false\n\n  const target = liftTarget(range)\n  if (!target) return false\n\n  if (dispatch) {\n    dispatch(state.tr.lift(range, target)) //dont lift lists\n  }\n  return true\n}\n\nconst getRangeForType = (state: EditorState, listType: NodeType) => {\n  const { $from, $to } = state.selection\n  const range = $from.blockRange($to, node => {\n    return node.type == listType\n  })\n  return range\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { EditorView } from 'prosemirror-view'\n\ntype Dispatch = typeof EditorView.prototype.dispatch\n\nexport function insertHr(state: EditorState, dispatch: Dispatch | null) {\n  const type = state.schema.nodes.horizontal_rule\n  if (dispatch) {\n    dispatch(state.tr.replaceSelectionWith(type.create()).scrollIntoView())\n  }\n  return true\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { NodeType, Schema } from 'prosemirror-model'\nimport { EditorState, Selection } from 'prosemirror-state'\nimport {\n  setBlockType,\n  toggleMark,\n  wrapIn,\n  chainCommands,\n  exitCode,\n} from 'prosemirror-commands'\nimport {\n  splitListItem,\n  sinkListItem,\n  liftListItem,\n} from 'prosemirror-schema-list'\nimport { EditorView } from 'prosemirror-view'\nimport { findParentNodeOfType } from 'prosemirror-utils'\nimport * as TableCommands from 'prosemirror-tables'\nimport { undo, redo } from 'prosemirror-history'\nimport { undoInputRule } from 'prosemirror-inputrules'\n\nimport { KeymapPlugin } from '../../types'\nimport { liftBlockquote } from '../Blockquote/commands'\nimport { toggleBulletList, toggleOrderedList } from '../List/commands'\nimport { deleteEmptyHeading, toggleHeader } from '../Block/commands'\nimport { insertHr } from './commands'\nimport { openLinkPopup } from '../../plugins/Link/commands'\n\nconst hardBreakCmd = (schema: Schema) => {\n  const br = schema.nodes.hard_break\n  return chainCommands(exitCode, (state, dispatch) => {\n    dispatch!(state.tr.replaceSelectionWith(br.create()).scrollIntoView())\n    return true\n  })\n}\n\nconst headingCmd = (level: number) => (schema: Schema) => {\n  const heading = schema.nodes.heading\n  return toggleHeader(heading, { level }, schema.nodes.paragraph, null)\n}\n\nexport const KEYMAP_PLUGINS: KeymapPlugin[] = [\n  { __type: 'wysiwyg:keymap', name: 'Mod-z', command: () => undo },\n  { __type: 'wysiwyg:keymap', name: 'Backspace', command: () => undoInputRule },\n  { __type: 'wysiwyg:keymap', name: 'Mod-Shift-z', command: () => redo },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-y',\n    command: () => redo,\n    unlessMac: true,\n  },\n  { __type: 'wysiwyg:keymap', name: 'Tab', command: () => tab },\n  { __type: 'wysiwyg:keymap', name: 'Shift-Tab', command: () => shiftTab },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-b',\n    ifMark: 'strong',\n    command: schema => toggleMark(schema.marks.strong),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-i',\n    ifMark: 'em',\n    command: schema => toggleMark(schema.marks.em),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-k',\n    ifMark: 'link',\n    command: () => {\n      return function(state: any, dispatch: any) {\n        return openLinkPopup(state, dispatch)\n      }\n    },\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Enter',\n    command: hardBreakCmd,\n    ifNode: 'hard_break',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Shift-Enter',\n    command: hardBreakCmd,\n    ifNode: 'hard_break',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Ctrl-Enter',\n    command: hardBreakCmd,\n    ifNode: 'hard_break',\n    ifMac: true,\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-1',\n    command: headingCmd(1),\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-2',\n    command: headingCmd(2),\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-3',\n    command: headingCmd(3),\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-4',\n    command: headingCmd(4),\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-5',\n    command: headingCmd(5),\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-6',\n    command: headingCmd(6),\n    ifNode: 'heading',\n  },\n\n  {\n    // TODO: NOT WORKING\n    __type: 'wysiwyg:keymap',\n    name: 'Backspace',\n    command: () => deleteEmptyHeading,\n    ifNode: 'heading',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-7',\n    command: () => toggleOrderedList,\n    ifNode: 'ordered_list',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-8',\n    command: () => toggleBulletList,\n    ifNode: 'bullet_list',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-9',\n    command: schema => liftListItem(schema.nodes.list_item),\n    onCondition(schema) {\n      return !!(schema.nodes.bullet_list || schema.nodes.ordered_list)\n    },\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-0',\n    command: schema => setBlockType(schema.nodes.code_block),\n    ifNode: 'code_block',\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'ArrowLeft',\n    command: () => arrowHandler('left'),\n    ifNodes: ['code_block', 'table'],\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'ArrowRight',\n    command: () => arrowHandler('right'),\n    ifNodes: ['code_block', 'table'],\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'ArrowUp',\n    command: () => arrowHandler('up'),\n    ifNodes: ['code_block', 'table'],\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'ArrowDown',\n    command: () => arrowHandler('down'),\n    ifNodes: ['code_block', 'table'],\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-0',\n    ifMark: 'code',\n    command: schema => toggleMark(schema.marks.code),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod->',\n    ifNode: 'blockquote',\n    command: schema => wrapIn(schema.nodes.blockquote),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-<',\n    ifNode: 'blockquote',\n    command: () => liftBlockquote,\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Alt-9',\n    ifNode: 'paragraph',\n    command: schema => setBlockType(schema.nodes.paragraph),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Shift-Ctrl-0',\n    ifNode: 'paragraph',\n    command: schema => setBlockType(schema.nodes.paragraph),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Mod-Enter',\n    ifNode: 'horizontal_rule',\n    command: () => insertHr,\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Enter',\n    ifNode: 'list_item',\n    command: schema => splitListItem(schema.nodes.list_item),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Tab',\n    ifNode: 'list_item',\n    command: schema => sinkListItem(schema.nodes.list_item),\n  },\n  {\n    __type: 'wysiwyg:keymap',\n    name: 'Shift-Tab',\n    ifNode: 'list_item',\n    command: schema => liftListItem(schema.nodes.list_item),\n  },\n]\n\nfunction arrowHandler(\n  dir: 'left' | 'right' | 'up' | 'down' | 'forward' | 'backward'\n) {\n  return (state: EditorState, dispatch: any, view: EditorView) => {\n    if (view.endOfTextblock(dir)) {\n      const side = dir == 'left' || dir == 'up' ? -1 : 1\n      const $head = state.selection.$head\n      const nextPos = Selection.near(\n        state.doc.resolve(side > 0 ? $head.after() : $head.before()),\n        side\n      )\n      if (nextPos.$head) {\n        const { name } = nextPos.$head.parent.type\n        if (\n          name == 'code_block' ||\n          name === 'table_header' ||\n          name === 'table_cell'\n        ) {\n          dispatch(state.tr.setSelection(nextPos))\n          return true\n        }\n      }\n    }\n    return false\n  }\n}\n\nconst tab = goToCell(1)\n\nconst shiftTab = goToCell(-1)\n\nfunction goToCell(dir: number) {\n  return (state: EditorState, dispatch: any) => {\n    const { table } = state.schema.nodes\n    const parentTable = findParentNodeOfType(table)(state.selection)\n    if (parentTable) {\n      TableCommands.goToNextCell(1 * dir)(state, dispatch)\n      return true\n    }\n    return false\n  }\n}\n\nexport function isListType(listType: NodeType) {\n  return function(state: EditorState) {\n    const { $from, $to } = state.selection\n    const range = $from.blockRange(\n      $to,\n      node => !!(node.firstChild && node.firstChild.type == listType)\n    )\n    return range && state.doc.child(range.start).type == listType\n  }\n}\n\nexport function isNotAList(state: EditorState) {\n  const { ordered_list, bullet_list } = state.schema.nodes\n  const { $from, $to } = state.selection\n  const range = $from.blockRange(\n    $to,\n    node =>\n      !!(\n        node.firstChild &&\n        (node.firstChild.type == ordered_list ||\n          node.firstChild.type == bullet_list)\n      )\n  )\n  return (\n    range &&\n    state.doc.child(range.start).type != ordered_list &&\n    state.doc.child(range.start).type != bullet_list\n  )\n}\n\nexport function switchListType(listType: NodeType) {\n  return function(state: EditorState, dispatch: any) {\n    const itemType = state.schema.nodes.list_item\n    const { $from, $to } = state.selection\n    const range = $from.blockRange(\n      $to,\n      node => !!(node.firstChild && node.firstChild.type == itemType)\n    )\n    if (!range) return false\n    if (!dispatch) return true\n\n    const tr = state.tr\n    const $start = tr.doc.resolve(range.start)\n    // Get the\n    console.log({\n      range,\n      $start,\n      parent: range.parent,\n    })\n    dispatch((tr as any).setNodeMarkup(range.start - 1, listType))\n    return true\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport {\n  baseKeymap,\n  chainCommands,\n  createParagraphNear,\n  liftEmptyBlock,\n  splitBlock,\n} from 'prosemirror-commands'\nimport { Schema } from 'prosemirror-model'\n\nimport { KeymapPlugin } from '../../types'\nimport { findPlugins } from '../../components/ProsemirrorEditor/utils/plugin'\nimport { KEYMAP_PLUGINS } from './keymap'\n\nconst mac =\n  typeof navigator != 'undefined' ? /Mac/.test(navigator.platform) : false\n\nexport function buildKeymap(schema: Schema) {\n  const keys: any = {\n    ...baseKeymap,\n  }\n\n  function bind(key: string, cmd: any) {\n    if (keys[key]) {\n      cmd = chainCommands(cmd, keys[key])\n    }\n    keys[key] = cmd\n  }\n\n  bind('Enter', chainCommands(createParagraphNear, liftEmptyBlock, splitBlock))\n\n  findPlugins<KeymapPlugin>('wysiwyg:keymap', KEYMAP_PLUGINS).forEach(\n    plugin => {\n      let skip = false\n\n      // Exit early if this is a Mac, and it shouldn't be added for Mac.\n      if (plugin.unlessMac && mac) skip = true\n\n      // Exit early if it is for a mark type that doesn't exist.\n      if (plugin.ifMark && !schema.marks[plugin.ifMark]) skip = true\n\n      // Exit early if it is for a node type that doesn't exist.\n      if (plugin.ifNode && !schema.nodes[plugin.ifNode]) skip = true\n      if (plugin.ifNodes && !plugin.ifNodes.some(n => schema.nodes[n]))\n        skip = true\n\n      // Exit if condition not met\n      if (plugin.onCondition && !plugin.onCondition(schema)) skip = true\n\n      // Bind the command\n      if (!skip) bind(plugin.name, plugin.command(schema))\n    }\n  )\n\n  return keys\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Plugin } from '@tinacms/core'\n\nfunction byType(__type: string) {\n  return (plugin: Plugin) => plugin.__type === __type\n}\n\nexport function findPlugins<P extends Plugin>(type: string, plugins: Plugin[]) {\n  return plugins.filter(byType(type)) as P[]\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport {\n  InputRule,\n  textblockTypeInputRule,\n  wrappingInputRule,\n} from 'prosemirror-inputrules'\nimport { MarkType, NodeType, Schema } from 'prosemirror-model'\nimport { EditorState } from 'prosemirror-state'\n\nimport { singleMarkCommand } from '../../Inline/commands'\n\nconst star = '\\\\*'\nconst double = (boundary: string) =>\n  new RegExp(\n    `${boundary}${boundary}([^\\r\\n\\t\\f${boundary}} ](.*[^\\r\\n\\t\\f${boundary} ])?)${boundary}${boundary}`\n  )\nconst single = (boundary: string) =>\n  new RegExp(\n    `(^|[^${boundary}])${boundary}([^\\r\\n\\t\\f${boundary} ](.*[^\\r\\n\\t\\f${boundary} ])?)${boundary}`\n  )\n\nexport const STRONG = double(star)\nexport const EM = single(star)\nexport const S = double('~')\n\nexport const EM_UNDERSCORE = single('_')\nexport const CODE = single('`')\n\nexport function buildInputRules(schema: Schema) {\n  const rules = []\n  let type: NodeType\n  if ((type = schema.nodes.blockquote)) rules.push(blockQuoteRule(type))\n  if ((type = schema.nodes.ordered_list)) rules.push(orderedListRule(type))\n  if ((type = schema.nodes.bullet_list)) rules.push(bulletListRule(type))\n  if ((type = schema.nodes.code_block)) rules.push(codeBlockRule(type))\n  if ((type = schema.nodes.heading)) rules.push(headingRule(type, 6))\n  if ((type = schema.nodes.horizontal_rule))\n    rules.push(horizontalRuleRule(type))\n  let mark: MarkType\n  if ((mark = schema.marks.strong)) {\n    rules.push(strongStarRule(mark))\n    rules.push(strongUnderRule(mark))\n  }\n  if ((mark = schema.marks.strike)) {\n    rules.push(strikethroughRule(mark))\n  }\n  if ((mark = schema.marks.em)) {\n    rules.push(emStarRule(mark))\n    rules.push(emUnderRule(mark))\n  }\n  if ((mark = schema.marks.code)) rules.push(codeRule(mark))\n  return rules\n}\n\nfunction markInputRule(regexp: RegExp, markType: MarkType, getAttrs: any) {\n  return new InputRule(regexp, ((\n    state: EditorState,\n    match: string[],\n    start: number,\n    end: number\n  ) => {\n    const attrs = getAttrs instanceof Function ? getAttrs(match) : getAttrs\n    const tr = state.tr\n\n    if (match[1]) {\n      const textStart = start + match[0].indexOf(match[1])\n      const textEnd = textStart + match[1].length\n      if (textEnd < end) tr.delete(textEnd, end)\n      if (textStart > start) tr.delete(start, textStart)\n      end = start + match[1].length\n    }\n\n    tr.addMark(start, end, markType.create(attrs))\n    tr.removeStoredMark(markType)\n    return tr\n  }) as any) // todo: the typing broke this\n}\n\nfunction singleMarkInputRule(\n  regexp: RegExp,\n  markType: MarkType,\n  getAttrs: any\n) {\n  const command = singleMarkCommand(markType, getAttrs)\n  return new InputRule(regexp, ((\n    state: EditorState,\n    match: any,\n    start: number,\n    end: number\n  ) => {\n    return command(state, null, match, start, end)\n  }) as any) // todo: broke by new typings\n}\n\nexport function strongStarRule(markType: MarkType) {\n  return markInputRule(STRONG, markType, {})\n}\n\nexport function strikethroughRule(markType: MarkType) {\n  return markInputRule(S, markType, {})\n}\n\nexport function strongUnderRule(markType: MarkType) {\n  return markInputRule(double('_'), markType, {})\n}\n\nexport function emStarRule(markType: MarkType) {\n  return singleMarkInputRule(EM, markType, {})\n}\n\nexport function emUnderRule(markType: MarkType) {\n  return singleMarkInputRule(EM_UNDERSCORE, markType, {})\n}\n\nexport function codeRule(markType: MarkType) {\n  return singleMarkInputRule(CODE, markType, {})\n}\n\n// : (NodeType)  InputRule\n// Given a blockquote node type, returns an input rule that turns `\"> \"`\n// at the start of a textblock into a blockquote.\nexport function blockQuoteRule(nodeType: NodeType) {\n  return wrappingInputRule(/^\\s*>\\s$/, nodeType)\n}\n\n// : (NodeType)  InputRule\n// Given a list node type, returns an input rule that turns a number\n// followed by a dot at the start of a textblock into an ordered list.\nexport function orderedListRule(nodeType: NodeType) {\n  return wrappingInputRule(\n    /^(\\d+)\\.\\s$/,\n    nodeType,\n    match => ({ order: +match[1] }),\n    (match, node) => node.childCount + node.attrs.order == +match[1]\n  )\n}\n\nexport function horizontalRuleRule(nodeType: NodeType) {\n  return new InputRule(/^(---|___|\\*\\*\\*)$/, (state, _match, start, end) => {\n    return state.tr.replaceRangeWith(start, end, nodeType.create()) as any\n  })\n}\n\n// : (NodeType)  InputRule\n// Given a list node type, returns an input rule that turns a bullet\n// (dash, plush, or asterisk) at the start of a textblock into a\n// bullet list.\nexport function bulletListRule(nodeType: NodeType) {\n  return wrappingInputRule(/^\\s*([-+*])\\s$/, nodeType)\n}\n\n// : (NodeType)  InputRule\n// Given a code block node type, returns an input rule that turns a\n// textblock starting with three backticks into a code block.\nexport function codeBlockRule(nodeType: NodeType) {\n  return textblockTypeInputRule(/^```([a-zA-Z]*)? $/, nodeType, match => {\n    const language = match[1]\n    if (language) {\n      return { params: language }\n    }\n    return {}\n  })\n}\n\n// : (NodeType, number)  InputRule\n// Given a node type and a maximum level, creates an input rule that\n// turns up to that number of `#` characters followed by a space at\n// the start of a textblock into a heading whose level corresponds to\n// the number of `#` signs.\nexport function headingRule(nodeType: NodeType, maxLevel: number) {\n  return textblockTypeInputRule(\n    new RegExp('^(#{1,' + maxLevel + '})\\\\s$'),\n    nodeType,\n    match => ({\n      level: match[1].length,\n    })\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { MarkType } from 'prosemirror-model'\n\nexport function singleMarkCommand(markType: MarkType, getAttrs: any) {\n  // Version 1\n  return function command(\n    state: EditorState,\n    dispatch: any,\n    match: any,\n    start: number,\n    end: number\n  ) {\n    const attrs = getAttrs instanceof Function ? getAttrs(match) : getAttrs\n    const tr = state.tr\n\n    const offset = match[1].length\n    const textGroup = 2\n\n    if (match[textGroup]) {\n      const textStart = start + 1 + offset\n      const textEnd = textStart + match[textGroup].length\n\n      const deleteStart: [number, number] = [textStart - 1, textStart]\n      const nextChar = getNextChar(state, textEnd)\n      const deleteEndEnd = nextChar ? 0 : 1\n      const deleteEnd: [number, number] = [textEnd, textEnd + deleteEndEnd]\n      // console.log({\n      //   match,\n      //   start,\n      //   end,\n      //   offset,\n      //   textStart,\n      //   textEnd,\n      //   deleteStart,\n      //   deleteEnd,\n      // })\n      tr.delete(...deleteEnd)\n      tr.delete(...deleteStart)\n      end = start + match[textGroup].length + offset\n    }\n\n    tr.addMark(start + offset, end, markType.create(attrs))\n    tr.removeStoredMark(markType)\n    if (dispatch) {\n      dispatch(tr)\n    }\n    return tr\n  }\n}\n\nfunction getNextChar(state: EditorState, textEnd: number) {\n  try {\n    return state.doc.textBetween(textEnd + 1, textEnd + 2)\n  } catch (e) {\n    return ''\n  }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { inputRules as pmInputRules } from 'prosemirror-inputrules'\nimport { Schema } from 'prosemirror-model'\n\nimport { buildInputRules } from './inputRules'\n\nexport * from './inputRules'\n\nexport function inputRules(schema: Schema) {\n  return pmInputRules({ rules: buildInputRules(schema) })\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorState } from 'prosemirror-state'\nimport { Schema } from 'prosemirror-model'\nimport { dropCursor } from 'prosemirror-dropcursor'\nimport { gapCursor } from 'prosemirror-gapcursor'\nimport { history } from 'prosemirror-history'\nimport { keymap } from 'prosemirror-keymap'\nimport { tableEditing } from 'prosemirror-tables'\n\nimport { TranslatorClass } from '../../../translator'\nimport { commonPlugin } from '../../../plugins/Common'\nimport { buildKeymap } from '../../../plugins/Common/buildKeymap'\nimport { inputRules } from '../../../plugins/Common/input-rules'\nimport { imagePlugin } from '../../../plugins/Image'\nimport { codeBlockPlugin } from '../../../plugins/CodeBlock'\nimport { inlinePlugin } from '../../../plugins/Inline'\nimport { linkPlugin } from '../../../plugins/Link'\nimport { tablePlugin } from '../../../plugins/Table'\nimport { ImageProps } from '../../../types'\n\nexport function buildEditorState(\n  schema: Schema,\n  translator: TranslatorClass,\n  value: string,\n  imageProps?: ImageProps\n) {\n  const plugins = [\n    commonPlugin,\n    inlinePlugin,\n    inputRules(schema),\n    keymap(buildKeymap(schema)),\n    history(),\n    linkPlugin(),\n    dropCursor({ width: 2, color: 'rgb(0, 132, 255)' }),\n    gapCursor(),\n    tableEditing(),\n    tablePlugin,\n    codeBlockPlugin,\n  ]\n\n  if (imageProps) {\n    plugins.push(imagePlugin(imageProps))\n  }\n\n  return EditorState.create({\n    schema,\n    doc: translator.nodeFromString(value),\n    plugins,\n  })\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { EditorView } from 'prosemirror-view'\n\nimport { buildSchema } from '../../../schema'\nimport { buildTranslator } from './buildTranslator'\nimport { Format } from '../../../translator'\nimport { ImageProps, Input } from '../../../types'\n\nimport { buildEditorState } from './buildEditorState'\nimport { TextSelection } from 'prosemirror-state'\n\nexport const buildEditor = (\n  input: Input,\n  el: HTMLDivElement | undefined | null,\n  setEditorView: ({ view }: { view: EditorView }) => void,\n  imageProps?: ImageProps,\n  format?: Format\n): { translator?: any } => {\n  const schema = buildSchema()\n  const translator = buildTranslator(schema, format)\n\n  if (!el) return {}\n\n  /**\n   * Create a new Prosemirror EditorView on in the DOM\n   */\n  const view = new EditorView(el, {\n    /**\n     * The initial state of the Wysiwyg\n     */\n    state: buildEditorState(schema, translator, input.value, imageProps),\n    /**\n     * Call input.onChange with the translated content after updating\n     * the Prosemiror state.\n     * @param tr\n     */\n    dispatchTransaction(tr) {\n      const nextState: any = view.state.apply(tr as any)\n\n      view.updateState(nextState as any)\n      setEditorView({ view })\n\n      if (tr.docChanged && !tr.getMeta('input-update')) {\n        input.onChange(translator!.stringFromNode(tr.doc))\n      }\n    },\n  })\n\n  const { state, dispatch } = view\n  const { tr, doc } = state\n  dispatch(\n    tr.setSelection(new TextSelection(doc.resolve(doc.content.size) || 0))\n  )\n  view.focus()\n\n  setEditorView({ view })\n\n  return { translator }\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { Schema } from 'prosemirror-model'\nimport { MarkdownTranslator, Format, DOMTranslator } from '../../../translator'\n\nexport const buildTranslator = (\n  schema: Schema,\n  format: Format = 'markdown'\n) => {\n  if (format === 'html') return DOMTranslator.fromSchema(schema)\n  return MarkdownTranslator.fromSchema(schema)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport * as ReactDOM from 'react-dom'\nimport styled from 'styled-components'\nimport { EditorView } from 'prosemirror-view'\nimport { deleteColumn, deleteRow, TableMap } from 'prosemirror-tables'\nimport {\n  findParentNodeOfType,\n  forEachCellInColumn,\n  setCellAttrs,\n} from 'prosemirror-utils'\nimport { IconButton } from '@tinacms/styles'\nimport { AlignCenter, AlignLeft, AlignRight, TrashIcon } from '@tinacms/icons'\n\nimport { useEditorStateContext } from '../../../context/editorState'\n\nconst alignColumn = (view: EditorView, alignValue: string) => {\n  const { state, dispatch } = view\n  const { selection } = state\n  const { table, table_cell, table_header } = state.schema.nodes\n  const tableCell = findParentNodeOfType(table_cell)(state.selection)\n  const tableHeader = findParentNodeOfType(table_header)(state.selection)\n  const cellNode = tableCell || tableHeader\n  if (!cellNode) return\n  const align =\n    cellNode.node.attrs.align === alignValue ? undefined : alignValue\n  const tableNode = findParentNodeOfType(table)(state.selection)\n  if (!tableNode) return\n  const tableMap = TableMap.get(tableNode.node)\n  const pos = Object.entries(tableMap.map).find(\n    entry => entry[1] > selection.head - tableNode.start\n  )\n  if (!pos) return\n  const cellPos = parseInt(pos[0]) - 1\n  const columnPos = cellPos % tableMap.width\n  dispatch(\n    forEachCellInColumn(columnPos, (cell, tr) => {\n      return setCellAttrs(cell, { align })(tr)\n    })(state.tr)\n  )\n  view.focus()\n}\n\nexport default () => {\n  const { editorView } = useEditorStateContext()\n  if (!editorView) return null\n  const { state, dispatch } = editorView.view\n  const markerDivTable = document.getElementsByClassName(\n    'tina_table_header_ext_top_left_selected'\n  )[0]\n  if (markerDivTable) return null\n  const markerDivCol = document.getElementsByClassName(\n    'tina_table_header_ext_top_selected'\n  )[0]\n  const markerDivRows = document.getElementsByClassName(\n    'tina_table_header_ext_left'\n  )\n  let markerDivRow\n  for (let i = 1; i < markerDivRows.length; i++) {\n    if (\n      markerDivRows[i].classList.contains('tina_table_header_ext_left_selected')\n    )\n      markerDivRow = markerDivRows[i]\n  }\n  if (!markerDivCol && !markerDivRow) return null\n  const { view } = editorView\n  return (\n    <>\n      {markerDivCol &&\n        ReactDOM.createPortal(\n          <IconWrapperCol>\n            <IconButton onClick={() => alignColumn(view, 'left')} small primary>\n              <AlignLeft />\n            </IconButton>\n            <IconButton\n              onClick={() => alignColumn(view, 'center')}\n              small\n              primary\n            >\n              <AlignCenter />\n            </IconButton>\n            <IconButton\n              onClick={() => alignColumn(view, 'right')}\n              small\n              primary\n            >\n              <AlignRight />\n            </IconButton>\n            <IconButton\n              onClick={() => {\n                deleteColumn(state, dispatch)\n                view.focus()\n              }}\n              small\n              primary\n            >\n              <TrashIcon />\n            </IconButton>\n          </IconWrapperCol>,\n          markerDivCol\n        )}\n      {markerDivRow &&\n        ReactDOM.createPortal(\n          <IconWrapperRow>\n            <IconButton\n              onClick={() => {\n                deleteRow(state, dispatch)\n                view.focus()\n              }}\n              small\n              primary\n            >\n              <TrashIcon />\n            </IconButton>\n          </IconWrapperRow>,\n          markerDivRow\n        )}\n    </>\n  )\n}\n\nconst IconWrapperCol = styled.span`\n  display: flex;\n  left: 50%;\n  position: absolute;\n  top: -8px;\n  transform: translate3d(-50%, -100%, 0);\n  button:not(:first-of-type) {\n    margin-left: 10px;\n  }\n`\n\nconst IconWrapperRow = styled.span`\n  position: absolute;\n  top: 50%;\n  left: -8px;\n  transform: translate3d(-100%, -50%, 0);\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { useState, useEffect, HTMLAttributes } from 'react'\nimport * as ReactDOM from 'react-dom'\nimport styled from 'styled-components'\nimport { IconButton } from '@tinacms/styles'\nimport { EditorView } from 'prosemirror-view'\nimport { addColumnAt } from 'prosemirror-utils'\nimport { AddIcon } from '@tinacms/icons'\n\nconst borderWidth = 1\nconst controlSize = 12\n\ninterface AddColumnProps {\n  index: number\n  marker: HTMLElement\n  tableHeight: number\n  view: EditorView\n}\n\nexport default ({ index, marker, tableHeight, view }: AddColumnProps) => {\n  const { state, dispatch } = view\n  const addColumn = (pos: number) => {\n    dispatch(addColumnAt(pos)(state.tr))\n    view.focus()\n  }\n\n  const [hovered, setHovered] = useState(false)\n\n  useEffect(() => {\n    if (hovered) marker.style.zIndex = '1000'\n    else marker.style.zIndex = '1'\n  }, [hovered])\n\n  return ReactDOM.createPortal(\n    <>\n      <Wrapper\n        onMouseEnter={() => setHovered(true)}\n        onMouseLeave={() => setHovered(false)}\n      >\n        {hovered ? (\n          <IconWrapperCol>\n            <IconButton\n              onClick={() => {\n                addColumn(index)\n                setHovered(false)\n              }}\n              small\n              primary\n            >\n              <AddIcon />\n            </IconButton>\n          </IconWrapperCol>\n        ) : (\n          <Pointer />\n        )}\n      </Wrapper>\n      {hovered && <ColumnDivider height={tableHeight}></ColumnDivider>}\n    </>,\n    marker\n  )\n}\n\nconst Wrapper = styled.div`\n  top: -7px;\n  position: absolute;\n  right: 0;\n  padding: 8px;\n  transform: translate3d(50%, -100%, 0);\n  user-select: none;\n`\n\nconst Pointer = styled.div`\n  background: #e1ddec;\n  border-radius: 50%;\n  height: 4px;\n  width: 4px;\n`\n\nconst IconWrapperCol = styled.span`\n  position: absolute;\n  top: 0;\n  left: 50%;\n  transform: translate3d(-50%, -50%, 0);\n`\n\nconst ColumnDivider = styled.div<\n  HTMLAttributes<HTMLDivElement> & { height: number }\n>`\n  position: absolute;\n  background: #0574e4;\n  top: ${-1 * borderWidth}px;\n  z-index: 1000;\n  right: ${-1 * borderWidth}px;\n  width: ${2 * borderWidth}px;\n  height: ${({ height }) => `${height + controlSize - borderWidth}px`};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React, { useEffect, useState, HTMLAttributes } from 'react'\nimport * as ReactDOM from 'react-dom'\nimport { EditorView } from 'prosemirror-view'\nimport { TableMap } from 'prosemirror-tables'\nimport {\n  addRowAt,\n  findParentNodeOfType,\n  getCellsInRow,\n} from 'prosemirror-utils'\nimport styled from 'styled-components'\nimport { AddIcon } from '@tinacms/icons'\nimport { IconButton } from '@tinacms/styles'\n\nconst borderWidth = 1\nconst controlSize = 12\n\ninterface AddRowProps {\n  index: number\n  marker: HTMLElement\n  tableWidth: number\n  view: EditorView\n}\n\nexport default ({ index, marker, tableWidth, view }: AddRowProps) => {\n  const { state, dispatch } = view\n  const addRow = (pos: number) => {\n    if (pos > 1) dispatch(addRowAt(pos, true)(state.tr))\n    else {\n      const { table, table_cell, table_row } = state.schema.nodes\n      const tableNode = findParentNodeOfType(table)(state.selection)\n      if (!tableNode) return\n      const tableMap = TableMap.get(tableNode.node)\n      const position = tableNode.start + tableMap.map[tableMap.width] - 1\n      const cellInNextRow = getCellsInRow(0)(state.selection)\n      if (!cellInNextRow) return\n      const cells = cellInNextRow?.map(cell =>\n        table_cell.createAndFill({ ...cell.node.attrs })\n      )\n      dispatch(state.tr.insert(position, table_row.create(null, cells)))\n    }\n    view.focus()\n  }\n\n  const [hovered, setHovered] = useState(false)\n\n  useEffect(() => {\n    if (hovered) marker.style.zIndex = '1000'\n    else marker.style.zIndex = '1'\n  }, [hovered])\n\n  return ReactDOM.createPortal(\n    <>\n      <Wrapper\n        onMouseEnter={() => setHovered(true)}\n        onMouseLeave={() => setHovered(false)}\n      >\n        {hovered && index > 0 ? (\n          <IconWrapperRow>\n            <IconButton onClick={() => addRow(index)} small primary>\n              <AddIcon />\n            </IconButton>\n          </IconWrapperRow>\n        ) : (\n          <Pointer />\n        )}\n      </Wrapper>\n      {hovered && <ColumnDivider width={tableWidth}></ColumnDivider>}\n    </>,\n    marker\n  )\n}\n\nconst Wrapper = styled.div`\n  left: -7px;\n  position: absolute;\n  bottom: 0;\n  padding: 8px;\n  transform: translate3d(-100%, 50%, 0);\n  user-select: none;\n`\n\nconst Pointer = styled.div`\n  background: #e1ddec;\n  border-radius: 50%;\n  height: 4px;\n  width: 4px;\n`\n\nconst IconWrapperRow = styled.span`\n  position: absolute;\n  top: 50%;\n  left: 0;\n  transform: translate3d(-50%, -50%, 0);\n`\n\nconst ColumnDivider = styled.div<\n  HTMLAttributes<HTMLDivElement> & { width: number }\n>`\n  position: absolute;\n  background: #0574e4;\n  left: ${-1 * borderWidth}px;\n  z-index: var(--tina-z-index-1);\n  bottom: ${-1 * borderWidth}px;\n  height: ${2 * borderWidth}px;\n  width: ${({ width }) => `${width + controlSize - borderWidth}px`};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\n\nimport { useEditorStateContext } from '../../../context/editorState'\nimport AddColumn from './AddColumn'\nimport AddRow from './AddRow'\n\nexport default () => {\n  const { editorView } = useEditorStateContext()\n  if (!editorView) return null\n  const markerDivTable = document.getElementsByClassName(\n    'tina_table_header_ext_top_left'\n  )\n  if (!markerDivTable.length) return null\n  const tableElm = markerDivTable[0].closest('table')\n  if (!tableElm) return null\n  const { height, width } = tableElm.getBoundingClientRect()\n  const markerDivCol = document.getElementsByClassName(\n    'tina_table_header_ext_top'\n  )\n  const markerCols = [markerDivTable[0]]\n  for (let i = 0; i < markerDivCol.length; i++) {\n    markerCols.push(markerDivCol[i])\n  }\n  const markerDivRow = document.getElementsByClassName(\n    'tina_table_header_ext_left'\n  )\n  const markerRows = [markerDivTable[0]]\n  for (let i = 0; i < markerDivRow.length; i++) {\n    markerRows.push(markerDivRow[i])\n  }\n  const { view } = editorView\n  return (\n    <>\n      {markerCols.map((marker, index) => (\n        <AddColumn\n          key={`add-column-menu-${index}`}\n          index={index}\n          marker={marker as HTMLElement}\n          tableHeight={height}\n          view={view}\n        />\n      ))}\n      {markerRows.map((marker, index) => (\n        <AddRow\n          key={`add-row-menu-${index}`}\n          index={index}\n          marker={marker as HTMLElement}\n          tableWidth={width}\n          view={view}\n        />\n      ))}\n    </>\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport ReactDOM from 'react-dom'\nimport { deleteTable } from 'prosemirror-tables'\nimport styled from 'styled-components'\n\nimport { TrashIcon } from '@tinacms/icons'\nimport { IconButton } from '@tinacms/styles'\n\nimport { useEditorStateContext } from '../../../context/editorState'\n\nexport default () => {\n  const { editorView } = useEditorStateContext()\n  if (!editorView) return null\n  const { view } = editorView\n  const deleteSelectedTable = () => {\n    const { state, dispatch } = view\n    deleteTable(state, dispatch)\n    view.focus()\n  }\n  const markerDivTable = document.getElementsByClassName(\n    'tina_table_header_ext_top_left_selected'\n  )\n  if (!markerDivTable.length) return null\n  const tableElm = markerDivTable[0].closest('table')\n  if (!tableElm) return null\n  const { height, width } = tableElm.getBoundingClientRect()\n  return ReactDOM.createPortal(\n    <Wrapper height={height} width={width}>\n      <IconButton onClick={deleteSelectedTable} small primary>\n        <TrashIcon />\n      </IconButton>\n    </Wrapper>,\n    markerDivTable[0]\n  )\n}\n\nconst Wrapper = styled.div<\n  React.HTMLAttributes<HTMLDivElement> & { height: number; width: number }\n>`\n  background-color: #ffffff;\n  border-radius: 2px;\n  cursor: default;\n  padding: 0px 4px;\n  position: absolute;\n  top: ${({ height }) => `${height + 24}px`};\n  left: ${({ width }) => `${width / 2 - 8}px`};\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\n\nimport ColumnPopup from './ColumnPopup'\nimport AddPopup from './AddPopup'\nimport OptionsPopup from './OptionsPopup'\n\nexport const TablePopups = () => (\n  <>\n    <ColumnPopup />\n    <AddPopup />\n    <OptionsPopup />\n  </>\n)\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\n\nimport { ProsemirrorMenu as BlockMenu } from '../../../plugins/Block'\nimport { ProsemirrorMenu as CodeBlockMenu } from '../../../plugins/CodeBlock'\nimport { ProsemirrorMenu as HistoryMenu } from '../../../plugins/History'\nimport { ProsemirrorMenu as InlineMenu } from '../../../plugins/Inline'\nimport { ProsemirrorMenu as ListMenu } from '../../../plugins/List'\nimport { ProsemirrorMenu as QuoteMenu } from '../../../plugins/Blockquote'\nimport { ProsemirrorMenu as TableMenu } from '../../../plugins/Table'\nimport { ProsemirrorMenu as ImageMenu } from '../../../plugins/Image'\nimport { ProsemirrorMenu as LinkMenu } from '../../../plugins/Link'\n\nimport { TablePopups } from '../../../plugins/Table/Popup'\nimport {\n  ImageEdit as ImageEditPopup,\n  Loader as ImageLoader,\n} from '../../../plugins/Image'\nimport { LinkForm as LinkFormPopup } from '../../../plugins/Link'\n\nimport { Plugin } from '../../../types'\nimport { useEditorStateContext } from '../../../context/editorState'\nimport { BaseMenubar } from '../../BaseMenubar'\n\ninterface Props {\n  sticky?: boolean | string\n  uploadImages?: (files: File[]) => Promise<string[]>\n  plugins?: Plugin[]\n}\n\nexport const Menubar = ({ plugins, uploadImages, ...rest }: Props) => {\n  const { editorView } = useEditorStateContext()\n\n  if (!editorView) return null\n\n  return (\n    <BaseMenubar\n      {...rest}\n      menus={[\n        <BlockMenu />,\n        <InlineMenu />,\n        <LinkMenu />,\n        <ImageMenu uploadImages={uploadImages} />,\n        <TableMenu />,\n        <QuoteMenu />,\n        <CodeBlockMenu />,\n        <ListMenu />,\n        <HistoryMenu />,\n      ]}\n      popups={[\n        <TablePopups />,\n        <ImageEditPopup />,\n        <LinkFormPopup />,\n        <ImageLoader />,\n      ]}\n      plugins={plugins}\n    />\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { css } from 'styled-components'\n\nexport const CodeMirrorCss = css`\n  white-space: pre-wrap;\n\n  .CodeMirror {\n    font-family: monospace;\n    height: auto;\n    width: 100%;\n    border-radius: 5px;\n    margin-bottom: 16px;\n    color: black;\n    direction: ltr;\n  }\n\n  .CodeMirror-lines {\n    padding: 4px 0; /* Vertical padding around content */\n  }\n  .CodeMirror pre.CodeMirror-line,\n  .CodeMirror pre.CodeMirror-line-like {\n    padding: 0 4px; /* Horizontal padding of content */\n  }\n\n  .CodeMirror-scrollbar-filler,\n  .CodeMirror-gutter-filler {\n    background-color: white; /* The little square between H and V scrollbars */\n  }\n\n  /* GUTTER */\n\n  .CodeMirror-gutters {\n    border-right: 1px solid #ddd;\n    background-color: #f7f7f7;\n    white-space: nowrap;\n  }\n  .CodeMirror-linenumbers {\n  }\n  .CodeMirror-linenumber {\n    padding: 0 3px 0 5px;\n    min-width: 20px;\n    text-align: right;\n    color: #999;\n    white-space: nowrap;\n  }\n\n  .CodeMirror-guttermarker {\n    color: black;\n  }\n  .CodeMirror-guttermarker-subtle {\n    color: #999;\n  }\n\n  /* CURSOR */\n\n  .CodeMirror-cursor {\n    border-left: 1px solid black;\n    border-right: none;\n    width: 0;\n  }\n  /* Shown when moving in bi-directional text */\n  .CodeMirror div.CodeMirror-secondarycursor {\n    border-left: 1px solid silver;\n  }\n  .cm-fat-cursor .CodeMirror-cursor {\n    width: auto;\n    border: 0 !important;\n    background: #7e7;\n  }\n  .cm-fat-cursor div.CodeMirror-cursors {\n    z-index: 1;\n  }\n  .cm-fat-cursor-mark {\n    background-color: rgba(20, 255, 20, 0.5);\n    -webkit-animation: blink 1.06s steps(1) infinite;\n    -moz-animation: blink 1.06s steps(1) infinite;\n    animation: blink 1.06s steps(1) infinite;\n  }\n  .cm-animate-fat-cursor {\n    width: auto;\n    border: 0;\n    -webkit-animation: blink 1.06s steps(1) infinite;\n    -moz-animation: blink 1.06s steps(1) infinite;\n    animation: blink 1.06s steps(1) infinite;\n    background-color: #7e7;\n  }\n  @-moz-keyframes blink {\n    0% {\n    }\n    50% {\n      background-color: transparent;\n    }\n    100% {\n    }\n  }\n  @-webkit-keyframes blink {\n    0% {\n    }\n    50% {\n      background-color: transparent;\n    }\n    100% {\n    }\n  }\n  @keyframes blink {\n    0% {\n    }\n    50% {\n      background-color: transparent;\n    }\n    100% {\n    }\n  }\n\n  /* Can style cursor different in overwrite (non-insert) mode */\n  .CodeMirror-overwrite .CodeMirror-cursor {\n  }\n\n  .cm-tab {\n    display: inline-block;\n    text-decoration: inherit;\n  }\n\n  .CodeMirror-rulers {\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: -50px;\n    bottom: 0;\n    overflow: hidden;\n  }\n  .CodeMirror-ruler {\n    border-left: 1px solid #ccc;\n    top: 0;\n    bottom: 0;\n    position: absolute;\n  }\n\n  /* DEFAULT THEME */\n\n  .cm-s-default .cm-header {\n    color: blue;\n  }\n  .cm-s-default .cm-quote {\n    color: #090;\n  }\n  .cm-negative {\n    color: #d44;\n  }\n  .cm-positive {\n    color: #292;\n  }\n  .cm-header,\n  .cm-strong {\n    font-weight: bold;\n  }\n  .cm-em {\n    font-style: italic;\n  }\n  .cm-link {\n    text-decoration: underline;\n  }\n  .cm-strikethrough {\n    text-decoration: line-through;\n  }\n\n  .cm-s-default .cm-keyword {\n    color: #708;\n  }\n  .cm-s-default .cm-atom {\n    color: #219;\n  }\n  .cm-s-default .cm-number {\n    color: #164;\n  }\n  .cm-s-default .cm-def {\n    color: #00f;\n  }\n  .cm-s-default .cm-variable,\n  .cm-s-default .cm-punctuation,\n  .cm-s-default .cm-property,\n  .cm-s-default .cm-operator {\n  }\n  .cm-s-default .cm-variable-2 {\n    color: #05a;\n  }\n  .cm-s-default .cm-variable-3,\n  .cm-s-default .cm-type {\n    color: #085;\n  }\n  .cm-s-default .cm-comment {\n    color: #a50;\n  }\n  .cm-s-default .cm-string {\n    color: #a11;\n  }\n  .cm-s-default .cm-string-2 {\n    color: #f50;\n  }\n  .cm-s-default .cm-meta {\n    color: #555;\n  }\n  .cm-s-default .cm-qualifier {\n    color: #555;\n  }\n  .cm-s-default .cm-builtin {\n    color: #30a;\n  }\n  .cm-s-default .cm-bracket {\n    color: #997;\n  }\n  .cm-s-default .cm-tag {\n    color: #170;\n  }\n  .cm-s-default .cm-attribute {\n    color: #00c;\n  }\n  .cm-s-default .cm-hr {\n    color: #999;\n  }\n  .cm-s-default .cm-link {\n    color: #00c;\n  }\n\n  .cm-s-default .cm-error {\n    color: #f00;\n  }\n  .cm-invalidchar {\n    color: #f00;\n  }\n\n  .CodeMirror-composing {\n    border-bottom: 2px solid;\n  }\n\n  /* Default styles for common addons */\n\n  div.CodeMirror span.CodeMirror-matchingbracket {\n    color: #0b0;\n  }\n  div.CodeMirror span.CodeMirror-nonmatchingbracket {\n    color: #a22;\n  }\n  .CodeMirror-matchingtag {\n    background: rgba(255, 150, 0, 0.3);\n  }\n  .CodeMirror-activeline-background {\n    background: #e8f2ff;\n  }\n\n  /* STOP */\n\n  /* The rest of this file contains styles related to the mechanics of\n    the editor. You probably shouldn't touch them. */\n\n  .CodeMirror {\n    position: relative;\n    overflow: hidden;\n    background: white;\n  }\n\n  .CodeMirror-scroll {\n    overflow: scroll !important; /* Things will break if this is overridden */\n    /* 30px is the magic margin used to hide the element's real scrollbars */\n    /* See overflow: hidden in .CodeMirror */\n    margin-bottom: -30px;\n    margin-right: -30px;\n    padding-bottom: 30px;\n    height: 100%;\n    outline: none; /* Prevent dragging from highlighting the element */\n    position: relative;\n  }\n  .CodeMirror-sizer {\n    position: relative;\n    min-height: auto;\n    border-right: 30px solid transparent;\n  }\n\n  /* The fake, visible scrollbars. Used to force redraw during scrolling\n    before actual scrolling happens, thus preventing shaking and\n    flickering artifacts. */\n  .CodeMirror-vscrollbar,\n  .CodeMirror-hscrollbar,\n  .CodeMirror-scrollbar-filler,\n  .CodeMirror-gutter-filler {\n    position: absolute;\n    z-index: 6;\n    display: none;\n  }\n  .CodeMirror-vscrollbar {\n    right: 0;\n    top: 0;\n    overflow-x: hidden;\n    overflow-y: scroll;\n  }\n  .CodeMirror-hscrollbar {\n    bottom: 0;\n    left: 0;\n    overflow-y: hidden;\n    overflow-x: scroll;\n  }\n  .CodeMirror-scrollbar-filler {\n    right: 0;\n    bottom: 0;\n  }\n  .CodeMirror-gutter-filler {\n    left: 0;\n    bottom: 0;\n  }\n\n  .CodeMirror-gutters {\n    position: absolute;\n    left: 0;\n    top: 0;\n    min-height: 100%;\n    z-index: 3;\n  }\n  .CodeMirror-gutter {\n    white-space: normal;\n    height: 100%;\n    display: inline-block;\n    vertical-align: top;\n    margin-bottom: -30px;\n  }\n  .CodeMirror-gutter-wrapper {\n    position: absolute;\n    z-index: 4;\n    background: none !important;\n    border: none !important;\n  }\n  .CodeMirror-gutter-background {\n    position: absolute;\n    top: 0;\n    bottom: 0;\n    z-index: 4;\n  }\n  .CodeMirror-gutter-elt {\n    position: absolute;\n    cursor: default;\n    z-index: 4;\n  }\n  .CodeMirror-gutter-wrapper ::selection {\n    background-color: transparent;\n  }\n  .CodeMirror-gutter-wrapper ::-moz-selection {\n    background-color: transparent;\n  }\n\n  .CodeMirror-lines {\n    cursor: text;\n    min-height: 1px; /* prevents collapsing before first draw */\n  }\n  .CodeMirror pre.CodeMirror-line,\n  .CodeMirror pre.CodeMirror-line-like {\n    /* Reset some styles that the rest of the page might have set */\n    -moz-border-radius: 0;\n    -webkit-border-radius: 0;\n    border-radius: 0;\n    border-width: 0;\n    background: transparent;\n    font-family: inherit;\n    font-size: inherit;\n    margin: 0;\n    white-space: pre;\n    word-wrap: normal;\n    line-height: inherit;\n    color: inherit;\n    z-index: 2;\n    position: relative;\n    overflow: visible;\n    -webkit-tap-highlight-color: transparent;\n    -webkit-font-variant-ligatures: contextual;\n    font-variant-ligatures: contextual;\n  }\n  .CodeMirror-wrap pre.CodeMirror-line,\n  .CodeMirror-wrap pre.CodeMirror-line-like {\n    word-wrap: break-word;\n    white-space: pre-wrap;\n    word-break: normal;\n  }\n\n  .CodeMirror-linebackground {\n    position: absolute;\n    left: 0;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    z-index: 0;\n  }\n\n  .CodeMirror-linewidget {\n    position: relative;\n    z-index: 2;\n    padding: 0.1px; /* Force widget margins to stay inside of the container */\n  }\n\n  .CodeMirror-widget {\n  }\n\n  .CodeMirror-rtl pre {\n    direction: rtl;\n  }\n\n  .CodeMirror-code {\n    outline: none;\n  }\n\n  /* Force content-box sizing for the elements where we expect it */\n  .CodeMirror-scroll,\n  .CodeMirror-sizer,\n  .CodeMirror-gutter,\n  .CodeMirror-gutters,\n  .CodeMirror-linenumber {\n    -moz-box-sizing: content-box;\n    box-sizing: content-box;\n  }\n\n  .CodeMirror-measure {\n    position: absolute;\n    width: 100%;\n    height: 0;\n    overflow: hidden;\n    visibility: hidden;\n  }\n\n  .CodeMirror-cursor {\n    position: absolute;\n    pointer-events: none;\n  }\n  .CodeMirror-measure pre {\n    position: static;\n  }\n\n  div.CodeMirror-cursors {\n    visibility: hidden;\n    position: relative;\n    z-index: 3;\n  }\n  div.CodeMirror-dragcursors {\n    visibility: visible;\n  }\n\n  .CodeMirror-focused div.CodeMirror-cursors {\n    visibility: visible;\n  }\n\n  .CodeMirror-selected {\n    background: #d9d9d9;\n  }\n  .CodeMirror-focused .CodeMirror-selected {\n    background: #d7d4f0;\n  }\n  .CodeMirror-crosshair {\n    cursor: crosshair;\n  }\n  .CodeMirror-line::selection,\n  .CodeMirror-line > span::selection,\n  .CodeMirror-line > span > span::selection {\n    background: #d7d4f0;\n  }\n  .CodeMirror-line::-moz-selection,\n  .CodeMirror-line > span::-moz-selection,\n  .CodeMirror-line > span > span::-moz-selection {\n    background: #d7d4f0;\n  }\n\n  .cm-searching {\n    background-color: #ffa;\n    background-color: rgba(255, 255, 0, 0.4);\n  }\n\n  /* Used to force a border model for a node */\n  .cm-force-border {\n    padding-right: 0.1px;\n  }\n\n  @media print {\n    /* Hide the cursor when printing */\n    .CodeMirror div.CodeMirror-cursors {\n      visibility: hidden;\n    }\n  }\n\n  /* See issue #2901 */\n  .cm-tab-wrap-hack:after {\n    content: '';\n  }\n\n  /* Help users use markselection to safely style text background */\n  span.CodeMirror-selectedtext {\n    background: none;\n  }\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { css } from 'styled-components'\n\nconst paddingX = 8\nconst paddingY = 6\nconst borderWidth = 1\nconst controlSize = 12\n\nconst proseMirrorTableStyles = `\n  .ProseMirror {\n    display: block\n  }\n  .ProseMirror .tableWrapper {\n    overflow-x: auto;\n  }\n  .ProseMirror .column-resize-handle {\n    position: absolute;\n    right: -2px;\n    top: 0;\n    bottom: 0;\n    width: 4px;\n    z-index: 20;\n    background-color: #adf;\n    pointer-events: none;\n  }\n  .ProseMirror.resize-cursor {\n    cursor: ew-resize;\n    cursor: col-resize;\n  }\n  /* Give selected cells a blue overlay */\n  .ProseMirror .selectedCell:after {\n    z-index: 2;\n    position: absolute;\n    content: '';\n    left: 0;\n    right: 0;\n    top: 0;\n    bottom: 0;\n    background: rgba(0, 132, 255, 0.25);\n    /* This provides a bullet-proof border for selected cells even with border collapsing */\n    box-shadow: 0 0 0 1px #0574E4;\n    pointer-events: none;\n  }\n  .ProseMirror:focus {\n    outline: 0px solid transparent;\n  }\n  .ProseMirror p {\n    min-height: 18px;\n  }\n  .ProseMirror table {\n    border-collapse: collapse;\n    table-layout: fixed;\n    display: inline-table;\n    margin: 32px 0 32px 0;\n    overflow: visible;\n    width: 100%;\n  }\n  .ProseMirror th {\n    background-color: #F6F6F9;\n  }\n  .ProseMirror tr {\n    height: 40px;\n  }\n  .ProseMirror table td,\n  .ProseMirror table th {\n    border: 1px solid #E1DDEC;\n    padding: ${paddingY}px ${paddingX}px;\n    position: relative;\n    vertical-align: top;\n    box-sizing: border-box;\n  }\n  .ProseMirror .tina_table_header_ext_top {\n    background: #F6F6F9;\n    border: 1px solid #E1DDEC;\n    position: absolute;\n    height: ${controlSize}px;\n    width: calc(100% + ${borderWidth * 2}px);\n    transform: translate(${(borderWidth + paddingX) * -1}px, ${(controlSize +\n  paddingY) *\n  -1}px);\n    cursor: pointer;\n    z-index: 1;\n    user-select: none;\n    box-sizing: border-box;\n  }\n  .ProseMirror div.tina_table_header_ext_top_selected {\n    background: #0084ff;\n    border-color: #0574E4;\n    z-index: 10;\n  }\n  .ProseMirror .tina_table_header_ext_left {\n    background: #F6F6F9;\n    border: 1px solid #E1DDEC;\n    position: absolute;\n    height: calc(100% + ${borderWidth * 2}px);\n    width: ${controlSize}px;\n    transform: translate(${(controlSize + paddingX) * -1}px, ${(borderWidth +\n  paddingY) *\n  -1}px);\n    cursor: pointer;\n    z-index: 1;\n    user-select: none;\n    box-sizing: border-box;\n  }\n  .ProseMirror div.tina_table_header_ext_left_selected {\n    background: #0084ff;\n    border-color: #0574E4;\n    z-index: 10;\n  }\n  .ProseMirror .tina_table_header_ext_top_left {\n    background: #F6F6F9;\n    border: 1px solid #E1DDEC;\n    position: absolute;\n    height: ${controlSize}px;\n    width: ${controlSize}px;\n    transform: translate(${(controlSize + paddingX) * -1}px, ${(controlSize +\n  paddingY) *\n  -1}px);\n    border-radius: 5px 0 0 0;\n    z-index: 1;\n    cursor: pointer;\n    user-select: none;\n    box-sizing: border-box;\n  }\n  .ProseMirror div.tina_table_header_ext_top_left_selected {\n    background: #0084ff;\n    border-color: #0574E4;\n    z-index: 10;\n  }\n  .ProseMirror .selectedCell {\n    border-color: transparent;\n  }\n`\n\nexport const ProseMirrorCss = css`\n  .ProseMirror .tinacms-image-wrapper {\n    display: inline-block;\n    margin: 1em 0;\n  }\n\n  ${proseMirrorTableStyles}\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useEffect, useRef, useState } from 'react'\nimport styled from 'styled-components'\nimport { EditorView } from 'prosemirror-view'\n\nimport { EditorProps } from '../../types'\nimport { EditorStateProvider } from '../../context/editorState'\nimport { useBrowserFocusContext } from '../../context/browserFocus'\n\nimport { buildEditor } from './utils/buildEditor'\nimport { updateEditorState } from './utils/updateEditorState'\nimport { Menubar } from './Menubar'\nimport { CodeMirrorCss } from './styles/CodeMirror'\nimport { ProseMirrorCss } from './styles/ProseMirror'\n\nexport const ProsemirrorEditor = styled(\n  ({\n    input,\n    plugins,\n    sticky,\n    format,\n    imageProps,\n    ...styleProps\n  }: EditorProps) => {\n    const editorRef = useRef<HTMLDivElement | null>(null)\n    const [editorView, setEditorView] = useState<{ view: EditorView }>()\n    const [translator, setTranslator] = useState<any>()\n    const { browserFocused } = useBrowserFocusContext()\n\n    useEffect(() => {\n      // State is updated with latest value of editorRef to trigger re-render\n      const { translator: translatorObj } = buildEditor(\n        input,\n        editorRef.current,\n        setEditorView,\n        imageProps,\n        format\n      )\n      setTranslator(translatorObj)\n      return () => {\n        editorView && editorView.view.destroy()\n      }\n    }, [editorRef])\n\n    useEffect(() => {\n      const view = editorView && editorView.view\n      const editorWrapper = document.getElementsByClassName('ProseMirror')[0]\n      if (\n        !view ||\n        ((editorWrapper === document.activeElement ||\n          editorWrapper.contains(document.activeElement)) &&\n          browserFocused)\n      )\n        return\n      updateEditorState(view, translator, input.value)\n    }, [input.value])\n\n    return (\n      <WysiwygWrapper className=\"wysiwyg-wrapper\" data-testid=\"wysiwyg-editor\">\n        <link\n          rel=\"stylesheet\"\n          href=\"https://codemirror.net/lib/codemirror.css\"\n        />\n        <EditorStateProvider translator={translator} editorView={editorView}>\n          <Menubar\n            sticky={sticky}\n            uploadImages={imageProps && imageProps.upload}\n            plugins={plugins}\n          />\n        </EditorStateProvider>\n        <div {...styleProps} ref={editorRef} />\n      </WysiwygWrapper>\n    )\n  }\n)`\n  ${CodeMirrorCss}${ProseMirrorCss}\n`\n\nconst WysiwygWrapper = styled.div`\n  position: relative;\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport { TextSelection } from 'prosemirror-state'\nimport { TranslatorClass } from '../../../translator'\nimport { EditorView } from 'prosemirror-view'\n\nexport function updateEditorState(\n  view: EditorView,\n  translator: TranslatorClass,\n  value: string\n) {\n  const doc = translator.nodeFromString(value)\n  if (!doc) return\n  const { state, dispatch } = view\n  const { tr } = state\n  dispatch(\n    tr\n      .setSelection(\n        new TextSelection(\n          tr.doc.resolve(0),\n          tr.doc.resolve(state.doc.nodeSize - 2)\n        )\n      )\n      .replaceSelectionWith(doc)\n      .setMeta('input-update', true)\n  )\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport styled from 'styled-components'\n\nimport { BrowserFocusProvider } from '../../context/browserFocus'\nimport { EditorModeMenu } from '../EditorModeMenu'\nimport {\n  EditorModeProvider,\n  EditorModeConsumer,\n} from '../../context/editorMode'\nimport { EditorProps } from '../../types'\nimport { MarkdownEditor } from '../MarkdownEditor'\nimport { ProsemirrorEditor } from '../ProsemirrorEditor'\n\nconst modeTogglePlugin = {\n  name: 'wysiwygModeToggle',\n  MenuItem: () => <EditorModeMenu />,\n}\n\nexport const Wysiwyg = ({\n  imageProps,\n  input,\n  plugins = [],\n  format = 'markdown',\n  sticky,\n  className,\n}: EditorProps) => {\n  const { value, onChange } = input\n  const pluginList =\n    format === 'markdown' ? [...plugins, modeTogglePlugin] : plugins\n\n  return (\n    <EditorModeProvider>\n      <EditorModeConsumer>\n        {({ mode }) => (\n          <BrowserFocusProvider>\n            <Wrapper>\n              {mode === 'markdown' ? (\n                <MarkdownEditor\n                  value={value}\n                  onChange={onChange}\n                  imageProps={imageProps}\n                  plugins={pluginList}\n                  sticky={sticky}\n                />\n              ) : (\n                <ProsemirrorEditor\n                  input={{\n                    value,\n                    onChange: onChange,\n                  }}\n                  plugins={pluginList}\n                  sticky={sticky}\n                  format={format}\n                  imageProps={imageProps}\n                  className={className}\n                />\n              )}\n            </Wrapper>\n          </BrowserFocusProvider>\n        )}\n      </EditorModeConsumer>\n    </EditorModeProvider>\n  )\n}\n\nconst Wrapper = styled.div`\n  display: block;\n  min-height: 100px;\n`\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport styled from 'styled-components'\nimport { FC } from 'react'\nimport { InputCss, wrapFieldsWithMeta } from '@tinacms/fields'\n\nconst lightMediumGrey = `rgb(200, 200, 200)`\nconst darkGrey = 'rgb(40, 40, 40)'\n\nexport function wysiwygStyles(component: FC<any>) {\n  return wrapFieldsWithMeta(styled(component)`\n    position: relative;\n\n    > [contenteditable] {\n      ${InputCss}\n      overflow: auto;\n      -webkit-overflow-scrolling: touch;\n      min-height: 200px;\n      max-height: 500px;\n      overflow-y: auto;\n      display: block;\n\n      ::selection {\n        background-color: rgba(0, 132, 255, 0.3);\n      }\n\n      div::selection {\n        background: rgba(0, 0, 0, 0);\n      }\n\n      div[contenteditable] {\n        display: inline-block;\n      }\n\n      > *:first-child {\n        margin-top: 0;\n      }\n\n      > *:last-child {\n        margin-bottom: 0;\n      }\n    }\n\n    color: ${darkGrey};\n    background-color: #fff;\n    font-size: 16px;\n    line-height: 26px;\n    white-space: pre-wrap;\n    -webkit-font-smoothing: antialiased;\n    text-shadow: none;\n    font-weight: 400;\n    cursor: auto;\n    overflow-wrap: break-word;\n    word-wrap: break-word;\n    border-radius: var(--tina-radius-small);\n\n    p {\n      font-size: 16px;\n      line-height: 26px;\n      font-weight: normal;\n    }\n\n    h1,\n    h2,\n    h3,\n    h4,\n    h5,\n    h6 {\n      font-weight: 600;\n      text-transform: none;\n      padding: 0;\n      margin-bottom: 16px;\n    }\n\n    h1 {\n      font-size: 40px;\n      line-height: 48px;\n      margin-top: 0;\n      &:not(:first-child) {\n        margin-top: 32px;\n      }\n    }\n\n    h2,\n    h3,\n    h4,\n    h5,\n    h6 {\n      &:not(:first-child) {\n        margin-top: 21px;\n      }\n    }\n\n    h2 {\n      font-size: 34px;\n      line-height: 38px;\n      margin-top: 0;\n    }\n\n    h3 {\n      font-size: 26px;\n      line-height: 30px;\n      margin-top: 0;\n    }\n\n    h4 {\n      font-size: 21px;\n      line-height: 28px;\n      margin-top: 0;\n    }\n\n    h5 {\n      font-size: 18px;\n      line-height: 24px;\n      margin-top: 0;\n    }\n\n    h6 {\n      font-size: 16px;\n      line-height: 20px;\n      margin-top: 0;\n    }\n\n    a {\n      color: #0084ff;\n      border: 0;\n      font-weight: normal;\n      text-decoration: underline;\n    }\n\n    small {\n      font-size: 0.707em;\n    }\n\n    ul,\n    ol {\n      margin: 0;\n      padding: 0;\n    }\n\n    ol li {\n      /* prevent 2-digits numbers from being cut-off */\n      margin-left: 5px;\n      margin-right: 5px;\n    }\n\n    ul {\n      margin-left: 1.5em;\n      margin-bottom: 16px;\n      list-style-type: disc;\n      list-style-position: outside;\n      list-style-image: none;\n    }\n\n    ol {\n      margin-left: 1.25em;\n      margin-bottom: 16px;\n      list-style-type: decimal;\n    }\n\n    li {\n      list-style: inherit;\n      ol,\n      ul {\n        margin-bottom: 0;\n      }\n    }\n\n    code {\n      font-family: 'Roboto Mono', monospace;\n      font-size: 14px;\n      background: rgba(53, 50, 50, 0.08);\n      padding: 0.1em 0.25em;\n    }\n\n    pre {\n      padding: 0;\n      margin: 0;\n    }\n\n    pre > code {\n      display: block;\n      padding: 0.15em 0.6em;\n    }\n\n    img {\n      max-width: 100%;\n      border: 0;\n      padding: 0;\n      margin-bottom: 16px;\n    }\n\n    hr {\n      display: block;\n      height: 1px;\n      width: 100%;\n      border: 0;\n      background: ${lightMediumGrey};\n      margin: 16px 0;\n    }\n\n    blockquote {\n      margin: 0 0 16px 0;\n      border-left: 2px solid ${lightMediumGrey};\n      padding-left: 15px;\n    }\n\n    mark {\n      color: ${darkGrey};\n      background-color: #ffe9a8;\n      padding: 0.1em 0.25em;\n    }\n\n    h1,\n    h2,\n    h3,\n    h4,\n    h5,\n    h6 {\n      position: relative;\n      &:before {\n        font-size: 14px;\n        text-align: left;\n        font-weight: var(--tina-font-weight-regular);\n        color: ${lightMediumGrey};\n        position: absolute;\n        left: -35px;\n        width: 30px;\n        cursor: pointer;\n        transition: color 0.25s ease;\n      }\n      &:hover:before {\n        color: ${darkGrey};\n      }\n    }\n\n    blockquote {\n      h1,\n      h2,\n      h3,\n      h4,\n      h5,\n      h6 {\n        &:before {\n          display: none;\n        }\n      }\n    }\n  `)\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { Wysiwyg } from '../components/Wysiwyg'\nimport { wysiwygStyles } from './wysiwygStyles'\n\nconst HTMLField = wysiwygStyles(props => {\n  return <Wysiwyg {...props} sticky={false} format=\"html\" />\n})\n\nexport const HtmlFieldPlugin = {\n  __type: 'field',\n  name: 'html',\n  Component: HTMLField,\n  parse: (value: string) => value || '',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport React from 'react'\nimport { Wysiwyg } from '../components/Wysiwyg'\nimport { wysiwygStyles } from './wysiwygStyles'\n\nconst MarkdownField = wysiwygStyles(props => {\n  return <Wysiwyg {...props} sticky={false} format=\"markdown\" />\n})\n\nexport const MarkdownFieldPlugin = {\n  __type: 'field',\n  name: 'markdown',\n  Component: MarkdownField,\n  parse: (value: string) => value || '',\n}\n","/**\n\nCopyright 2019 Forestry.io Inc\n\nLicensed under the Apache License, Version 2.0 (the \"License\");\nyou may not use this file except in compliance with the License.\nYou may obtain a copy of the License at\n\n    http://www.apache.org/licenses/LICENSE-2.0\n\nUnless required by applicable law or agreed to in writing, software\ndistributed under the License is distributed on an \"AS IS\" BASIS,\nWITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.\nSee the License for the specific language governing permissions and\nlimitations under the License.\n\n*/\n\nimport * as React from 'react'\nimport { useCMS } from 'tinacms'\nimport { InlineField, FocusRing } from 'react-tinacms-inline'\nimport { FocusRingOptions } from 'react-tinacms-inline/src/styles'\nimport { Wysiwyg } from '../components/Wysiwyg'\nimport { EditorProps, ImageProps } from '../types'\n\nexport interface InlineWysiwygFieldProps extends Omit<EditorProps, 'input'> {\n  name: string\n  children: any\n  focusRing?: boolean | FocusRingOptions\n}\n\nexport function InlineWysiwyg({\n  name,\n  children,\n  focusRing = true,\n  imageProps: passedInImageProps,\n  ...wysiwygProps\n}: InlineWysiwygFieldProps) {\n  const cms = useCMS()\n\n  const imageProps: ImageProps | undefined = React.useMemo(() => {\n    if (!passedInImageProps) return\n    return {\n      async upload(files: File[]) {\n        const filesToUpload = files.map(file => ({\n          directory: passedInImageProps?.directory || '',\n          file,\n        }))\n\n        const allMedia = await cms.media.store.persist(filesToUpload)\n\n        return allMedia.map(media => {\n          if (passedInImageProps.parse) {\n            return passedInImageProps.parse(media.filename)\n          } else {\n            return media.filename\n          }\n        })\n      },\n      previewSrc(src) {\n        return cms.media.store.previewSrc(src)\n      },\n      ...passedInImageProps,\n    }\n  }, [\n    cms.media.store,\n    passedInImageProps?.directory,\n    passedInImageProps?.previewSrc,\n    passedInImageProps?.upload,\n  ])\n\n  if (cms.disabled) {\n    return children\n  }\n\n  return (\n    <InlineField name={name}>\n      {({ input }: any) => {\n        return (\n          <FocusRing name={name} options={focusRing}>\n            <Wysiwyg input={input} {...wysiwygProps} imageProps={imageProps} />\n          </FocusRing>\n        )\n      }}\n    </InlineField>\n  )\n}\n"],"sourceRoot":""}